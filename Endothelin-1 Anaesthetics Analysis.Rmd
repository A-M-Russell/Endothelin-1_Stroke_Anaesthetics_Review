---
title: "Endothelin-1 Anaesthetics Analysis"
author: "Ash A. M. Russell"
date: "2023-03-30"
output: html_document
editor_options: 
  chunk_output_type: inline
---

Code for meta-analysis investigating how anaesthetic choice and other methodologies affect infarct volume in the endothelin-1 vasoconstrictive models of stroke.
Requires a .csv excel file, Russell_Endothelin_4.csv
Can also use the pre-run workspace file to save time running the code: ET1_anaesthetics_workspace.RData
Markdown file started on 30/03/2023, last updated 3/09/2023

Code chunks with plot outputs are set to eval=FALSE so they won't produce plots unless you run them deliberately.
Most chunks are set to include=FALSE so the code will run but the outputs won't print in a knitted file to reduce the output file length. Remove this for any sections you wish to output into a knitted file.

```{r setup, include=FALSE, warning=FALSE}
#check if packages are installed, if not, install them
if(!require(tidyverse)) install.packages("tidyverse")
if(!require(sjPlot)) install.packages("sjPlot")
if(!require(viridis)) install.packages("viridis")
if(!require(corrplot)) install.packages("corrplot")
if (!require("remotes")) install.packages("remotes")
remotes::install_github('sinhrks/ggfortify') 
if(!require(PupillometryR)) install.packages("PupillometryR")
if(!require(MASS)) install.packages("MASS")
if(!require(car)) install.packages("car")
if(!require(emmeans)) install.packages("emmeans")

library(tidyverse) # includes, ggplot2, dplyr, tidyr, readr, purrr, tibble, stringr, forcats
library(sjPlot) # for easy to read tables + model outputs
library(viridis) # colours for plots
library(corrplot) #for correlation plot
library(ggfortify) #boxcox
library(PupillometryR) #for flat violin plots
library(MASS) # for boxcox transformation + generating example distributions
library(car) # for type 3 Anova function
library(emmeans) # for post hocs

```

# Importing + initial dataset cleaning

```{r data_import, include=FALSE}
#importing main dataset
dfc4_Raw <- read.csv("Russell_Endothelin_4.csv")
#when importing this csv, remember to delete blank studies at end and irrelevant admin variables on right
dfc4 <- dfc4_Raw #copy the raw data frame to make changes to variables, keeping dfc4_Raw as a control to fix mistakes

```

```{r variable_clean, include=FALSE, warning=FALSE}
#cleaning the database and fixing variable classification

#change all relevant "character" variables to "factor" variables
#animal variables
dfc4$Publication_code <- factor(dfc4$Publication_code)
dfc4$Animal <- factor(dfc4$Animal)
dfc4$Strain <- factor(dfc4$Strain)
dfc4$Sex <- factor(dfc4$Sex)
dfc4$Comorbidity <- factor(dfc4$Comorbidity)
dfc4$Comorbidity_induction <- factor(dfc4$Comorbidity_induction)
#stroke model variables
dfc4$Surgery_primary_anaesthetic <- factor(dfc4$Surgery_primary_anaesthetic)
dfc4$Surgery_secondary_anaesthetic <- factor(dfc4$Surgery_secondary_anaesthetic)
dfc4$Surgery_tertiary_anaesthetic <- factor(dfc4$Surgery_tertiary_anaesthetic)
dfc4$Induction_primary_anaesthetic <- factor(dfc4$Induction_primary_anaesthetic)
dfc4$Induction_secondary_anaesthetic <- factor(dfc4$Induction_secondary_anaesthetic)
dfc4$Induction_tertiary_anaesthetic <- factor(dfc4$Induction_tertiary_anaesthetic)
dfc4$ET_administration_route  <- factor(dfc4$ET_administration_route )
dfc4$ET_brain_depth <- factor(dfc4$ET_brain_depth)
dfc4$MCA_occluded <- factor(dfc4$MCA_occluded)
dfc4$Conscious <- factor(dfc4$Conscious)
dfc4$Primary_analgesic <- factor(dfc4$Primary_analgesic)
dfc4$Secondary_analgesic <- factor(dfc4$Secondary_analgesic)
dfc4$Antibiotic <- factor(dfc4$Antibiotic)
#treatment variables
dfc4$Treatment <- factor(dfc4$Treatment)
dfc4$Treatment_class <- factor(dfc4$Treatment_class)
dfc4$Treatment_time_class <- factor(dfc4$Treatment_time_class)
#infarct outcome variables
dfc4$Infarct_measurement <- factor(dfc4$Infarct_measurement)
dfc4$Histology_stain <- factor(dfc4$Histology_stain)
dfc4$Reported_p_value <- factor(dfc4$Reported_p_value)

#change all relevant "character" variables to "numeric"
#age variables
dfc4$Age_weeks_min <- as.numeric(dfc4$Age_weeks_min)
dfc4$Age_weeks_mean <- as.numeric(dfc4$Age_weeks_mean)
dfc4$Age_weeks_max <- as.numeric(dfc4$Age_weeks_max)
#weight variables
dfc4$Weight_g_min <- as.numeric(dfc4$Weight_g_min)
dfc4$Weight_g_mean <- as.numeric(dfc4$Weight_g_mean)
dfc4$Weight_g_max<- as.numeric(dfc4$Weight_g_max)
#animal groups and n variables
dfc4$N_animals_control <- as.numeric(dfc4$N_animals_control)
dfc4$N_animals_treatment <- as.numeric(dfc4$N_animals_treatment)
#stroke model variables
dfc4$Induction_time_hrs <- as.numeric(dfc4$Induction_time_hrs)
dfc4$ET_administration_mins <- as.numeric(dfc4$ET_administration_mins)
dfc4$ET_administration_sites <- as.numeric(dfc4$ET_administration_sites)
#treatment variables
dfc4$Treatment_initial_hour <- as.numeric(dfc4$Treatment_initial_hour)
#infarct outcome variables
dfc4$Infarct_measure_hrs <- as.numeric(dfc4$Infarct_measure_hrs)

```

```{r Variable_creation, include=FALSE}
#creating anaesthetic variable with multiple anaesthetics combined
dfc4$Surgery_anaesthetic <- 
  paste(dfc4$Surgery_primary_anaesthetic, 
        coalesce(dfc4$Surgery_secondary_anaesthetic, ""),
        coalesce(dfc4$Surgery_tertiary_anaesthetic, ""))
dfc4$Surgery_anaesthetic <- dfc4$Surgery_anaesthetic %>%
  str_trim() %>% #trims whitespace from start and end of string
  factor() #make a factor
levels(dfc4$Surgery_anaesthetic)[levels(dfc4$Surgery_anaesthetic)=="NR"] <- "Not reported"

summary(dfc4$Surgery_anaesthetic)

dfc4$Induction_anaesthetic <- 
  paste(dfc4$Induction_primary_anaesthetic, 
        coalesce(dfc4$Induction_secondary_anaesthetic, ""),
        coalesce(dfc4$Induction_tertiary_anaesthetic, ""))
dfc4$Induction_anaesthetic <- dfc4$Induction_anaesthetic %>%
  str_trim() %>% #trims whitespace from start and end of string
  factor() #make a factor
levels(dfc4$Induction_anaesthetic)[levels(dfc4$Induction_anaesthetic)=="NR"] <- "Not reported"

summary(dfc4$Induction_anaesthetic)

```

```{r Variable_creation_surgery_dummy_anaesthetic, include=FALSE}
#Making dummy variables for most common anaesthetics to use later
#One set for surgery, one for induction

#used dfc4_Reduced to decide these cutoffs, but have moved this section earlier in the code so the dummies are created at a higher level and are present across all dataframes
#Surgery anaesthetics with their own dummy variable (4 or greater): Diazepam, Halothane, Isoflurane, Ketamine, Nitrous oxide, Not Reported (NR), Sodium Pentobarbital, Tribromoethanol, Xylazine


dfc4$Surgery_Isoflurane<-rep(0, nrow(dfc4)) #make a column called "Surgery_Isoflurane" and populate it with zeros
dfc4$Surgery_Isoflurane<-(dfc4$Surgery_primary_anaesthetic=="Isoflurane"|
                            dfc4$Surgery_secondary_anaesthetic=="Isoflurane"|
                            dfc4$Surgery_tertiary_anaesthetic=="Isoflurane")*1 #if primary/secondary/tertiary anaesthetic is isoflurane, multiply it by 1
dfc4$Surgery_Isoflurane[is.na(dfc4$Surgery_Isoflurane)]<-0 #because the previous step produces a bunch of NAs, convert NAs back to 0

#repeat for other anaesthetics
dfc4$Surgery_Diazepam<-rep(0, nrow(dfc4))
dfc4$Surgery_Diazepam<-(dfc4$Surgery_primary_anaesthetic=="Diazepam"|
                            dfc4$Surgery_secondary_anaesthetic=="Diazepam"|
                            dfc4$Surgery_tertiary_anaesthetic=="Diazepam")*1
dfc4$Surgery_Diazepam[is.na(dfc4$Surgery_Diazepam)]<-0

dfc4$Surgery_Halothane<-rep(0, nrow(dfc4))
dfc4$Surgery_Halothane<-(dfc4$Surgery_primary_anaesthetic=="Halothane"|
                            dfc4$Surgery_secondary_anaesthetic=="Halothane"|
                            dfc4$Surgery_tertiary_anaesthetic=="Halothane")*1
dfc4$Surgery_Halothane[is.na(dfc4$Surgery_Halothane)]<-0

dfc4$Surgery_Ketamine<-rep(0, nrow(dfc4))
dfc4$Surgery_Ketamine<-(dfc4$Surgery_primary_anaesthetic=="Ketamine"|
                            dfc4$Surgery_secondary_anaesthetic=="Ketamine"|
                            dfc4$Surgery_tertiary_anaesthetic=="Ketamine")*1
dfc4$Surgery_Ketamine[is.na(dfc4$Surgery_Ketamine)]<-0

dfc4$Surgery_Nitrous_oxide<-rep(0, nrow(dfc4))
dfc4$Surgery_Nitrous_oxide<-(dfc4$Surgery_primary_anaesthetic=="Nitrous oxide"|
                            dfc4$Surgery_secondary_anaesthetic=="Nitrous oxide"|
                            dfc4$Surgery_tertiary_anaesthetic=="Nitrous oxide")*1
dfc4$Surgery_Nitrous_oxide[is.na(dfc4$Surgery_Nitrous_oxide)]<-0

dfc4$Surgery_A_Not_reported<-rep(0, nrow(dfc4))
dfc4$Surgery_A_Not_reported<-(dfc4$Surgery_primary_anaesthetic=="NR"|
                            dfc4$Surgery_secondary_anaesthetic=="NR"|
                            dfc4$Surgery_tertiary_anaesthetic=="NR")*1
dfc4$Surgery_A_Not_reported[is.na(dfc4$Surgery_A_Not_reported)]<-0

dfc4$Surgery_Sodium_Pentobarbital<-rep(0, nrow(dfc4))
dfc4$Surgery_Sodium_Pentobarbital<-(dfc4$Surgery_primary_anaesthetic=="Sodium Pentobarbital"|
                            dfc4$Surgery_secondary_anaesthetic=="Sodium Pentobarbital"|
                            dfc4$Surgery_tertiary_anaesthetic=="Sodium Pentobarbital")*1
dfc4$Surgery_Sodium_Pentobarbital[is.na(dfc4$Surgery_Sodium_Pentobarbital)]<-0

# Came back after creating cleaned model as tribromoethanol now has too few instances to be its own variable (down to 2). Rolling it into "other" anaesthetics
# dfc4$Surgery_Tribromoethanol<-rep(0, nrow(dfc4))
# dfc4$Surgery_Tribromoethanol<-(dfc4$Surgery_primary_anaesthetic=="Tribromoethanol"|
#                             dfc4$Surgery_secondary_anaesthetic=="Tribromoethanol"|
#                             dfc4$Surgery_tertiary_anaesthetic=="Tribromoethanol")*1
# dfc4$Surgery_Tribromoethanol[is.na(dfc4$Surgery_Tribromoethanol)]<-0

dfc4$Surgery_Xylazine<-rep(0, nrow(dfc4))
dfc4$Surgery_Xylazine<-(dfc4$Surgery_primary_anaesthetic=="Xylazine"|
                            dfc4$Surgery_secondary_anaesthetic=="Xylazine"|
                            dfc4$Surgery_tertiary_anaesthetic=="Xylazine")*1
dfc4$Surgery_Xylazine[is.na(dfc4$Surgery_Xylazine)]<-0

#Create a dummy variable for other anaesthetics
#Surgery anaesthetics to group under "other" (fewer than 4 experiments): Atropine, Chloral hydrate, Dexmedetomidine, Fentanyl/fluanisone, Methohexital, Midazolam, Tiletamine-Zolazepam, Urethane


dfc4$Surgery_other_anaesthetics<-rep(0, nrow(dfc4)) #make a column called "Other_anaesthetics" and populate it with zeros
dfc4$Surgery_other_anaesthetics<-(dfc4$Surgery_primary_anaesthetic=="Atropine"|
                            dfc4$Surgery_secondary_anaesthetic=="Atropine"|
                            dfc4$Surgery_tertiary_anaesthetic=="Atropine"|
                            dfc4$Surgery_primary_anaesthetic=="Chloral hydrate"|
                            dfc4$Surgery_secondary_anaesthetic=="Chloral hydrate"|
                            dfc4$Surgery_tertiary_anaesthetic=="Chloral hydrate"|
                            dfc4$Surgery_primary_anaesthetic=="Dexmedetomidine"|
                            dfc4$Surgery_secondary_anaesthetic=="Dexmedetomidine"|
                            dfc4$Surgery_tertiary_anaesthetic=="Dexmedetomidine"|
                            dfc4$Surgery_primary_anaesthetic=="Fentanyl/fluanisone"|
                            dfc4$Surgery_secondary_anaesthetic=="Fentanyl/fluanisone"|
                            dfc4$Surgery_tertiary_anaesthetic=="Fentanyl/fluanisone"|
                            dfc4$Surgery_primary_anaesthetic=="Methohexital"|
                            dfc4$Surgery_secondary_anaesthetic=="Methohexital"|
                            dfc4$Surgery_tertiary_anaesthetic=="Methohexital"|
                            dfc4$Surgery_primary_anaesthetic=="Midazolam"|
                            dfc4$Surgery_secondary_anaesthetic=="Midazolam"|
                            dfc4$Surgery_tertiary_anaesthetic=="Midazolam"|
                            dfc4$Surgery_primary_anaesthetic=="Tiletamine-Zolazepam"|
                            dfc4$Surgery_secondary_anaesthetic=="Tiletamine-Zolazepam"|
                            dfc4$Surgery_tertiary_anaesthetic=="Tiletamine-Zolazepam"|
                            dfc4$Surgery_primary_anaesthetic=="Urethane"|
                            dfc4$Surgery_secondary_anaesthetic=="Urethane"|
                            dfc4$Surgery_tertiary_anaesthetic=="Urethane" |
                            dfc4$Surgery_primary_anaesthetic=="Tribromoethanol"| #Came back after created cleaned model as Trbromo now too small to include in dataset. Including it in "other" anaesthetics rather than deleting papers
                            dfc4$Surgery_secondary_anaesthetic=="Tribromoethanol"|
                            dfc4$Surgery_tertiary_anaesthetic=="Tribromoethanol")*1
dfc4$Surgery_other_anaesthetics[is.na(dfc4$Surgery_other_anaesthetics)]<-0 #because the previous step produces a bunch of NAs, convert NAs back to 0

```

```{r Variable_creation_induction_dummy_anaesthetic, include=FALSE}
#Making dummy variables for most common anaesthetics to use later
#One set for surgery, one for induction

#Induction anaesthetics with their own dummy variable (4 or greater): Halothane, Isoflurane, Ketamine, Nitrous oxide, None, Not Reported (NR), Sevoflurane, Sodium Pentobarbital, Tribromoethanol, Xylazine


dfc4$Induction_Isoflurane<-rep(0, nrow(dfc4)) #make a column called "Induction_Isoflurane" and populate it with zeros
dfc4$Induction_Isoflurane<-(dfc4$Induction_primary_anaesthetic=="Isoflurane"|
                            dfc4$Induction_secondary_anaesthetic=="Isoflurane"|
                            dfc4$Induction_tertiary_anaesthetic=="Isoflurane")*1 #if primary/secondary/tertiary anaesthetic is isoflurane, multiply it by 1
dfc4$Induction_Isoflurane[is.na(dfc4$Induction_Isoflurane)]<-0 #because the previous step produces a bunch of NAs, convert NAs back to 0

#repeat for other anaesthetics
dfc4$Induction_Halothane<-rep(0, nrow(dfc4))
dfc4$Induction_Halothane<-(dfc4$Induction_primary_anaesthetic=="Halothane"|
                            dfc4$Induction_secondary_anaesthetic=="Halothane"|
                            dfc4$Induction_tertiary_anaesthetic=="Halothane")*1
dfc4$Induction_Halothane[is.na(dfc4$Induction_Halothane)]<-0

dfc4$Induction_Ketamine<-rep(0, nrow(dfc4))
dfc4$Induction_Ketamine<-(dfc4$Induction_primary_anaesthetic=="Ketamine"|
                            dfc4$Induction_secondary_anaesthetic=="Ketamine"|
                            dfc4$Induction_tertiary_anaesthetic=="Ketamine")*1
dfc4$Induction_Ketamine[is.na(dfc4$Induction_Ketamine)]<-0

dfc4$Induction_Nitrous_oxide<-rep(0, nrow(dfc4))
dfc4$Induction_Nitrous_oxide<-(dfc4$Induction_primary_anaesthetic=="Nitrous oxide"|
                            dfc4$Induction_secondary_anaesthetic=="Nitrous oxide"|
                            dfc4$Induction_tertiary_anaesthetic=="Nitrous oxide")*1
dfc4$Induction_Nitrous_oxide[is.na(dfc4$Induction_Nitrous_oxide)]<-0

dfc4$Induction_No_anaesthetic<-rep(0, nrow(dfc4))
dfc4$Induction_No_anaesthetic<-(dfc4$Induction_primary_anaesthetic=="None"|
                            dfc4$Induction_secondary_anaesthetic=="None"|
                            dfc4$Induction_tertiary_anaesthetic=="None")*1
dfc4$Induction_No_anaesthetic[is.na(dfc4$Induction_No_anaesthetic)]<-0

dfc4$Induction_A_Not_reported<-rep(0, nrow(dfc4))
dfc4$Induction_A_Not_reported<-(dfc4$Induction_primary_anaesthetic=="NR"|
                            dfc4$Induction_secondary_anaesthetic=="NR"|
                            dfc4$Induction_tertiary_anaesthetic=="NR")*1
dfc4$Induction_A_Not_reported[is.na(dfc4$Induction_A_Not_reported)]<-0

dfc4$Induction_Sevoflurane<-rep(0, nrow(dfc4))
dfc4$Induction_Sevoflurane<-(dfc4$Induction_primary_anaesthetic=="Sevoflurane"|
                            dfc4$Induction_secondary_anaesthetic=="Sevoflurane"|
                            dfc4$Induction_tertiary_anaesthetic=="Sevoflurane")*1
dfc4$Induction_Sevoflurane[is.na(dfc4$Induction_Sevoflurane)]<-0


dfc4$Induction_Sodium_Pentobarbital<-rep(0, nrow(dfc4))
dfc4$Induction_Sodium_Pentobarbital<-(dfc4$Induction_primary_anaesthetic=="Sodium Pentobarbital"|
                            dfc4$Induction_secondary_anaesthetic=="Sodium Pentobarbital"|
                            dfc4$Induction_tertiary_anaesthetic=="Sodium Pentobarbital")*1
dfc4$Induction_Sodium_Pentobarbital[is.na(dfc4$Induction_Sodium_Pentobarbital)]<-0

# Came back after creating cleaned model as tribromoethanol now has too few instances to be its own variable (down to 2). Rolling it into "other" anaesthetics
# dfc4$Induction_Tribromoethanol<-rep(0, nrow(dfc4))
# dfc4$Induction_Tribromoethanol<-(dfc4$Induction_primary_anaesthetic=="Tribromoethanol"|
#                             dfc4$Induction_secondary_anaesthetic=="Tribromoethanol"|
#                             dfc4$Induction_tertiary_anaesthetic=="Tribromoethanol")*1
# dfc4$Induction_Tribromoethanol[is.na(dfc4$Induction_Tribromoethanol)]<-0

dfc4$Induction_Xylazine<-rep(0, nrow(dfc4))
dfc4$Induction_Xylazine<-(dfc4$Induction_primary_anaesthetic=="Xylazine"|
                            dfc4$Induction_secondary_anaesthetic=="Xylazine"|
                            dfc4$Induction_tertiary_anaesthetic=="Xylazine")*1
dfc4$Induction_Xylazine[is.na(dfc4$Induction_Xylazine)]<-0

#Create a dummy variable for other anaesthetics
#Induction anaesthetics to group under "other" (fewer than 4 experiments): Atropine, Chloral hydrate, Dexmedetomidine, Diazepam, Fentanyl/fluanisone, Midazolam, Propofol, Tiletamine-Zolazepam, Urethane


dfc4$Induction_other_anaesthetics<-rep(0, nrow(dfc4)) #make a column called "Other_anaesthetics" and populate it with zeros
dfc4$Induction_other_anaesthetics<-(dfc4$Induction_primary_anaesthetic=="Atropine"|
                            dfc4$Induction_secondary_anaesthetic=="Atropine"|
                            dfc4$Induction_tertiary_anaesthetic=="Atropine"|
                            dfc4$Induction_primary_anaesthetic=="Chloral hydrate"|
                            dfc4$Induction_secondary_anaesthetic=="Chloral hydrate"|
                            dfc4$Induction_tertiary_anaesthetic=="Chloral hydrate"|
                            dfc4$Induction_primary_anaesthetic=="Dexmedetomidine"|
                            dfc4$Induction_secondary_anaesthetic=="Dexmedetomidine"|
                            dfc4$Induction_tertiary_anaesthetic=="Dexmedetomidine"|
                            dfc4$Induction_primary_anaesthetic=="Diazepam"|
                            dfc4$Induction_secondary_anaesthetic=="Diazepam"|
                            dfc4$Induction_tertiary_anaesthetic=="Diazepam"|
                            dfc4$Induction_primary_anaesthetic=="Fentanyl/fluanisone"|
                            dfc4$Induction_secondary_anaesthetic=="Fentanyl/fluanisone"|
                            dfc4$Induction_tertiary_anaesthetic=="Fentanyl/fluanisone"|
                            dfc4$Induction_primary_anaesthetic=="Midazolam"|
                            dfc4$Induction_secondary_anaesthetic=="Midazolam"|
                            dfc4$Induction_tertiary_anaesthetic=="Midazolam"|
                            dfc4$Induction_primary_anaesthetic=="Propofol"|
                            dfc4$Induction_secondary_anaesthetic=="Propofol"|
                            dfc4$Induction_tertiary_anaesthetic=="Propofol"|
                            dfc4$Induction_primary_anaesthetic=="Tiletamine-Zolazepam"|
                            dfc4$Induction_secondary_anaesthetic=="Tiletamine-Zolazepam"|
                            dfc4$Induction_tertiary_anaesthetic=="Tiletamine-Zolazepam"|
                            dfc4$Induction_primary_anaesthetic=="Urethane"|
                            dfc4$Induction_secondary_anaesthetic=="Urethane"|
                            dfc4$Induction_tertiary_anaesthetic=="Urethane" |
                            dfc4$Induction_primary_anaesthetic=="Tribromoethanol"| #Came back after created cleaned model as Trbromo now too small to include in dataset. Including it in "other" anaesthetics rather than deleting papers
                            dfc4$Induction_secondary_anaesthetic=="Tribromoethanol"|
                            dfc4$Induction_tertiary_anaesthetic=="Tribromoethanol")*1
dfc4$Induction_other_anaesthetics[is.na(dfc4$Induction_other_anaesthetics)]<-0 #because the previous step produces a bunch of NAs, convert NAs back to 0

```

```{r Variable_creation_dummy_analgesics, include=FALSE}
#Making dummy variables for analgesics

summary(dfc4$Primary_analgesic)
summary(dfc4$Secondary_analgesic)
# Analgesics to make dummy variables:
# Bupivacaine
# Buprenorphine
# Butorphanol
# Carprofen
# Dexamethasone
# Ketoprofen
# Lidocaine
# Not reported (NR)
# Paracetamol/Acetaminophen
# Procaine
# Tramadol

dfc4$Analgesic_Bupivacaine<-rep(0, nrow(dfc4)) #make a column called "Analgesic_Bupivacaine" and populate it with zeros
dfc4$Analgesic_Bupivacaine<-(dfc4$Primary_analgesic=="Bupivacaine"|
                            dfc4$Secondary_analgesic=="Bupivacaine")*1 #if primary/secondary/tertiary analgesic is Bupivacaine, multiply it by 1
dfc4$Analgesic_Bupivacaine[is.na(dfc4$Analgesic_Bupivacaine)]<-0 #because the previous step produces a bunch of NAs, convert NAs back to 0

#repeat for other analgesics
dfc4$Analgesic_Buprenorphine<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Buprenorphine<-(dfc4$Primary_analgesic=="Buprenorphine"|
                            dfc4$Secondary_analgesic=="Buprenorphine")*1 
dfc4$Analgesic_Buprenorphine[is.na(dfc4$Analgesic_Buprenorphine)]<-0 

dfc4$Analgesic_Butorphanol<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Butorphanol<-(dfc4$Primary_analgesic=="Butorphanol"|
                            dfc4$Secondary_analgesic=="Butorphanol")*1 
dfc4$Analgesic_Butorphanol[is.na(dfc4$Analgesic_Butorphanol)]<-0 

dfc4$Analgesic_Carprofen<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Carprofen<-(dfc4$Primary_analgesic=="Carprofen"|
                            dfc4$Secondary_analgesic=="Carprofen")*1 
dfc4$Analgesic_Carprofen[is.na(dfc4$Analgesic_Carprofen)]<-0 

dfc4$Analgesic_Dexamethasone<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Dexamethasone<-(dfc4$Primary_analgesic=="Dexamethasone"|
                            dfc4$Secondary_analgesic=="Dexamethasone")*1 
dfc4$Analgesic_Dexamethasone[is.na(dfc4$Analgesic_Dexamethasone)]<-0 

dfc4$Analgesic_Ketoprofen<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Ketoprofen<-(dfc4$Primary_analgesic=="Ketoprofen"|
                            dfc4$Secondary_analgesic=="Ketoprofen")*1 
dfc4$Analgesic_Ketoprofen[is.na(dfc4$Analgesic_Ketoprofen)]<-0 

dfc4$Analgesic_Lidocaine<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Lidocaine<-(dfc4$Primary_analgesic=="Lidocaine"|
                            dfc4$Secondary_analgesic=="Lidocaine")*1 
dfc4$Analgesic_Lidocaine[is.na(dfc4$Analgesic_Lidocaine)]<-0 

dfc4$Analgesic_Not_reported<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Not_reported<-(dfc4$Primary_analgesic=="NR")*1 
dfc4$Analgesic_Not_reported[is.na(dfc4$Analgesic_Not_reported)]<-0 

dfc4$Analgesic_Paracetamol_Acetaminophen<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Paracetamol_Acetaminophen<-(dfc4$Primary_analgesic=="Paracetamol/Acetaminophen"|
                            dfc4$Secondary_analgesic=="Paracetamol/Acetaminophen")*1 
dfc4$Analgesic_Paracetamol_Acetaminophen[is.na(dfc4$Analgesic_Paracetamol_Acetaminophen)]<-0 

dfc4$Analgesic_Procaine<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Procaine<-(dfc4$Primary_analgesic=="Procaine"|
                            dfc4$Secondary_analgesic=="Procaine")*1 
dfc4$Analgesic_Procaine[is.na(dfc4$Analgesic_Procaine)]<-0 

dfc4$Analgesic_Tramadol<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_Tramadol<-(dfc4$Primary_analgesic=="Tramadol"|
                            dfc4$Secondary_analgesic=="Tramadol")*1 
dfc4$Analgesic_Tramadol[is.na(dfc4$Analgesic_Tramadol)]<-0 


# Create dummy variables for the groups of analgesics
# Check digital lab book for notes on classification of these. Grouping them into "broad class"

dfc4$Analgesic_class_Local_anaesthetic<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_class_Local_anaesthetic<-(dfc4$Analgesic_Bupivacaine==1|
                            dfc4$Analgesic_Lidocaine==1|
                            dfc4$Analgesic_Procaine==1)*1 
dfc4$Analgesic_class_Local_anaesthetic[is.na(dfc4$Analgesic_class_Local_anaesthetic)]<-0 

dfc4$Analgesic_class_Opioid<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_class_Opioid<-(dfc4$Analgesic_Buprenorphine==1|
                            dfc4$Analgesic_Butorphanol==1|
                            dfc4$Analgesic_Tramadol==1)*1 
dfc4$Analgesic_class_Opioid[is.na(dfc4$Analgesic_class_Opioid)]<-0 

dfc4$Analgesic_class_Anti_inflammatory<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_class_Anti_inflammatory<-(dfc4$Analgesic_Carprofen==1|
                            dfc4$Analgesic_Dexamethasone==1|
                            dfc4$Analgesic_Ketoprofen==1)*1 
dfc4$Analgesic_class_Anti_inflammatory[is.na(dfc4$Analgesic_class_Anti_inflammatory)]<-0 

dfc4$Analgesic_class_Analgesic_antipyretic<-rep(0, nrow(dfc4)) 
dfc4$Analgesic_class_Analgesic_antipyretic<-(dfc4$Analgesic_Paracetamol_Acetaminophen==1)*1 
dfc4$Analgesic_class_Analgesic_antipyretic[is.na(dfc4$Analgesic_class_Analgesic_antipyretic)]<-0 



```

```{r Variable_creation_analgesic_class, include=FALSE}
#creating analgesic variable with multiple analgesics combined
dfc4$Analgesic_class <- 
  paste(dfc4$Primary_analgesic, 
        coalesce(dfc4$Secondary_analgesic, ""))
dfc4$Analgesic_class <- dfc4$Analgesic_class %>%
  str_trim() %>% #trims whitespace from start and end of string
  factor() #make a factor

# summary(dfc4$Analgesic_class)

levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="NR"] <- "Not reported"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Bupivacaine"] <- "Local anaesthetic"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Lidocaine"] <- "Local anaesthetic"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Procaine"] <- "Local anaesthetic"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Buprenorphine"] <- "Opioid"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Butorphanol"] <- "Opioid"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Tramadol"] <- "Opioid"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Carprofen"] <- "Anti-inflammatory"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Dexamethasone"] <- "Anti-inflammatory"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Ketoprofen"] <- "Anti-inflammatory"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Paracetamol/Acetaminophen"] <- "Analgesic/antipyretic"
#combined ones
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Bupivacaine Buprenorphine"] <- "Multiple analgesics"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Buprenorphine Bupivacaine"] <- "Multiple analgesics"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Buprenorphine Paracetamol/Acetaminophen"] <- "Multiple analgesics"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Dexamethasone Mepivacaine hydrochloride"] <- "Multiple analgesics"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Lidocaine Buprenorphine"] <- "Multiple analgesics"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Lidocaine Butorphanol"] <- "Multiple analgesics"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Lidocaine Ketoprofen"] <- "Multiple analgesics"
levels(dfc4$Analgesic_class)[levels(dfc4$Analgesic_class)=="Carprofen Dexamethasone"] <- "Anti-inflammatory"


```

```{r Creating_subgroup_dataframes, include=FALSE}
#dataframe of unique control measures - removes duplicates of all studies that contained multiple experiments but used the same control group for all of them
dfc4_Unique <- dfc4 %>%
  distinct(Publication_code, Infarct_mean_control, Infarct_error_control, .keep_all = TRUE) %>%
  filter(!is.na(Infarct_percent_control) &
           !is.na(Infarct_SD_control_percent) &
           !is.na(N_animals_control))
dfc4_Unique <- droplevels(dfc4_Unique) #drop all the newly empty levels

```


# Summary graphs

```{r Barplot_categorical_1, include=FALSE, eval=FALSE}

# summary(dfc4_Unique$Animal) #only 12 mice!
# summary(dfc4_Unique$Sex) #female 5, mixed 6, NR 10
# summary(dfc4_Unique$Comorbidity) #only aged, hypertension, + None >4
# summary(dfc4_Unique$ET_administration_route) #sponge = 2, NR = 3
# summary(dfc4_Unique$ET_brain_depth) 
# summary(dfc4_Unique$MCA_occluded)
# summary(dfc4_Unique$Conscious) #only 4 NRs


dfc4_U_Barplot <- dfc4_Unique
#add smaller comorbidities into "Other"
levels(dfc4_U_Barplot$Comorbidity)[levels(dfc4_U_Barplot$Comorbidity)=="Hypothyroidism"] <- "Other"
levels(dfc4_U_Barplot$Comorbidity)[levels(dfc4_U_Barplot$Comorbidity)=="Pituitary dwarfism"] <- "Other"
summary(dfc4_U_Barplot$Comorbidity)
#reclassify some antibiotics
levels(dfc4_U_Barplot$Antibiotic)[levels(dfc4_U_Barplot$Antibiotic)=="Topical antibiotic"] <- "Unspecified antibiotic"
summary(dfc4_U_Barplot$Antibiotic)

#make df for first plot
dfc4_U_Barplot_1 <- dfc4_U_Barplot
# This barplot will have Animal, Sex, Comorbidity, and Conscious

#Make dataframe for barplot
dfc4_U_Barplot_1 <- pivot_longer(dfc4_U_Barplot_1, 
                             cols=c(Animal, 
                                    Sex,
                                    Comorbidity,
                                    Conscious, 
                                    Infarct_measurement), 
                             names_to = "Variable",
                             values_to = "Value", 
                             values_drop_na = FALSE)

summary(as.factor(dfc4_U_Barplot_1$Variable))
summary(dfc4_U_Barplot_1$Value)
levels(dfc4_U_Barplot_1$Value)[levels(dfc4_U_Barplot_1$Value)=="NR"] <- "Not reported"  #replace NR with "Not reported"

#re-order variables + levels
dfc4_U_Barplot_1$Variable <- factor(dfc4_U_Barplot_1$Variable, 
                                  levels = c("Animal", 
                                             "Sex", 
                                             "Comorbidity", 
                                             "Conscious",
                                             "Infarct_measurement"))

dfc4_U_Barplot_1$Value <- factor(dfc4_U_Barplot_1$Value, 
                               levels = c( "Not reported", 
                                           "Rat",  "Mouse",  
                                           "Male", "Female", "Mixed", 
                                           "None", "Aged", "Hypertension", 
                                           "Unconscious", "Conscious",
                                           "Other histology (ex vivo)", "TTC (ex vivo)", "MRI (in vivo)", "PET (in vivo)",
                                           "Other"))

#make barplot
pdf("Summary_barplot_study_design_3.pdf", height = 5, width = 7)
ggplot(dfc4_U_Barplot_1, aes(fill=Value, x=Variable)) + 
  geom_bar() +
  theme_bw() +
  scale_fill_manual(values = c("Not reported" = mako(12)[3], 
                               "Rat" = mako(12)[5],  "Mouse" = mako(12)[9],  
                               "Male" = mako(12)[5], "Female" = mako(12)[7], "Mixed" = mako(12)[9], 
                               "None" = mako(12)[5], "Aged" = mako(12)[7], "Hypertension" = mako(12)[9], 
                               "Unconscious" = mako(12)[5], "Conscious" = mako(12)[9],
                               "Other histology (ex vivo)"= mako(12)[5], "TTC (ex vivo)"= mako(12)[6], "MRI (in vivo)"= mako(12)[8], "PET (in vivo)"= mako(12)[10],
                               "Other"= mako(12)[11])) +
  theme(legend.position = "none") +
  geom_text(aes(label=Value), stat="count", position = "stack", vjust=1.2) +
  labs(y="Number of experiments", x= "") +
  scale_x_discrete(labels = c("Animal Species", "Animal Sex", "Comorbidity", "Stroke induction awake/asleep", "Infarct measurement method")) +
  ylim(-7,195) #careful, this can clip the data!!
dev.off()

```

```{r Barplot_categorical_2, include=FALSE, eval=FALSE}

#make df for second barplot
dfc4_U_Barplot_2 <- dfc4_U_Barplot
# this barplot will have ET_administration_route, ET_brain_depth, MCA_occluded, Analgesics, Antibiotics
# Analgesics
# Analgesic_Not_reported
# Analgesic_class_Local_anaesthetic
# Analgesic_class_Opioid
# Analgesic_class_Anti_inflammatory
# Analgesic_class_Analgesic_antipyretic



#Make dataframe for barplot
dfc4_U_Barplot_2 <- pivot_longer(dfc4_U_Barplot_2, 
                             cols=c(ET_administration_route,
                                    ET_brain_depth,
                                    MCA_occluded,
                                    Analgesic_class,
                                    Antibiotic), 
                             names_to = "Variable",
                             values_to = "Value", 
                             values_drop_na = FALSE)

summary(as.factor(dfc4_U_Barplot_2$Variable))
summary(dfc4_U_Barplot_2$Value)
levels(dfc4_U_Barplot_2$Value)[levels(dfc4_U_Barplot_2$Value)=="NR"] <- "Not reported"  #replace NR with "Not reported"

#re-order variables + levels
dfc4_U_Barplot_2$Variable <- factor(dfc4_U_Barplot_2$Variable, 
                                  levels = c("ET_administration_route",
                                             "MCA_occluded",
                                             "ET_brain_depth",
                                             "Analgesic_class",
                                             "Antibiotic"))

dfc4_U_Barplot_2$Value <- factor(dfc4_U_Barplot_2$Value, 
                               levels = c( "Not reported",
                                           "Needle", "Guide cannula", "Dropper", "Sponge",
                                           "Yes", "No",
                                           "Cortical", "Subcortical", "Both cortical and subcortical",
                                           "Anti-inflammatory", "Opioid", "Local anaesthetic", "Multiple analgesics", "Analgesic/antipyretic",
                                           "Enrofloxacin", "Unspecified antibiotic", "Tribrissen", "Gentamicin"))

#make barplot
pdf("Summary_barplot_surgical_methods_3.pdf", height = 5, width = 7)
ggplot(dfc4_U_Barplot_2, aes(fill=Value, x=Variable)) + 
  geom_bar() +
  theme_bw() +
  scale_fill_manual(values = c("Not reported" = mako(12)[3],
                               "Needle"=mako(12)[5], "Guide cannula"=mako(12)[7], "Dropper"=mako(12)[9], "Sponge"=mako(12)[11],
                               "Yes" = mako(12)[5], "No"= mako(12)[9],
                               "Cortical" =mako(12)[5], "Subcortical" =mako(12)[7], "Both cortical and subcortical" =mako(12)[9],
                               "Anti-inflammatory"=mako(12)[4], "Opioid"=mako(12)[6], "Local anaesthetic"=mako(12)[8], "Multiple analgesics"=mako(12)[10], "Analgesic/antipyretic"=mako(12)[11],
                               "Enrofloxacin"=mako(12)[5], "Unspecified antibiotic"=mako(12)[7], "Tribrissen"=mako(12)[9], "Gentamicin"=mako(12)[11])) +
  theme(legend.position = "none") +
  geom_text(aes(label=Value), stat="count", position = "stack", vjust=1.2) +
  labs(y="Number of experiments", x= "") +
  scale_x_discrete(labels = c("Endothelin-1 adminstration route", "MCA occluded", "Brain area infarcted", "Analgesic class", "Antibiotic administered")) +
  ylim(-7,195) # +
  #coord_flip()
dev.off()

```

```{r Raincloud_plots_numeric, include=FALSE, eval=FALSE}


pdf("Summary_violin_Induction_time_hrs_5.pdf", height=1.5, width=8)
ggplot(dfc4_Unique, aes(x= factor(""), y = Induction_time_hrs)) +
  geom_flat_violin(fill = mako(7)[1], #raincloud bit, this is from PupillometryR, mako for colour
                   alpha = 0.8, #transparency
                   position = position_nudge(x = 0.12, y = 0)) + #move it up a bit so it's not sitting on dots
  geom_point(aes(y=Induction_time_hrs), 
             position = position_jitter(seed = 2, width = 0.1), #stop dots being stacked on top of each other
             alpha = 0.4, #transparency
             colour = mako(7)[1]) + #dots colour
  scale_x_discrete(expand = c(0.15, 0)) + #this moves the whole graph down closer to the bottom axis
  scale_y_continuous(breaks = seq(0,400,by=24), minor_breaks = NULL) + #add gridlines where I want on the y axis
  theme_bw() + 
  coord_flip() + #flip horizontal
  labs(x = "",
       y = "Time between initial surgery and Endothelin-1 injection (hours)") +
    theme(panel.grid.major.y = element_blank(), #remove major y gridlines
          panel.grid.minor.y = element_blank(), #remove minor y gridlines
          axis.ticks.y = element_blank() #remove y axis ticks
    )
dev.off()

# geom_point(aes(y = as.numeric(Residuals), color = Explanatory), 
#            position = position_jitterdodge(dodge.width = 0.6, jitter.width = 2), #stop them sitting on top of each other in flat line, this tells size of jitter
#            size = 1.5, #size of points
#            alpha = 0.5) + #transparency


pdf("Summary_violin_ET_administration_sites_5.pdf", height=1.5, width=8)
ggplot(dfc4_Unique, aes(x= "", y = ET_administration_sites)) +
  geom_flat_violin(fill = mako(7)[2], #raincloud bit, this is from PupillometryR, mako for colour
                   alpha = 0.8, #transparency
                   position = position_nudge(x = 0.12, y = 0)) + #move it up a bit so it's not sitting on dots
  geom_point(aes(y=ET_administration_sites), 
             position = position_jitter(seed = 2, width = 0.1, height = 0.2), #stop dots being stacked on top of each other
             alpha = 0.4, #transparency
             colour = mako(7)[2]) + #dots colour
  scale_x_discrete(expand = c(0.15, 0)) + #this moves the whole graph down closer to the bottom axis
  scale_y_continuous(breaks = seq(0,12,by=1), minor_breaks = NULL) +
  theme_bw() + 
  coord_flip() +
  labs(x = "",
       y = "Number of Endothelin-1 administration sites in the brain") +
    theme(panel.grid.major.y = element_blank(), #remove major y gridlines
          panel.grid.minor.y = element_blank(), #remove minor y gridlines
          axis.ticks.y = element_blank() #remove y axis ticks
    )

dev.off()


pdf("Summary_violin_ET_dose_pmol_5.pdf", height=1.5, width=8)
ggplot(dfc4_Unique, aes(x= "", y = ET_dose_pmol)) +
  geom_flat_violin(fill = mako(7)[3], #raincloud bit, this is from PupillometryR, mako for colour
                   alpha = 0.8, #transparency
                   position = position_nudge(x = 0.12, y = 0)) + #move it up a bit so it's not sitting on dots
  geom_point(aes(y=ET_dose_pmol), 
             position = position_jitter(seed = 2, width = 0.1), #stop dots being stacked on top of each other
             alpha = 0.4, #transparency
             colour = mako(7)[3]) + #dots colour
  scale_x_discrete(expand = c(0.15, 0)) + #this moves the whole graph down closer to the bottom axis
  scale_y_continuous(breaks = seq(0,5000,by=500)) +
  theme_bw() + 
  coord_flip() +
  labs(x = "",
       y = "Dose of Endothelin-1 (pmol)") +
    theme(panel.grid.major.y = element_blank(), #remove major y gridlines
          panel.grid.minor.y = element_blank(), #remove minor y gridlines
          axis.ticks.y = element_blank() #remove y axis ticks
    )
dev.off()


pdf("Summary_violin_ET_administration_mins_5.pdf", height=1.5, width=8)
ggplot(dfc4_Unique, aes(x= "", y = ET_administration_mins)) +
  geom_flat_violin(fill = mako(7)[4], #raincloud bit, this is from PupillometryR, mako for colour
                   alpha = 0.8, #transparency
                   position = position_nudge(x = 0.12, y = 0)) + #move it up a bit so it's not sitting on dots
  geom_point(aes(y=ET_administration_mins), 
             position = position_jitter(seed = 2, width = 0.1), #stop dots being stacked on top of each other
             alpha = 0.5, #transparency
             colour = mako(7)[4]) + #dots colour
  scale_x_discrete(expand = c(0.15, 0)) + #this moves the whole graph down closer to the bottom axis
  scale_y_continuous(breaks = seq(0,60,by=10)) +
  theme_bw() + 
  coord_flip() +
  labs(x = "",
       y = "Duration of Endothelin-1 administration (mins)") +
    theme(panel.grid.major.y = element_blank(), #remove major y gridlines
          panel.grid.minor.y = element_blank(), #remove minor y gridlines
          axis.ticks.y = element_blank() #remove y axis ticks
    )
dev.off()


pdf("Summary_violin_Infarct_measure_days_5.pdf", height=1.5, width=8)
ggplot(dfc4_Unique, aes(x= "", y = Infarct_measure_hrs/24)) + #divide by 24 to convert to days
  geom_flat_violin(fill = mako(7)[5], #raincloud bit, this is from PupillometryR, mako for colour
                   alpha = 0.8, #transparency
                   position = position_nudge(x = 0.12, y = 0)) + #move it up a bit so it's not sitting on dots
  geom_point(aes(y=Infarct_measure_hrs/24), #divide by 24 to convert to days
             position = position_jitter(seed = 2, width = 0.1), #stop dots being stacked on top of each other
             alpha = 0.5, #transparency
             colour = mako(7)[5]) + #dots colour
  scale_x_discrete(expand = c(0.15, 0)) + #this moves the whole graph down closer to the bottom axis
  scale_y_continuous(breaks = seq(0,400,by=25)) +
  theme_bw() + 
  coord_flip() +
  labs(x = "",
       y = "Time of infarct measurement post-stroke (days)") +
    theme(panel.grid.major.y = element_blank(), #remove major y gridlines
          panel.grid.minor.y = element_blank(), #remove minor y gridlines
          axis.ticks.y = element_blank() #remove y axis ticks
    )
dev.off()


pdf("Summary_violin_control_group_n_2.pdf", height=1.5, width=8)

ggplot(dfc4_Unique, aes(x= "", y = N_animals_control)) +
  geom_flat_violin(fill = mako(7)[6], #raincloud bit, this is from PupillometryR, mako for colour
                   alpha = 0.8, #transparency
                   position = position_nudge(x = 0.12, y = 0),
                   width = 0.5) + #move it up a bit so it's not sitting on dots
  geom_point(aes(y=N_animals_control), 
             position = position_jitter(seed = 2, width = 0.1), #stop dots being stacked on top of each other
             alpha = 0.6, #transparency
             colour = mako(7)[6]) + #dots colour
  scale_x_discrete(expand = c(0.15, 0)) + #this moves the whole graph down closer to the bottom axis
  scale_y_continuous(breaks = seq(3,35,by=1), minor_breaks = NULL) +
  theme_bw() + 
  coord_flip() +
  labs(x = "",
       y = "Number of animals in control group") +
    theme(panel.grid.major.y = element_blank(), #remove major y gridlines
          panel.grid.minor.y = element_blank(), #remove minor y gridlines
          axis.ticks.y = element_blank() #remove y axis ticks)
          
    )
dev.off()


```

```{r Plotting_anaesthetics_surgery, include=FALSE, eval=FALSE}

dfc4_Anaes_plot <- dfc4_Unique

dfc4_Anaes_plot$Blank_no_anaesthetics<-rep(0, nrow(dfc4_Anaes_plot)) #make a column and populate it with zeros
dfc4_Anaes_plot$Blank_sevoflurane<-rep(0, nrow(dfc4_Anaes_plot)) #make a column and populate it with zeros

dfc4_Anaes_plot_Surg <- pivot_longer(dfc4_Anaes_plot,
                                cols=c(Surgery_Diazepam,
                                       Surgery_Halothane,
                                       Surgery_Isoflurane,
                                       Surgery_Ketamine,
                                       Surgery_Nitrous_oxide,
                                       Surgery_Sodium_Pentobarbital,
                                       #Surgery_Tribromoethanol,
                                       Surgery_Xylazine,
                                       Surgery_other_anaesthetics,
                                       Surgery_A_Not_reported,
                                       Blank_no_anaesthetics, #none of these used in surgery, just a blank column to match induction graph
                                       Blank_sevoflurane), #none of these used in surgery, just a blank column to match induction graph
                                names_to = "Variable",
                             values_to = "Value", 
                             values_drop_na = FALSE) %>% 
  group_by(Variable) %>%  #group by anaesthetic name
  summarise(Value = sum(Value)) #count all the ones and summarise

summary(as.factor(dfc4_Anaes_plot_Surg$Variable))
summary(dfc4_Anaes_plot_Surg$Value)




dfc4_Anaes_plot_Surg$Variable <- factor(dfc4_Anaes_plot_Surg$Variable, 
                                          levels = c(
  "Blank_no_anaesthetics",
  "Surgery_Diazepam", 
  "Surgery_Halothane",
  "Surgery_Isoflurane",
  "Surgery_Ketamine",
  "Surgery_Nitrous_oxide",
  "Blank_sevoflurane",
  "Surgery_Sodium_Pentobarbital",
  #"Surgery_Tribromoethanol",
  "Surgery_Xylazine",
  "Surgery_other_anaesthetics",
  "Surgery_A_Not_reported"
))

levels(dfc4_Anaes_plot_Surg$Variable) <- c( #rename anaesthetics in "Variable"
  "No anaesthetic",
  "Diazepam", 
  "Halothane",
  "Isoflurane",
  "Ketamine",
  "Nitrous oxide",
  "Sevoflurane",
  "Sodium pentobarbital",
  #"Tribromoethanol",
  "Xylazine",
  "Other anaesthetics",
  "Anaesthetics not reported")

pdf("Anaesthetic_count_surgical_4.pdf", height = 5, width = 8)
ggplot(dfc4_Anaes_plot_Surg, aes(x=Variable, y=Value)) + 
  geom_bar(stat = "identity", aes(fill = Variable), colour="black") + #colour for bar outlines
  geom_text(aes(label = Value, vjust = -0.5)) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 12, face = "bold"),
        legend.position = "none") +
  scale_fill_viridis(discrete = TRUE, option = "G") +
  scale_y_continuous(expand = c(0, 0), #moves all the bars down to sit on 0, no gap
                     limits = c(0,70), #sets limits for main y axis (on left)
                     breaks=seq(0,70,by=10), #make major gridlines on multiples of 10
                     sec.axis = sec_axis(trans=~./192*100,  #make it a percentage out of 192
                        name="Percentage of experiments", 
                        breaks=seq(0,40,by=5))) + # make two axes with brain volume as percentage)
  labs(title = "Anaesthetics used during surgery", 
       x = "", y = "Count of experiments") +
  theme(
    # panel.background = element_rect(fill = alpha("turquoise1", 0.2)), #colour and transparency of background - to separate 2 graphs
          panel.grid.major.x = element_blank(), #remove x gridlines
          # panel.grid.major.y = element_line(colour = "gray40"), #colour major y gridlines
          panel.grid.minor.y = element_blank()) #remove minor y gridlines
dev.off()


#add in some columns and populate with zeroes for anaesthetics used in surgery


```

```{r Plotting_anaesthetics_induction, include=FALSE, eval=FALSE}

dfc4_Anaes_plot$Blank_diazepam<-rep(0, nrow(dfc4_Anaes_plot)) #make a column and populate it with zeros
#need to add diazepam empty column to match surgery

dfc4_Anaes_plot_Induct <- pivot_longer(dfc4_Anaes_plot,
                                cols=c(Induction_No_anaesthetic,
                                       Induction_Halothane,
                                       Induction_Isoflurane,
                                       Induction_Ketamine,
                                       Induction_Nitrous_oxide,
                                       Induction_Sevoflurane,
                                       Induction_Sodium_Pentobarbital,
                                       #Induction_Tribromoethanol,
                                       Induction_Xylazine,
                                       Induction_other_anaesthetics,
                                       Induction_A_Not_reported,
                                       Blank_diazepam), #not used during induction, just a blank column to match surgery graph
                                names_to = "Variable",
                             values_to = "Value", 
                             values_drop_na = FALSE) %>% 
    group_by(Variable) %>%  #group by anaesthetic name
    summarise(Value = sum(Value)) #count all the ones and summarise

summary(as.factor(dfc4_Anaes_plot_Induct$Variable))
summary(dfc4_Anaes_plot_Induct$Value)

dfc4_Anaes_plot_Induct$Variable <- factor(dfc4_Anaes_plot_Induct$Variable, 
                                          levels = c(
  "Induction_No_anaesthetic",
  "Blank_diazepam",
  "Induction_Halothane",
  "Induction_Isoflurane",
  "Induction_Ketamine",
  "Induction_Nitrous_oxide",
  "Induction_Sevoflurane",
  "Induction_Sodium_Pentobarbital",
  #"Induction_Tribromoethanol",
  "Induction_Xylazine",
  "Induction_other_anaesthetics",
  "Induction_A_Not_reported"
))

levels(dfc4_Anaes_plot_Induct$Variable) <- c( #rename anaesthetics in "Variable"
  "No anaesthetic",
  "Diazepam",
  "Halothane",
  "Isoflurane",
  "Ketamine",
  "Nitrous oxide",
  "Sevoflurane",
  "Sodium pentobarbital",
  #"Tribromoethanol",
  "Xylazine",
  "Other anaesthetics",
  "Anaesthetics not reported")

pdf("Anaesthetic_count_induction_4.pdf", height = 5, width = 8)
ggplot(dfc4_Anaes_plot_Induct, aes(x=Variable, y=Value)) + 
  geom_bar(stat = "identity", aes(fill = Variable), colour="black") + #colour for bar outlines
  geom_text(aes(label = Value, vjust = -0.5)) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 12, face = "bold"),
        legend.position = "none") +
  scale_fill_viridis(discrete = TRUE, option = "G") +
  scale_y_continuous(expand = c(0, 0), #moves all the bars down to sit on 0, no gap
                     limits = c(0,70), #sets limits for main y axis (on left)
                     breaks=seq(0,70,by=10), #make major gridlines on multiples of 10
                     sec.axis = sec_axis(trans=~./192*100,  #make it a percentage out of 192
                        name="Percentage of experiments", 
                        breaks=seq(0,40,by=5))) + # make two axes with brain volume as percentage) +
  labs(title = "Anaesthetics used during stroke induction", 
       x = "", y = "Count of experiments") +
    theme(
          # panel.background = element_rect(fill = alpha("springgreen", 0.15)), #colour and transparency of background - to separate 2 graphs
          panel.grid.major.x = element_blank(), #remove x gridlines
          # panel.grid.major.y = element_line(colour = "gray40"), #colour major y gridlines
          panel.grid.minor.y = element_blank()) #remove minor y gridlines
dev.off()


#add in some columns and populate with zeroes for anaesthetics used in surgery 


```


# Cleaning up data for modelling

Checking for outliers + removing
```{r Outliers_from_conversions, include=FALSE, eval=FALSE}
#Checking for outliers due to mis-reporting of units.

dfc4_Outliers <- dfc4_Unique

#checking ET dose in pmol - log to get closer to normal dist
hist(log(dfc4_Outliers$ET_dose_pmol, base = 10), breaks = 30)

#making z scores to find any outliers further than 3 standard deviations from the mean
dfc4_Outliers$log_dose_pmol<-log(dfc4_Outliers$ET_dose_pmol, base = 10)
dfc4_Outliers$Zscore_log_dose_pmol<-(dfc4_Outliers$log_dose_pmol-mean(dfc4_Outliers$log_dose_pmol, na.rm=T))/sd(dfc4_Outliers$log_dose_pmol,na.rm=T)

dfc4_Outliers[which(abs(dfc4_Outliers$Zscore_log_dose_pmol)>3),]
#following coming up as outliers: De_Geyter_2013 (2 experiments, rows 22 + 23), and Gilmour_2005 (row 38). Checked Gilmour, was an incorrect conversion, fixed the conversion and it has stayed an outlier, although it is now very small when before it was very large

#checking infarct volume as a % of whole brain
hist(log(dfc4_Outliers$Infarct_percent_control, base=10), breaks = 30)#logging it appears to help change it closer to normal dist

#check for ouliers >3 SDs using Z score of loged data
dfc4_Outliers$log_infarct_vol<-log(dfc4_Outliers$Infarct_percent_control, base = 10)
dfc4_Outliers$Zscore_log_infarct_vol<-(dfc4_Outliers$log_infarct_vol-mean(dfc4_Outliers$log_infarct_vol, na.rm=T))/sd(dfc4_Outliers$log_infarct_vol,na.rm=T)

dfc4_Outliers[which(abs(dfc4_Outliers$Zscore_log_infarct_vol)>3),] 
#no outliers come up when logged

```

```{r Removing_outliers, include=FALSE}
#following coming up as outliers: De_Geyter_2013 (2 experiments, rows 22 + 23), and Gilmour_2005 (row 38). Checked Gilmour, was an incorrect conversion, fixed the conversion and it has stayed an outlier, although it is now very small when before it was very large

dfc4_Reduced <- dfc4_Unique

dfc4_Reduced <- dfc4_Reduced[-22,]
dfc4_Reduced <- dfc4_Reduced[-23,]
dfc4_Reduced <- dfc4_Reduced[-38,]

```

Remove all small factors identified to have low numbers
```{r Removing_small_factors+binning, include=FALSE}
# #check all categorical factors
# summary(dfc4_Unique$Animal) #only 12 mice!
# summary(dfc4_Unique$Sex) #female 5, mixed 6, NR 10
# summary(dfc4_Unique$Comorbidity) #only aged, hypertension, + None >4.
# summary(dfc4_Unique$ET_administration_route) #sponge = 2, NR = 3
# summary(dfc4_Unique$ET_brain_depth) 
# summary(dfc4_Unique$MCA_occluded)
# summary(dfc4_Unique$Conscious) #only 4 NRs
# summary(dfc4_Reduced$Infarct_measurement)

#comorbidity 
dfc4_Reduced <- dfc4_Reduced %>%
  filter(is.na(Comorbidity) | #need this line of code or it filters out all rows with NAs
           Comorbidity != "Hypothyroidism" &
           Comorbidity != "Pituitary dwarfism")
dfc4_Reduced$Comorbidity <- droplevels(dfc4_Reduced$Comorbidity) #drop empty levels created above
summary(dfc4_Reduced$Comorbidity)

#ET_administration_route 
dfc4_Reduced <- dfc4_Reduced %>%
  filter(is.na(ET_administration_route) | #need this line of code or it filters out all rows with NAs
           ET_administration_route != "NR" &
           ET_administration_route != "Sponge")
dfc4_Reduced$ET_administration_route <- droplevels(dfc4_Reduced$ET_administration_route) #drop empty levels created above
summary(dfc4_Reduced$ET_administration_route)

#Conscious
dfc4_Reduced <- dfc4_Reduced %>%
  filter(is.na(Conscious) | #need this line of code or it filters out all rows with NAs
           Conscious != "NR")
dfc4_Reduced$Conscious <- droplevels(dfc4_Reduced$Conscious) #drop empty levels created above
summary(dfc4_Reduced$Conscious)

#Infarct_measurement 
dfc4_Reduced <- dfc4_Reduced %>%
  filter(is.na(Infarct_measurement) | #need this line of code or it filters out all rows with NAs
           Infarct_measurement != "NR")
dfc4_Reduced$Infarct_measurement <- droplevels(dfc4_Reduced$Infarct_measurement) #drop empty levels created above
summary(dfc4_Reduced$Infarct_measurement)


```

```{r Reorder_factor_levels, include=FALSE}

summary(dfc4_Reduced$Animal)
dfc4_Reduced$Animal <- factor(dfc4_Reduced$Animal, levels = c('Rat','Mouse'))

summary(dfc4_Reduced$Sex)
dfc4_Reduced$Sex <- factor(dfc4_Reduced$Sex, levels = c("Male","Female", "Mixed", "NR"))
levels(dfc4_Reduced$Sex)[levels(dfc4_Reduced$Sex)=="NR"] <- "Not reported"

summary(dfc4_Reduced$Comorbidity)
dfc4_Reduced$Comorbidity <- factor(dfc4_Reduced$Comorbidity, levels = c("None","Aged", "Hypertension"))

summary(dfc4_Reduced$ET_administration_route)
dfc4_Reduced$ET_administration_route <- factor(dfc4_Reduced$ET_administration_route, levels = c("Needle",
                                                                                                "Guide cannula", 
                                                                                                "Dropper"))

summary(dfc4_Reduced$ET_brain_depth)
dfc4_Reduced$ET_brain_depth <- factor(dfc4_Reduced$ET_brain_depth, levels = c("Cortical",
                                                                              "Subcortical", 
                                                                              "Both cortical and subcortical"))

summary(dfc4_Reduced$MCA_occluded)
dfc4_Reduced$MCA_occluded <- factor(dfc4_Reduced$MCA_occluded, levels = c("Yes","No", "NR"))
levels(dfc4_Reduced$MCA_occluded)[levels(dfc4_Reduced$MCA_occluded)=="NR"] <- "Not reported"

# summary(dfc4_Reduced$Conscious)
# dfc4_Reduced$Conscious <- factor(dfc4_Reduced$Conscious, levels = c("Unconscious","Conscious"))

summary(dfc4_Reduced$Infarct_measurement)
dfc4_Reduced$Infarct_measurement <- factor(dfc4_Reduced$Infarct_measurement, levels = c("Other histology (ex vivo)",
                                                                              "TTC (ex vivo)",
                                                                              "MRI (in vivo)"))

summary(dfc4_Reduced$Conscious)
dfc4_Reduced$Conscious <- factor(dfc4_Reduced$Conscious, levels = c('Conscious','Unconscious'))


```

## Collinearity analysis (all potential variables)

```{r variable_creation_collinearity, include=FALSE}
#new dataframe for collinearity plots
dfc4_coll <- dfc4_Reduced

# Dummy variable for Animal
for(i in levels(dfc4_coll$Animal)){
dfc4_coll$newcol<-0
dfc4_coll$newcol <-(dfc4_coll$Animal==i)*1 
dfc4_coll [is.na(dfc4_coll$newcol)]<-0 
colnames(dfc4_coll)[ncol(dfc4_coll)]<-i
}

# Dummy variable for Sex
for(i in levels(dfc4_coll$Sex)){
dfc4_coll$newcol<-0
dfc4_coll$newcol <-(dfc4_coll$Sex==i)*1 
dfc4_coll$newcol [is.na(dfc4_coll$newcol)]<-0 
colnames(dfc4_coll)[ncol(dfc4_coll)]<-i
}
colnames(dfc4_coll)[colnames(dfc4_coll)=="Not reported"]<-"Not_reported_sex"
colnames(dfc4_coll)[colnames(dfc4_coll)=="Mixed"]<-"Mixed_sex"

# Comorbidity dummy variables
for(i in levels(dfc4_coll$Comorbidity)){
dfc4_coll$newcol<-0
dfc4_coll$newcol <-(dfc4_coll$Comorbidity==i)*1 
dfc4_coll$newcol[is.na(dfc4_coll$newcol)]<-0 
colnames(dfc4_coll)[ncol(dfc4_coll)]<-i
}
colnames(dfc4_coll)[colnames(dfc4_coll)=="None"]<-"No_comorbidity"

# Dummy variable for ET_administration_route
for(i in levels(dfc4_coll$ET_administration_route)){
dfc4_coll$newcol<-0
dfc4_coll$newcol <-(dfc4_coll$ET_administration_route==i)*1 
dfc4_coll$newcol[is.na(dfc4_coll$newcol)]<-0 
colnames(dfc4_coll)[ncol(dfc4_coll)]<-i
}

# ET_brain_depth dummy variables
for(i in levels(dfc4_coll$ET_brain_depth)){
dfc4_coll$newcol<-0
dfc4_coll$newcol <-(dfc4_coll$ET_brain_depth==i)*1 
dfc4_coll$newcol[is.na(dfc4_coll$newcol)]<-0 
colnames(dfc4_coll)[ncol(dfc4_coll)]<-i
}

# MCA_occluded dummy variables
for(i in levels(dfc4_coll$MCA_occluded)){
dfc4_coll$newcol<-0
dfc4_coll$newcol <-(dfc4_coll$MCA_occluded==i)*1 
dfc4_coll$newcol[is.na(dfc4_coll$newcol)]<-0 
colnames(dfc4_coll)[ncol(dfc4_coll)]<-i
}
colnames(dfc4_coll)[colnames(dfc4_coll)=="Yes"]<-"Occluded_MCA"
colnames(dfc4_coll)[colnames(dfc4_coll)=="No"]<-"MCA_not_occluded"
colnames(dfc4_coll)[colnames(dfc4_coll)=="Not reported"]<-"MCA_occlusion_not_reported"

# ET_brain_depth dummy variables
colnames(dfc4_coll)[colnames(dfc4_coll)=="Conscious"]<-"Consciousness"
for(i in levels(dfc4_coll$Consciousness)){
dfc4_coll$newcol<-0
dfc4_coll$newcol <-(dfc4_coll$Consciousness==i)*1 
dfc4_coll$newcol[is.na(dfc4_coll$newcol)]<-0 
colnames(dfc4_coll)[ncol(dfc4_coll)]<-i
}

# ET_brain_depth dummy variables
for(i in levels(dfc4_coll$Infarct_measurement)){
dfc4_coll$newcol<-0
dfc4_coll$newcol <-(dfc4_coll$Infarct_measurement==i)*1 
dfc4_coll$newcol[is.na(dfc4_coll$newcol)]<-0 
colnames(dfc4_coll)[ncol(dfc4_coll)]<-i
}


```

```{r Collinearity_plot, include=FALSE, eval=FALSE}
# #Lists to help build the matrix
# summary(dfc4_Reduced$Animal) 
# summary(dfc4_Reduced$Sex) 
# summary(dfc4_Reduced$Comorbidity)
# summary(dfc4_Reduced$ET_administration_route)
# summary(dfc4_Reduced$ET_brain_depth)
# summary(dfc4_Reduced$MCA_occluded)
# summary(dfc4_Reduced$Conscious)
# summary(dfc4_Reduced$Infarct_measurement)

#Induction anaesthetics with their own dummy variable (4 or greater): Halothane, Isoflurane, Ketamine, Nitrous oxide, None, Not Reported (NR), Sevoflurane, Sodium Pentobarbital, Tribromoethanol, Xylazine + other

#list all the variables of interest for collinearity checking
column_interest <- c("Infarct_percent_control",
                     "Unconscious",
                     "Conscious",
                     "Rat",
                     "Mouse",
                     "Male",
                     "Female",
                     "Mixed_sex",
                     "Not_reported_sex",
                     "No_comorbidity",
                     "Aged",
                     "Hypertension",
                     "Needle",
                     "Guide cannula",
                     "Dropper",
                     "Cortical",
                     "Subcortical",
                     "Both cortical and subcortical",
                     "Occluded_MCA",
                     "MCA_not_occluded", 
                     "MCA_occlusion_not_reported",
                     "Other histology (ex vivo)",
                     "TTC (ex vivo)",
                     "MRI (in vivo)",
                     "Induction_Halothane",
                     "Induction_Isoflurane",
                     "Induction_Ketamine",
                     "Induction_Nitrous_oxide",
                     "Induction_No_anaesthetic",
                     "Induction_A_Not_reported",
                     "Induction_Sevoflurane",
                     "Induction_Sodium_Pentobarbital",
                     #"Induction_Tribromoethanol",
                     "Induction_Xylazine",
                     "Induction_other_anaesthetics",
                     "Induction_time_hrs",
                     "ET_dose_pmol",
                     "ET_administration_mins",
                     "ET_administration_sites",
                     "Infarct_measure_hrs")
#select just these columns from the dataframe
matrix_coll<-subset(dfc4_coll, select = column_interest)
#how many NA's there are
for(i in 1:ncol(matrix_coll)){
  print(column_interest[i])
print(sum(is.na(matrix_coll[,i])))
}
#remove NA's, complete cases only
matrix_coll<-matrix_coll[complete.cases(matrix_coll),]
mat<-as.matrix(matrix_coll) #turn into a matrix

#make the corrplot
pdf("Collinearity_corrplot_5.pdf", heigh=20, width=20)
corr_matrix<-cor(mat) 
testRes = cor.mtest(mat, conf.level = 0.95)
corrplot(corr_matrix, p.mat = testRes$p, method = 'circle', type = 'lower', insig='blank',
         addCoef.col ='black', number.cex = 0.8, diag=FALSE,tl.col="black")

corrplot(corr_matrix, method = 'circle', type = 'lower', number.cex = 0.8, diag=FALSE, tl.col="black")
dev.off

```

## Tables assessing collinearity

```{r Tables_investigating_collinearity, include=FALSE, eval=FALSE}
# Tabling variables to look at collinearity and ensure we have enough to ascertain effects of no anaesthetic vs induction under anaesthetic

#Animal
table(dfc4_Reduced$Animal,dfc4_Reduced$Conscious)
#Only 12 mice, 0 of them in conscious animals, all the rest are rats
#Remove mice from dataset, remove animal from model

#Sex
table(dfc4_Reduced$Sex,dfc4_Reduced$Conscious)
#No female/mixed/NR in conscious. Keep studies in dataframe but remove variable from model

#Comorbidity
table(dfc4_Reduced$Comorbidity,dfc4_Reduced$Conscious)
#Keep as-is

#Route of administration
table(dfc4_Reduced$ET_administration_route,dfc4_Reduced$Conscious)
table(dfc4_Reduced$ET_administration_route,dfc4_Reduced$ET_brain_depth)
#Remove dropper studies from the dataset, remove route of admin variable from model.

#Injection brain depth + sites
table(dfc4_Reduced$ET_brain_depth,dfc4_Reduced$Conscious)
table(as.factor(dfc4_Reduced$ET_administration_sites),dfc4_Reduced$Conscious)
table(as.factor(dfc4_Reduced$ET_administration_sites),dfc4_Reduced$ET_brain_depth)
table(as.factor(dfc4_Reduced$ET_administration_sites),dfc4_Reduced$ET_brain_depth, dfc4_Reduced$Conscious)
#Keep all of these in as we need to see how infarct injection number + sites affects the size of infarcts when we do case-controlled we can remove all but 1 injection + cortical.

#Occluding middle cerebral artery
table(dfc4_Reduced$MCA_occluded,dfc4_Reduced$Conscious)
#Keep all in and remove non-MCAO during case-match (don't want to pre-emptively do a case-controlled study)

#Time between surgery and stroke induction
boxplot(dfc4_Reduced$Induction_time_hrs~dfc4_Reduced$Conscious)
#Hugely collinear and difficult to see how this would affect brain volume - low a-priori probability of interference. Add to a descriptive table, remove from model

#Endothelin dose
boxplot(dfc4_Reduced$ET_dose_pmol~dfc4_Reduced$Conscious)
stripchart(dfc4_Reduced$ET_dose_pmol~dfc4_Reduced$Conscious, col=as.factor(dfc4_Reduced$ET_administration_sites), pch=16,method="jitter")
#Much smaller doses in conscious animals. Keep, but trim in case-control study

#Duration of administration
boxplot(dfc4_Reduced$ET_administration_mins~dfc4_Reduced$Conscious)
stripchart(dfc4_Reduced$ET_administration_mins~dfc4_Reduced$Conscious, pch=16,method="jitter")
#looks good 

#Analgesics and antibiotics
table(dfc4_Reduced$Primary_analgesic,dfc4_Reduced$Conscious)
table(dfc4_Reduced$Secondary_analgesic,dfc4_Reduced$Conscious)
table(dfc4_Reduced$Antibiotic,dfc4_Reduced$Conscious)
par(mar=c(9,7,2,2), bty="n") #run this line and next line together
stripchart(dfc4_Reduced$Induction_time_hrs~dfc4_Reduced$Primary_analgesic, col=dfc4_Reduced$Conscious, pch=16, las=2, method="jitter")
#For both analgesics and antibiotics there are too few to use. For analgesics - group them by mechanism of action for a summary. Leave both out of model

#Infarct measurement time post-stroke
boxplot(dfc4_Reduced$Infarct_measure_hrs~dfc4_Reduced$Conscious)
stripchart(dfc4_Reduced$Infarct_measure_hrs~dfc4_Reduced$Conscious, pch=16,method="jitter")
table(as.factor(dfc4_Reduced$Infarct_measure_hrs))
#Most conscious are measured early, lots more unconscious measured later. There are two studies with very late measurement - remove these so they don't skew the "linear" relationship we're assuming.

#Method of infarct measurement
table(dfc4_Reduced$Infarct_measurement,dfc4_Reduced$Conscious)
#No conscious used MRI to measure. Still keeping in model as it will be removed for case-matched analysis. 
```

Remove all small factors identified as irrelevant to the model during collinearity checking
```{r Removing_small_factors_collinearity, include=FALSE}

dfc4_Model <- dfc4_Reduced

#Animal
dfc4_Model <- dfc4_Model %>%
  filter(is.na(Animal) | #need this line of code or it filters out all rows with NAs
           Animal != "Mouse")
dfc4_Model$Animal <- droplevels(dfc4_Model$Animal) #drop empty levels created above

#ET_administration_route
dfc4_Model <- dfc4_Model %>%
  filter(is.na(ET_administration_route) | #need this line of code or it filters out all rows with NAs
           ET_administration_route != "Dropper")
dfc4_Model$ET_administration_route <- droplevels(dfc4_Model$ET_administration_route) #drop empty levels created above

#Time infarct measured post-stroke remove anything >3000 hours (2 experiments) - way too skewed
dfc4_Model <- dfc4_Model %>%
  filter(is.na(Infarct_measure_hrs) | #need this line of code or it filters out all rows with NAs
           Infarct_measure_hrs < 3000)

```

```{r model_dataframe_variable_edits, include=FALSE}
#make a variable for rat brain volume in mm^3
dfc4_Model$Rat_infarct_volume_mm3 <- dfc4_Model$Infarct_percent_control*19.71

#create categorical variable for number of administration sites since this relationship with infarct volume likely isn't linear
dfc4_Model$ET_administration_sites_cat <- dfc4_Model$ET_administration_sites>1
dfc4_Model$ET_administration_sites_cat[dfc4_Model$ET_administration_sites_cat==TRUE]<-"Multiple sites"
dfc4_Model$ET_administration_sites_cat[dfc4_Model$ET_administration_sites_cat==FALSE]<-"Single site"
dfc4_Model$ET_administration_sites_cat <- factor(dfc4_Model$ET_administration_sites_cat, levels = c('Single site','Multiple sites'))
```


# Full linear model

```{r Model_initial+assessment, include=FALSE}

#linear model with all cleaned variables
lm_test <- lm(data = dfc4_Model,
   Rat_infarct_volume_mm3 ~
     Induction_Halothane  +
     Induction_Isoflurane +
     Induction_Ketamine +
     Induction_Nitrous_oxide +
     #Induction_No_anaesthetic + #a zero on all other anaesthetics is the same as a 1 on this
     Induction_Sevoflurane +
     Induction_Sodium_Pentobarbital +
     Induction_Xylazine +
     Induction_other_anaesthetics +
     Induction_A_Not_reported +
     Comorbidity +
     ET_brain_depth +
     MCA_occluded +
     ET_dose_pmol + #may need to log this
     ET_administration_mins +
     ET_administration_sites +
     Infarct_measure_hrs +
     Infarct_measurement,
   weights = N_animals_control
   )

tab_model(lm_test)

tab_df(car::Anova(lm_test), show.rownames = TRUE)
 #Diagnostic plots 
autoplot(lm_test,which = c(1,2,4))

#Residuals vs fitted shows a spread, our dependent variable does not meet assumptions of normality, need a transformation to fix this.

#Cook's distance cut-off is usually 4/n, where n is total number of data points, in this case, 117 experiments were used in the model. 4/117=0.03418
#The graph shows ~8 studies with larger cook's distance than this, which may be being overly influential

```

```{r Model_transformed, include=FALSE}
#run boxcox on old model to identify transformation
lm_boxcox<-boxcox(lm_test,lambda = seq(-5, 5, 1/1000), plotit = TRUE)

Selected.lambda <-lm_boxcox$x[lm_boxcox$y==max(lm_boxcox$y)] 
Selected.lambda

#linear model with all cleaned variables
lm_transformed <- lm(data = dfc4_Model,
   #Rat_infarct_volume_mm3^Selected.lambda ~ #transformed dependent variable
     log(Rat_infarct_volume_mm3, base=10) ~ #transformed dependent variable
     Comorbidity +
     ET_brain_depth +
     MCA_occluded +
     ET_dose_pmol + #may need to log this
     ET_administration_mins +
     ET_administration_sites +
     Infarct_measure_hrs +
     Infarct_measurement +
     Induction_Halothane  +
     Induction_Isoflurane +
     Induction_Ketamine +
     Induction_Nitrous_oxide +
     #Induction_No_anaesthetic + #a zero on all other anaesthetics is the same as a 1 on this
     Induction_Sevoflurane +
     Induction_Sodium_Pentobarbital +
     Induction_Xylazine +
     Induction_other_anaesthetics +
     Induction_A_Not_reported,
   weights = N_animals_control
   )


tab_model(lm_transformed)

tab_df(car::Anova(lm_transformed), show.rownames = TRUE)

```

```{r Removing_outliers, include=FALSE}
#Diagnostic plots 
autoplot(lm_transformed,which = c(1,2,4))

#Residuals vs fitted shows a spread, our dependent variable does not meet assumptions of normality, need a transformation to fix this.

#Cook's distance cut-off is usually 4/n, where n is total number of data points, in this case, 117 experiments were used in the model. 4/117=0.03418
#The transformed graph shows only 1-2 studies with larger cook's distance than this, which may be being overly influential

which(cooks.distance(lm_transformed)>0.3) #Identify row numbers of studies that have a cook's distance of >a certain number
#show the lines
dfc4_Model[42,] #remove, was tugging the model, had 60 minute induction duration
dfc4_Model[35,] #don't remove, not actually an outlier and can't find any obviously different thing about it. Disappears as outlier when 42 is removed

dfc4_Model_trimmed <- dfc4_Model[-42,]

```

```{r Final_linear_model}
#linear model with all cleaned variables
lm_transformed_trimmed <- lm(data = dfc4_Model_trimmed,
   #Rat_infarct_volume_mm3^Selected.lambda ~ #transformed dependent variable
     log(Rat_infarct_volume_mm3, base=10) ~ #transformed dependent variable
     Comorbidity +
     ET_brain_depth +
     MCA_occluded +
     ET_dose_pmol + 
     ET_administration_mins +
     #ET_administration_sites + #changed to categorical as relationship unlikely to be linear
     ET_administration_sites_cat +
     Infarct_measure_hrs +
     Infarct_measurement +
     Induction_Halothane  +
     Induction_Isoflurane +
     Induction_Ketamine +
     Induction_Nitrous_oxide +
     #Induction_No_anaesthetic + #a zero on all other anaesthetics is the same as a 1 on this
     Induction_Sevoflurane +
     Induction_Sodium_Pentobarbital +
     Induction_Xylazine +
     Induction_other_anaesthetics +
     Induction_A_Not_reported,
   weights = N_animals_control
   )

tab_model(lm_transformed_trimmed, digits=4, file = "Linear_model_full_3.html")

tab_df(car::Anova(lm_transformed_trimmed), show.rownames = TRUE, digits=4, file = "Linear_model_full_ANOVA_3.html")
 #Diagnostic plots 
autoplot(lm_transformed_trimmed,which = c(1,2,4))

which(cooks.distance(lm_transformed_trimmed)>0.3) #no cooks distance violations anymore

```

```{r Alternate_linear_model_conscious, include=FALSE}
#creating a linear model with conscious/unconscious instead of anaesthetics to use in prediction plots
summary(dfc4_Model_trimmed$Conscious)

lm_transformed_alternate_conscious <- lm(data = dfc4_Model_trimmed,
   #Rat_infarct_volume_mm3^Selected.lambda ~ #transformed dependent variable
     log(Rat_infarct_volume_mm3, base=10) ~ #transformed dependent variable
     Comorbidity +
     ET_brain_depth +
     MCA_occluded +
     ET_dose_pmol + 
     ET_administration_mins +
     #ET_administration_sites + #changed to categorical as relationship unlikely to be linear
     ET_administration_sites_cat +
     Infarct_measure_hrs +
     Infarct_measurement +
     # Induction_Halothane  +
     # Induction_Isoflurane +
     # Induction_Ketamine +
     # Induction_Nitrous_oxide +
     # #Induction_No_anaesthetic + #a zero on all other anaesthetics is the same as a 1 on this
     # Induction_Sevoflurane +
     # Induction_Sodium_Pentobarbital +
     # Induction_Xylazine +
     # Induction_other_anaesthetics +
     # Induction_A_Not_reported,
     Conscious, #using conscious/unconscious instead of anaesthetics
   weights = N_animals_control
   )

tab_model(lm_transformed_alternate_conscious, digits=4)

tab_df(car::Anova(lm_transformed_alternate_conscious), show.rownames = TRUE, digits=4)

#note that consciousness is not significant, but anaesthetics individually are
```



# Prediction plots for full linear model

```{r Mean_overall_brain_vol, include=FALSE}

Expected_brain_vol_percent <- 10^(mean(log(dfc4_Model_trimmed$Infarct_percent_control, base=10))) #mean stroke volume in % (2.72%)

Expected_brain_vol_mm3 <- 10^(mean(log(dfc4_Model_trimmed$Rat_infarct_volume_mm3, base=10))) #mean stroke volume in mm^3 (53.63mm^3)
Expected_brain_vol_mm3_percentage_conversion <- (100/Expected_brain_vol_mm3) #creating a number you can multiply infarct volume by to turn it into a % of average

```

```{r Checking_baselines_for_predicts, include=FALSE, eval=FALSE}
#Need to make prediction plots which use an assumed variable level as a baseline, need to select the most logical baseline or the baseline with the most complete cases for all variables

#Prediction grids use these levels:
                         # Comorbidity = "None",
                         # ET_brain_depth = "Cortical",
                         # MCA_occluded = "Yes", 
                         # ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         # ET_administration_mins = 6, #6 is both median and mode
                         # ET_administration_sites_cat = "Single site",
                         # Infarct_measure_hrs = 72, #72 is mode
                         # Infarct_measurement = "Other histology (ex vivo)",
                         # Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         # Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         # Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         # Induction_other_anaesthetics = 0, #dummy
                         # Induction_A_Not_reported = 0, #dummy
                         # weights = 8 #average n of animals = ~8

#anaesthetics all 0 which = conscious
table(dfc4_Model_trimmed$Conscious, 
      dfc4_Model_trimmed$MCA_occluded, 
      dfc4_Model_trimmed$ET_brain_depth, 
      dfc4_Model_trimmed$Comorbidity,
      dfc4_Model_trimmed$ET_administration_sites_cat,
      dfc4_Model_trimmed$Infarct_measurement) #21 experiments in "baseline" for all of these - good

```

## Categorical predict plots
```{r Comorbidity_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#Comorbidity
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Comorbidity<-expand.grid(Comorbidity = levels(dfc4_Model_trimmed$Comorbidity),
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Comorbidity_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Comorbidity)
# generate lower confidence intervals by subtracting standard errors
Comorbidity_LCI_untransformed <- Comorbidity_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Comorbidity, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Comorbidity_UCI_untransformed<-Comorbidity_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Comorbidity, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Comorbidity_predicted <- data.frame(grid_Comorbidity$Comorbidity, 
                                       10^(Comorbidity_predicted_untransformed), 
                                       10^(Comorbidity_LCI_untransformed), 
                                       10^(Comorbidity_UCI_untransformed))

# Change the column names
colnames(df_Comorbidity_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Comorbidity.correct<- df_Comorbidity_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_Comorbidity_predicted$Infarct_volume<-df_Comorbidity_predicted$Infarct_volume-Comorbidity.correct
df_Comorbidity_predicted$LCI<-df_Comorbidity_predicted$LCI-Comorbidity.correct
df_Comorbidity_predicted$UCI<-df_Comorbidity_predicted$UCI-Comorbidity.correct

#change some names to avoid conflict with similar names later on
levels(df_Comorbidity_predicted$Variable)[levels(df_Comorbidity_predicted$Variable)=="None"] <- "No Comorbidities" 


```

```{r Comorbidity_predicted_plot, include=FALSE, eval=FALSE}

pdf("Predict_cat_Comorbidity_5.pdf", width = 6, height = 3)
ggplot(data=df_Comorbidity_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + 
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[2]) + #points with error ranges style graph  
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[2]) + # Makes whiskers on the range (more aesthetically pleasing)
  coord_flip() + # flip coordinates (puts labels on y axis)  
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=20)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

```{r ET_brain_depth_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#ET_brain_depth
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_ET_brain_depth<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = levels(dfc4_Model_trimmed$ET_brain_depth),
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
ET_brain_depth_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_ET_brain_depth)
# generate lower confidence intervals by subtracting standard errors
ET_brain_depth_LCI_untransformed <- ET_brain_depth_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_ET_brain_depth, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
ET_brain_depth_UCI_untransformed<-ET_brain_depth_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_ET_brain_depth, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_ET_brain_depth_predicted <- data.frame(grid_ET_brain_depth$ET_brain_depth, 
                                       10^(ET_brain_depth_predicted_untransformed), 
                                       10^(ET_brain_depth_LCI_untransformed), 
                                       10^(ET_brain_depth_UCI_untransformed))

# Change the column names
colnames(df_ET_brain_depth_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
ET_brain_depth.correct<- df_ET_brain_depth_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_ET_brain_depth_predicted$Infarct_volume<-df_ET_brain_depth_predicted$Infarct_volume-ET_brain_depth.correct
df_ET_brain_depth_predicted$LCI<-df_ET_brain_depth_predicted$LCI-ET_brain_depth.correct
df_ET_brain_depth_predicted$UCI<-df_ET_brain_depth_predicted$UCI-ET_brain_depth.correct

```

```{r ET_brain_depth_predicted_plot, include=FALSE, eval=FALSE}

pdf("Predict_cat_brain_depth_4.pdf", width = 7, height = 3)
ggplot(data=df_ET_brain_depth_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + 
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[2]) + #points with error ranges style graph  
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[2]) + # Makes whiskers on the range (more aesthetically pleasing)
  coord_flip() + # flip coordinates (puts labels on y axis)  
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=25)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

```{r MCA_occlusion_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#MCA_occluded
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_MCA_occluded<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = levels(dfc4_Model_trimmed$MCA_occluded), 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
MCA_occluded_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_MCA_occluded)
# generate lower confidence intervals by subtracting standard errors
MCA_occluded_LCI_untransformed <- MCA_occluded_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_MCA_occluded, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
MCA_occluded_UCI_untransformed<-MCA_occluded_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_MCA_occluded, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_MCA_occluded_predicted <- data.frame(grid_MCA_occluded$MCA_occluded, 
                                       10^(MCA_occluded_predicted_untransformed), 
                                       10^(MCA_occluded_LCI_untransformed), 
                                       10^(MCA_occluded_UCI_untransformed))

# Change the column names
colnames(df_MCA_occluded_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
MCA_occluded.correct<- df_MCA_occluded_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_MCA_occluded_predicted$Infarct_volume<-df_MCA_occluded_predicted$Infarct_volume-MCA_occluded.correct
df_MCA_occluded_predicted$LCI<-df_MCA_occluded_predicted$LCI-MCA_occluded.correct
df_MCA_occluded_predicted$UCI<-df_MCA_occluded_predicted$UCI-MCA_occluded.correct

#change some names to avoid conflict with similar names later on
levels(df_MCA_occluded_predicted$Variable)[levels(df_MCA_occluded_predicted$Variable)=="Yes"] <- "MCA occluded" 
levels(df_MCA_occluded_predicted$Variable)[levels(df_MCA_occluded_predicted$Variable)=="No"] <- "MCA not occluded" 
levels(df_MCA_occluded_predicted$Variable)[levels(df_MCA_occluded_predicted$Variable)=="Not reported"] <- "Occlusion location not reported" 


```

```{r MCA_occlusion_predicted_plot, include=FALSE, eval=FALSE}

pdf("Predict_cat_MCA_occlusion_4.pdf", width = 7, height = 3)
ggplot(data=df_MCA_occluded_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + 
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[2]) + #points with error ranges style graph  
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[2]) + # Makes whiskers on the range (more aesthetically pleasing)
  coord_flip() + # flip coordinates (puts labels on y axis)  
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=20)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()


```

```{r Infarct_measurement_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#Infarct_measurement
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Infarct_measurement<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = levels(dfc4_Model_trimmed$Infarct_measurement),
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Infarct_measurement_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Infarct_measurement)
# generate lower confidence intervals by subtracting standard errors
Infarct_measurement_LCI_untransformed <- Infarct_measurement_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Infarct_measurement, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Infarct_measurement_UCI_untransformed<-Infarct_measurement_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Infarct_measurement, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Infarct_measurement_predicted <- data.frame(grid_Infarct_measurement$Infarct_measurement, 
                                       10^(Infarct_measurement_predicted_untransformed), 
                                       10^(Infarct_measurement_LCI_untransformed), 
                                       10^(Infarct_measurement_UCI_untransformed))

# Change the column names
colnames(df_Infarct_measurement_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Infarct_measurement.correct<- df_Infarct_measurement_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_Infarct_measurement_predicted$Infarct_volume<-df_Infarct_measurement_predicted$Infarct_volume-Infarct_measurement.correct
df_Infarct_measurement_predicted$LCI<-df_Infarct_measurement_predicted$LCI-Infarct_measurement.correct
df_Infarct_measurement_predicted$UCI<-df_Infarct_measurement_predicted$UCI-Infarct_measurement.correct

#change some names to avoid conflict with similar names later on
levels(df_Infarct_measurement_predicted$Variable)[levels(df_Infarct_measurement_predicted$Variable)=="Other histology (ex vivo)"] <- "Other histology" 
levels(df_Infarct_measurement_predicted$Variable)[levels(df_Infarct_measurement_predicted$Variable)=="TTC (ex vivo)"] <- "TTC" 
levels(df_Infarct_measurement_predicted$Variable)[levels(df_Infarct_measurement_predicted$Variable)=="MRI (in vivo)"] <- "MRI" 


```

```{r Infarct_measurement_predicted_plot, include=FALSE, eval=FALSE}

pdf("Predict_cat_measurement_method_4.pdf", width = 6, height = 3)
ggplot(data=df_Infarct_measurement_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + 
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[2]) + #points with error ranges style graph  
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[2]) + # Makes whiskers on the range (more aesthetically pleasing)
  coord_flip() + # flip coordinates (puts labels on y axis)  
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,800,by=50)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

```{r ET_administration_sites_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#ET_administration_sites
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_ET_administration_sites<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = levels(dfc4_Model_trimmed$ET_administration_sites_cat), #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
ET_administration_sites_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_ET_administration_sites)
# generate lower confidence intervals by subtracting standard errors
ET_administration_sites_LCI_untransformed <- ET_administration_sites_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_ET_administration_sites, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
ET_administration_sites_UCI_untransformed<-ET_administration_sites_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_ET_administration_sites, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_ET_administration_sites_predicted <- data.frame(grid_ET_administration_sites$ET_administration_sites_cat, 
                                       10^(ET_administration_sites_predicted_untransformed), 
                                       10^(ET_administration_sites_LCI_untransformed), 
                                       10^(ET_administration_sites_UCI_untransformed))

# Change the column names
colnames(df_ET_administration_sites_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
ET_administration_sites.correct<- df_ET_administration_sites_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_ET_administration_sites_predicted$Infarct_volume<-df_ET_administration_sites_predicted$Infarct_volume-ET_administration_sites.correct
df_ET_administration_sites_predicted$LCI<-df_ET_administration_sites_predicted$LCI-ET_administration_sites.correct
df_ET_administration_sites_predicted$UCI<-df_ET_administration_sites_predicted$UCI-ET_administration_sites.correct


```

```{r ET_administration_sites_predicted_plot, include=FALSE, eval=FALSE}

pdf("Predict_cat_ET_administration_sites_4.pdf", width = 6.5, height = 2.5)
ggplot(data=df_ET_administration_sites_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + 
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[2]) + #points with error ranges style graph  
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[2]) + # Makes whiskers on the range (more aesthetically pleasing)
  coord_flip() + # flip coordinates (puts labels on y axis)  
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=5)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

```{r Conscious_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3
#using alternate linear model with consciousness instead of anaesthetic

#lm_transformed_alternate_conscious
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Conscious<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         # Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         # Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         # Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         # Induction_other_anaesthetics = 0, #dummy
                         # Induction_A_Not_reported = 0, #dummy
                         Conscious = levels(dfc4_Model_trimmed$Conscious),
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Conscious_predicted_untransformed <- predict(lm_transformed_alternate_conscious, newdata=grid_Conscious)
# generate lower confidence intervals by subtracting standard errors
Conscious_LCI_untransformed <- Conscious_predicted_untransformed-predict(lm_transformed_alternate_conscious, newdata=grid_Conscious, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Conscious_UCI_untransformed<-Conscious_predicted_untransformed+predict(lm_transformed_alternate_conscious, newdata=grid_Conscious, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Conscious_predicted <- data.frame(grid_Conscious$Conscious, 
                                       10^(Conscious_predicted_untransformed), 
                                       10^(Conscious_LCI_untransformed), 
                                       10^(Conscious_UCI_untransformed))

# Change the column names
colnames(df_Conscious_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Conscious.correct<- df_Conscious_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_Conscious_predicted$Infarct_volume<-df_Conscious_predicted$Infarct_volume-Conscious.correct
df_Conscious_predicted$LCI<-df_Conscious_predicted$LCI-Conscious.correct
df_Conscious_predicted$UCI<-df_Conscious_predicted$UCI-Conscious.correct


```

```{r Conscious_predicted_plot, include=FALSE, eval=FALSE}

pdf("Predict_cat_Conscious_4.pdf", width = 6, height = 3)
ggplot(data=df_Conscious_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + 
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[2]) + #points with error ranges style graph  
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[2]) + # Makes whiskers on the range (more aesthetically pleasing)
  coord_flip() + # flip coordinates (puts labels on y axis)  
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=10)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

## Anaesthetic predict plot
```{r Induction_anaesthetics_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#Induction_Halothane
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Halothane<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 1, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Halothane_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_Halothane)
# generate lower confidence intervals by subtracting standard errors
Induction_Halothane_LCI_untransformed <- Induction_Halothane_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_Halothane, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Halothane_UCI_untransformed<-Induction_Halothane_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_Halothane, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Halothane_predicted <- data.frame(grid_Induction_Halothane$Induction_Halothane, 
                                       10^(Induction_Halothane_predicted_untransformed), 
                                       10^(Induction_Halothane_LCI_untransformed), 
                                       10^(Induction_Halothane_UCI_untransformed))

# Change the column names
colnames(df_Induction_Halothane_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Halothane_predicted[1,1] <- "Halothane" #row one column one


#Induction_Isoflurane
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Isoflurane<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 1, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Isoflurane_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_Isoflurane)
# generate lower confidence intervals by subtracting standard errors
Induction_Isoflurane_LCI_untransformed <- Induction_Isoflurane_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_Isoflurane, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Isoflurane_UCI_untransformed<-Induction_Isoflurane_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_Isoflurane, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Isoflurane_predicted <- data.frame(grid_Induction_Isoflurane$Induction_Isoflurane, 
                                       10^(Induction_Isoflurane_predicted_untransformed), 
                                       10^(Induction_Isoflurane_LCI_untransformed), 
                                       10^(Induction_Isoflurane_UCI_untransformed))

# Change the column names
colnames(df_Induction_Isoflurane_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Isoflurane_predicted[1,1] <- "Isoflurane" #row one column one


#Induction_Ketamine
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Ketamine<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 1, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Ketamine_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_Ketamine)
# generate lower confidence intervals by subtracting standard errors
Induction_Ketamine_LCI_untransformed <- Induction_Ketamine_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_Ketamine, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Ketamine_UCI_untransformed<-Induction_Ketamine_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_Ketamine, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Ketamine_predicted <- data.frame(grid_Induction_Ketamine$Induction_Ketamine, 
                                       10^(Induction_Ketamine_predicted_untransformed), 
                                       10^(Induction_Ketamine_LCI_untransformed), 
                                       10^(Induction_Ketamine_UCI_untransformed))

# Change the column names
colnames(df_Induction_Ketamine_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Ketamine_predicted[1,1] <- "Ketamine" #row one column one


#Induction_Nitrous_oxide
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Nitrous_oxide<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 1, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Nitrous_oxide_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_Nitrous_oxide)
# generate lower confidence intervals by subtracting standard errors
Induction_Nitrous_oxide_LCI_untransformed <- Induction_Nitrous_oxide_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_Nitrous_oxide, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Nitrous_oxide_UCI_untransformed<-Induction_Nitrous_oxide_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_Nitrous_oxide, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Nitrous_oxide_predicted <- data.frame(grid_Induction_Nitrous_oxide$Induction_Nitrous_oxide, 
                                       10^(Induction_Nitrous_oxide_predicted_untransformed), 
                                       10^(Induction_Nitrous_oxide_LCI_untransformed), 
                                       10^(Induction_Nitrous_oxide_UCI_untransformed))

# Change the column names
colnames(df_Induction_Nitrous_oxide_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Nitrous_oxide_predicted[1,1] <- "Nitrous oxide" #row one column one


#Induction_Sevoflurane
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Sevoflurane<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 1, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Sevoflurane_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_Sevoflurane)
# generate lower confidence intervals by subtracting standard errors
Induction_Sevoflurane_LCI_untransformed <- Induction_Sevoflurane_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_Sevoflurane, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Sevoflurane_UCI_untransformed<-Induction_Sevoflurane_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_Sevoflurane, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Sevoflurane_predicted <- data.frame(grid_Induction_Sevoflurane$Induction_Sevoflurane, 
                                       10^(Induction_Sevoflurane_predicted_untransformed), 
                                       10^(Induction_Sevoflurane_LCI_untransformed), 
                                       10^(Induction_Sevoflurane_UCI_untransformed))

# Change the column names
colnames(df_Induction_Sevoflurane_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Sevoflurane_predicted[1,1] <- "Sevoflurane" #row one column one


#Induction_Sodium_Pentobarbital
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Sodium_Pentobarbital<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 1, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Sodium_Pentobarbital_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_Sodium_Pentobarbital)
# generate lower confidence intervals by subtracting standard errors
Induction_Sodium_Pentobarbital_LCI_untransformed <- Induction_Sodium_Pentobarbital_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_Sodium_Pentobarbital, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Sodium_Pentobarbital_UCI_untransformed<-Induction_Sodium_Pentobarbital_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_Sodium_Pentobarbital, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Sodium_Pentobarbital_predicted <- data.frame(grid_Induction_Sodium_Pentobarbital$Induction_Sodium_Pentobarbital, 
                                       10^(Induction_Sodium_Pentobarbital_predicted_untransformed), 
                                       10^(Induction_Sodium_Pentobarbital_LCI_untransformed), 
                                       10^(Induction_Sodium_Pentobarbital_UCI_untransformed))

# Change the column names
colnames(df_Induction_Sodium_Pentobarbital_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Sodium_Pentobarbital_predicted[1,1] <- "Sodium pentobarbital" #row one column one


# #Induction_Tribromoethanol
# #make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
# grid_Induction_Tribromoethanol<-expand.grid(Comorbidity = "None",
#                          ET_brain_depth = "Cortical",
#                          MCA_occluded = "Yes", 
#                          ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
#                          ET_administration_mins = 6, #6 is both median and mode
#                          ET_administration_sites_cat = "Single site", #1 is both median and mode
#                          Infarct_measure_hrs = 72, #72 is mode
#                          Infarct_measurement = "Other histology (ex vivo)",
#                          Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
#                          Induction_Isoflurane = 0, #dummy
#                          Induction_Ketamine = 0, #dummy
#                          Induction_Nitrous_oxide = 0, #dummy
#                          Induction_Sevoflurane = 0, #dummy
#                          Induction_Sodium_Pentobarbital = 0, #dummy
#                          Induction_Tribromoethanol = 1, #dummy
#                          Induction_Xylazine = 0, #dummy
#                          Induction_other_anaesthetics = 0, #dummy
#                          Induction_A_Not_reported = 0, #dummy
#                          weights = 8) #average n of animals = ~8
#                          
# # generate predicted values from our model
# Induction_Tribromoethanol_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_Tribromoethanol)
# # generate lower confidence intervals by subtracting standard errors
# Induction_Tribromoethanol_LCI_untransformed <- Induction_Tribromoethanol_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_Tribromoethanol, se=T)$se.fit
# # generate upper confidence intervals by adding standard errors
# Induction_Tribromoethanol_UCI_untransformed<-Induction_Tribromoethanol_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_Tribromoethanol, se=T)$se.fit
# # generate new dataframe for these untransformed predicted values, and transform them
# df_Induction_Tribromoethanol_predicted <- data.frame(grid_Induction_Tribromoethanol$Induction_Tribromoethanol, 
#                                        10^(Induction_Tribromoethanol_predicted_untransformed), 
#                                        10^(Induction_Tribromoethanol_LCI_untransformed), 
#                                        10^(Induction_Tribromoethanol_UCI_untransformed))
# 
# # Change the column names
# colnames(df_Induction_Tribromoethanol_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
# #Change dummy variable name to anaesthetic name
# df_Induction_Tribromoethanol_predicted[1,1] <- "Tribromoethanol" #row one column one

#Induction_Xylazine
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Xylazine<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 1, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Xylazine_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_Xylazine)
# generate lower confidence intervals by subtracting standard errors
Induction_Xylazine_LCI_untransformed <- Induction_Xylazine_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_Xylazine, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Xylazine_UCI_untransformed<-Induction_Xylazine_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_Xylazine, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Xylazine_predicted <- data.frame(grid_Induction_Xylazine$Induction_Xylazine, 
                                       10^(Induction_Xylazine_predicted_untransformed), 
                                       10^(Induction_Xylazine_LCI_untransformed), 
                                       10^(Induction_Xylazine_UCI_untransformed))

# Change the column names
colnames(df_Induction_Xylazine_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Xylazine_predicted[1,1] <- "Xylazine" #row one column one


#Induction_other_anaesthetics
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_other_anaesthetics<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 1, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_other_anaesthetics_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_other_anaesthetics)
# generate lower confidence intervals by subtracting standard errors
Induction_other_anaesthetics_LCI_untransformed <- Induction_other_anaesthetics_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_other_anaesthetics, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_other_anaesthetics_UCI_untransformed<-Induction_other_anaesthetics_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_other_anaesthetics, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_other_anaesthetics_predicted <- data.frame(grid_Induction_other_anaesthetics$Induction_other_anaesthetics, 
                                       10^(Induction_other_anaesthetics_predicted_untransformed), 
                                       10^(Induction_other_anaesthetics_LCI_untransformed), 
                                       10^(Induction_other_anaesthetics_UCI_untransformed))

# Change the column names
colnames(df_Induction_other_anaesthetics_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_other_anaesthetics_predicted[1,1] <- "Other anaesthetics" #row one column one


#Induction_A_Not_reported
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_A_Not_reported<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 1, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_A_Not_reported_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_A_Not_reported)
# generate lower confidence intervals by subtracting standard errors
Induction_A_Not_reported_LCI_untransformed <- Induction_A_Not_reported_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_A_Not_reported, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_A_Not_reported_UCI_untransformed<-Induction_A_Not_reported_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_A_Not_reported, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_A_Not_reported_predicted <- data.frame(grid_Induction_A_Not_reported$Induction_A_Not_reported, 
                                       10^(Induction_A_Not_reported_predicted_untransformed), 
                                       10^(Induction_A_Not_reported_LCI_untransformed), 
                                       10^(Induction_A_Not_reported_UCI_untransformed))

# Change the column names
colnames(df_Induction_A_Not_reported_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_A_Not_reported_predicted[1,1] <- "Anaesthetic not reported" #row one column one

#No anaesthetics prediction
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_No_anaesthetic<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_No_anaesthetic_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Induction_No_anaesthetic)
# generate lower confidence intervals by subtracting standard errors
Induction_No_anaesthetic_LCI_untransformed <- Induction_No_anaesthetic_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Induction_No_anaesthetic, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_No_anaesthetic_UCI_untransformed<-Induction_No_anaesthetic_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Induction_No_anaesthetic, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_No_anaesthetic_predicted <- data.frame(grid_Induction_No_anaesthetic$Induction_Halothane,#just need this to be a zero, there is no actual variable in the model or grid for no anaesthetics, but any other anaesthetic is a 0
                                       10^(Induction_No_anaesthetic_predicted_untransformed), 
                                       10^(Induction_No_anaesthetic_LCI_untransformed), 
                                       10^(Induction_No_anaesthetic_UCI_untransformed))

# Change the column names
colnames(df_Induction_No_anaesthetic_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_No_anaesthetic_predicted[1,1] <- "No anaesthetic (conscious)" #row one column one

```

```{r Combined_anaesthetic_dataframe, include=FALSE}

#combine all anaesthetics into one dataframe
df_Anaesthetics_predicted <- rbind(df_Induction_No_anaesthetic_predicted,
                                   df_Induction_Halothane_predicted,
                                   df_Induction_Isoflurane_predicted,
                                   df_Induction_Ketamine_predicted,
                                   df_Induction_Nitrous_oxide_predicted,
                                   df_Induction_Sevoflurane_predicted,
                                   df_Induction_Sodium_Pentobarbital_predicted,
                                   #df_Induction_Tribromoethanol_predicted,
                                   df_Induction_Xylazine_predicted,
                                   df_Induction_other_anaesthetics_predicted,
                                   df_Induction_A_Not_reported_predicted)

rownames(df_Anaesthetics_predicted) <- 1:nrow(df_Anaesthetics_predicted) #fix rownames to 1-10

Anaesthetics_predicted_case.correct<- df_Anaesthetics_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#normalising to "no anaesthetic"
df_Anaesthetics_predicted$Infarct_volume<-df_Anaesthetics_predicted$Infarct_volume-Anaesthetics_predicted_case.correct
df_Anaesthetics_predicted$LCI<-df_Anaesthetics_predicted$LCI-Anaesthetics_predicted_case.correct
df_Anaesthetics_predicted$UCI<-df_Anaesthetics_predicted$UCI-Anaesthetics_predicted_case.correct

```

```{r Induction_anaesthetics_predicted_plot, include=FALSE, eval=FALSE}}
# Order levels for graph:
df_Anaesthetics_predicted$Variable <- factor(df_Anaesthetics_predicted$Variable, levels =
                                                                       c("No anaesthetic (conscious)",
                                                                         "Halothane",
                                                                         "Isoflurane",
                                                                         "Ketamine",
                                                                         "Nitrous oxide",
                                                                         "Sevoflurane",
                                                                         "Sodium pentobarbital",
                                                                         #"Tribromoethanol",
                                                                         "Xylazine",
                                                                         "Other anaesthetics",
                                                                         "Anaesthetic not reported"))
pdf("Predict_cat_anaesthetics_5.pdf", width = 7, height = 7)
ggplot(data=df_Anaesthetics_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + 
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[2]) + #points with error ranges style graph  
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[2]) + # Makes whiskers on the range (more aesthetically pleasing)
  coord_flip() + # flip coordinates (puts labels on y axis)  
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=50)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

## Continuous predict plots
```{r ET_dose_pmol_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#ET_dose_pmol
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_ET_dose_pmol<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = seq(0.08, 4800, by=10), #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site",
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
ET_dose_pmol_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_ET_dose_pmol)
# generate lower confidence intervals by subtracting standard errors
ET_dose_pmol_LCI_untransformed <- ET_dose_pmol_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_ET_dose_pmol, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
ET_dose_pmol_UCI_untransformed<-ET_dose_pmol_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_ET_dose_pmol, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_ET_dose_pmol_predicted <- data.frame(grid_ET_dose_pmol$ET_dose_pmol, 
                                       10^(ET_dose_pmol_predicted_untransformed), 
                                       10^(ET_dose_pmol_LCI_untransformed), 
                                       10^(ET_dose_pmol_UCI_untransformed))

# Change the column names
colnames(df_ET_dose_pmol_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
ET_dose_pmol.correct<- df_ET_dose_pmol_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_ET_dose_pmol_predicted$Infarct_volume<-df_ET_dose_pmol_predicted$Infarct_volume-ET_dose_pmol.correct
df_ET_dose_pmol_predicted$LCI<-df_ET_dose_pmol_predicted$LCI-ET_dose_pmol.correct
df_ET_dose_pmol_predicted$UCI<-df_ET_dose_pmol_predicted$UCI-ET_dose_pmol.correct


```

```{r ET_dose_pmol_predicted_plot, include=FALSE, eval=FALSE}

pdf("Predict_cont_ETdose_4.pdf", width = 6.5, height = 5)
ggplot(df_ET_dose_pmol_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion)) +
  geom_hline(yintercept=0, lty=2, size =1) +  
  geom_ribbon(aes(ymax=UCI*Expected_brain_vol_mm3_percentage_conversion, 
                  ymin=LCI*Expected_brain_vol_mm3_percentage_conversion), 
              alpha=0.4,
              fill=mako(5)[2]) +
  geom_line(color="#292829", size=1.5) +
  scale_y_continuous(breaks=seq(-100,25,by=10)) +
  scale_x_continuous(breaks=seq(0,4800,by=500)) +
  theme_classic() +
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Label Axis   
  labs(x = "Dose of Endothelin-1 (pmol)",
       y = "% of average infarct volume")+
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Adjust axis font sizes and font colour   
  theme(axis.title = element_text(size = 13), 
        axis.text.x = element_text(size=13, color="black"), 
        axis.text.y = element_text(size=13, color="black")) +  
  #Make ticks black   
  theme(axis.ticks=element_line(color="black", lineend = "square")) 
dev.off()

```

```{r ET_administration_mins_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3
summary(dfc4_Model_trimmed$ET_administration_mins)
#ET_administration_mins
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_ET_administration_mins<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = seq(0.25, 30, by=0.25), #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
ET_administration_mins_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_ET_administration_mins)
# generate lower confidence intervals by subtracting standard errors
ET_administration_mins_LCI_untransformed <- ET_administration_mins_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_ET_administration_mins, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
ET_administration_mins_UCI_untransformed<-ET_administration_mins_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_ET_administration_mins, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_ET_administration_mins_predicted <- data.frame(grid_ET_administration_mins$ET_administration_mins, 
                                       10^(ET_administration_mins_predicted_untransformed), 
                                       10^(ET_administration_mins_LCI_untransformed), 
                                       10^(ET_administration_mins_UCI_untransformed))

# Change the column names
colnames(df_ET_administration_mins_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
ET_administration_mins.correct<- df_ET_administration_mins_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_ET_administration_mins_predicted$Infarct_volume<-df_ET_administration_mins_predicted$Infarct_volume-ET_administration_mins.correct
df_ET_administration_mins_predicted$LCI<-df_ET_administration_mins_predicted$LCI-ET_administration_mins.correct
df_ET_administration_mins_predicted$UCI<-df_ET_administration_mins_predicted$UCI-ET_administration_mins.correct


```

```{r ET_administration_mins_predicted_plot, include=FALSE, eval=FALSE}

pdf("Predict_cont_ETduration_4.pdf", width = 6.5, height = 5)
ggplot(df_ET_administration_mins_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion)) +
  geom_hline(yintercept=0, lty=2, size =1) +  
  geom_ribbon(aes(ymax=UCI*Expected_brain_vol_mm3_percentage_conversion, 
                  ymin=LCI*Expected_brain_vol_mm3_percentage_conversion), 
              alpha=0.4,
              fill=mako(5)[2]) +
  geom_line(color="#292829", size=1.5) +
  scale_y_continuous(breaks=seq(-20,120,by=10)) +
  scale_x_continuous(breaks=seq(0,30,by=5)) +
  theme_classic() +
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Label Axis   
  labs(x = "Duration of Endothelin-1 application (minutes)",
       y = "% of average infarct volume")+
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Adjust axis font sizes and font colour   
  theme(axis.title = element_text(size = 13), 
        axis.text.x = element_text(size=13, color="black"), 
        axis.text.y = element_text(size=13, color="black")) +  
  #Make ticks black   
  theme(axis.ticks=element_line(color="black", lineend = "square")) 
dev.off()

```

```{r Infarct_measure_hrs_dataframe, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3
summary(dfc4_Model_trimmed$Infarct_measure_hrs)
#Infarct_measure_hrs
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Infarct_measure_hrs<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = seq(24, 2184, by=12), #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Infarct_measure_hrs_predicted_untransformed <- predict(lm_transformed_trimmed, newdata=grid_Infarct_measure_hrs)
# generate lower confidence intervals by subtracting standard errors
Infarct_measure_hrs_LCI_untransformed <- Infarct_measure_hrs_predicted_untransformed-predict(lm_transformed_trimmed, newdata=grid_Infarct_measure_hrs, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Infarct_measure_hrs_UCI_untransformed<-Infarct_measure_hrs_predicted_untransformed+predict(lm_transformed_trimmed, newdata=grid_Infarct_measure_hrs, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Infarct_measure_hrs_predicted <- data.frame(grid_Infarct_measure_hrs$Infarct_measure_hrs, 
                                       10^(Infarct_measure_hrs_predicted_untransformed), 
                                       10^(Infarct_measure_hrs_LCI_untransformed), 
                                       10^(Infarct_measure_hrs_UCI_untransformed))

# Change the column names
colnames(df_Infarct_measure_hrs_predicted)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Infarct_measure_hrs.correct<- df_Infarct_measure_hrs_predicted[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_Infarct_measure_hrs_predicted$Infarct_volume<-df_Infarct_measure_hrs_predicted$Infarct_volume-Infarct_measure_hrs.correct
df_Infarct_measure_hrs_predicted$LCI<-df_Infarct_measure_hrs_predicted$LCI-Infarct_measure_hrs.correct
df_Infarct_measure_hrs_predicted$UCI<-df_Infarct_measure_hrs_predicted$UCI-Infarct_measure_hrs.correct


```

```{r Infarct_measure_hrs_predicted_plot_old, include=FALSE, eval=FALSE}

pdf("Predict_cont_Infarct_measure_time_4.pdf", width = 6.5, height = 5)
ggplot(df_Infarct_measure_hrs_predicted, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion)) +
  geom_hline(yintercept=0, lty=2, size =1) +  
  geom_ribbon(aes(ymax=UCI*Expected_brain_vol_mm3_percentage_conversion, 
                  ymin=LCI*Expected_brain_vol_mm3_percentage_conversion), 
              alpha=0.4,
              fill=mako(5)[2]) +
  geom_line(color="#292829", size=1.5) +
  scale_y_continuous(breaks=seq(-20,210,by=20)) +
  scale_x_continuous(breaks=seq(24,2184,by=144)) +
  theme_classic() +
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Label Axis   
  labs(x = "Time infarct was measured (hours post-stroke)",
       y = "% of average infarct volume")+
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Adjust axis font sizes and font colour   
  theme(axis.title = element_text(size = 13), 
        axis.text.x = element_text(size=13, color="black"), 
        axis.text.y = element_text(size=13, color="black")) +  
  #Make ticks black   
  theme(axis.ticks=element_line(color="black", lineend = "square")) 
dev.off()

```

```{r Infarct_measure_hrs_x_method_predictions, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3
summary(dfc4_Model_trimmed$Infarct_measure_hrs)
#Infarct_measure_hrs x other histology predictions = same df as above: "df_Infarct_measure_hrs_predicted"

#Infarct_measure_hrs x TTC predictions - max out at 500 hours
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Infarct_measure_hrs_ttc<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = seq(24, 500, by=12), #72 is mode
                         Infarct_measurement = "TTC (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Infarct_measure_hrs_predicted_untransformed_ttc <- predict(lm_transformed_trimmed, newdata=grid_Infarct_measure_hrs_ttc)
# generate lower confidence intervals by subtracting standard errors
Infarct_measure_hrs_LCI_untransformed_ttc <- Infarct_measure_hrs_predicted_untransformed_ttc-predict(lm_transformed_trimmed, newdata=grid_Infarct_measure_hrs_ttc, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Infarct_measure_hrs_UCI_untransformed_ttc<-Infarct_measure_hrs_predicted_untransformed_ttc+predict(lm_transformed_trimmed, newdata=grid_Infarct_measure_hrs_ttc, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Infarct_measure_hrs_predicted_ttc <- data.frame(grid_Infarct_measure_hrs_ttc$Infarct_measure_hrs, 
                                       10^(Infarct_measure_hrs_predicted_untransformed_ttc), 
                                       10^(Infarct_measure_hrs_LCI_untransformed_ttc), 
                                       10^(Infarct_measure_hrs_UCI_untransformed_ttc))

# Change the column names
colnames(df_Infarct_measure_hrs_predicted_ttc)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Infarct_measure_hrs.correct_ttc<- df_Infarct_measure_hrs_predicted_ttc[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 (of other histology, not ttc)
df_Infarct_measure_hrs_predicted_ttc$Infarct_volume<-df_Infarct_measure_hrs_predicted_ttc$Infarct_volume-Infarct_measure_hrs.correct
df_Infarct_measure_hrs_predicted_ttc$LCI<-df_Infarct_measure_hrs_predicted_ttc$LCI-Infarct_measure_hrs.correct
df_Infarct_measure_hrs_predicted_ttc$UCI<-df_Infarct_measure_hrs_predicted_ttc$UCI-Infarct_measure_hrs.correct



#Infarct_measure_hrs x MRI predictions - max out at 500 hours
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Infarct_measure_hrs_mri<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol = 200, #200 is 3rd most popular and is close to median of 240
                         ET_administration_mins = 6, #6 is both median and mode
                         ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = seq(24, 500, by=12), #72 is mode
                         Infarct_measurement = "MRI (in vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         Induction_Isoflurane = 0, #dummy
                         Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         #Induction_Tribromoethanol = 0, #dummy
                         Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Infarct_measure_hrs_predicted_untransformed_mri <- predict(lm_transformed_trimmed, newdata=grid_Infarct_measure_hrs_mri)
# generate lower confidence intervals by subtracting standard errors
Infarct_measure_hrs_LCI_untransformed_mri <- Infarct_measure_hrs_predicted_untransformed_mri-predict(lm_transformed_trimmed, newdata=grid_Infarct_measure_hrs_mri, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Infarct_measure_hrs_UCI_untransformed_mri<-Infarct_measure_hrs_predicted_untransformed_mri+predict(lm_transformed_trimmed, newdata=grid_Infarct_measure_hrs_mri, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Infarct_measure_hrs_predicted_mri <- data.frame(grid_Infarct_measure_hrs_mri$Infarct_measure_hrs, 
                                       10^(Infarct_measure_hrs_predicted_untransformed_mri), 
                                       10^(Infarct_measure_hrs_LCI_untransformed_mri), 
                                       10^(Infarct_measure_hrs_UCI_untransformed_mri))

# Change the column names
colnames(df_Infarct_measure_hrs_predicted_mri)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Infarct_measure_hrs.correct_mri<- df_Infarct_measure_hrs_predicted_mri[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 (of other histology, not mri)
df_Infarct_measure_hrs_predicted_mri$Infarct_volume<-df_Infarct_measure_hrs_predicted_mri$Infarct_volume-Infarct_measure_hrs.correct
df_Infarct_measure_hrs_predicted_mri$LCI<-df_Infarct_measure_hrs_predicted_mri$LCI-Infarct_measure_hrs.correct
df_Infarct_measure_hrs_predicted_mri$UCI<-df_Infarct_measure_hrs_predicted_mri$UCI-Infarct_measure_hrs.correct


```

```{r Infarct_measure_hrs_x_method_dataframe, include=FALSE}

#make new dataframes for edits
df_Infarct_measure_hrs_predicted_2 <- df_Infarct_measure_hrs_predicted
df_Infarct_measure_hrs_predicted_ttc_2 <- df_Infarct_measure_hrs_predicted_ttc
df_Infarct_measure_hrs_predicted_mri_2 <- df_Infarct_measure_hrs_predicted_mri

#add a category column to separate them
df_Infarct_measure_hrs_predicted_2$Category<-rep("Other histology", nrow(df_Infarct_measure_hrs_predicted_2)) 
df_Infarct_measure_hrs_predicted_ttc_2$Category<-rep("TTC", nrow(df_Infarct_measure_hrs_predicted_ttc_2)) 
df_Infarct_measure_hrs_predicted_mri_2$Category<-rep("MRI", nrow(df_Infarct_measure_hrs_predicted_mri_2)) 

#combine into one data frame
df_Infarct_measure_hrs_x_method_predicted <- rbind(df_Infarct_measure_hrs_predicted_2,
                                                   df_Infarct_measure_hrs_predicted_ttc_2,
                                                   df_Infarct_measure_hrs_predicted_mri_2)

```

```{r Infarct_measure_hrs_x_method_predicted_plot, include=FALSE, eval=FALSE}

mako_colours <- c(viridis(6, option = "mako")[3:5])

pdf("Predict_cont_Infarct_measure_time_x_method_4.pdf", width = 10, height = 5)
ggplot(df_Infarct_measure_hrs_x_method_predicted, aes(x=(Variable/24), y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion,
                                                      fill = Category)) + #divide by 24 to turn hrs into days
  geom_ribbon(aes(ymax=UCI*Expected_brain_vol_mm3_percentage_conversion, 
                  ymin=LCI*Expected_brain_vol_mm3_percentage_conversion), 
              alpha=0.8) +
  #scale_fill_viridis_d(option = "mako") +
  scale_fill_manual(values = mako_colours, name = "Measurement method") + #for colouring ribbon
  #scale_colour_manual(values = mako_colours, name = "Measurement method") + #for coloured lines on edge of ribbon (+ colour = category in ggplot)
  geom_line(color="#292829", size=1) +
  geom_hline(yintercept=0, lty=2, size =1) +
  scale_y_continuous(breaks=seq(-300,1000,by=100)) +
  scale_x_continuous(breaks=seq(0,96,by=7)) +
  theme_classic() +
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Label Axis   
  labs(x = "Time infarct was measured (days post-stroke)",
       legend = "Measurement method",
       y = "% of average infarct volume")+
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Adjust axis font sizes and font colour   
  theme(axis.title = element_text(size = 13), 
        axis.text.x = element_text(size=13, color="black"), 
        axis.text.y = element_text(size=13, color="black")) +  
  #Make ticks black   
  theme(axis.ticks=element_line(color="black", lineend = "square")) 
dev.off()

```



# Post hoc tests for full linear model

```{r Comorbidity_post_hoc, include=FALSE, eval=FALSE}

Comorbidity_LM = ref_grid(lm_transformed_trimmed, 
  non.nuisance = "Comorbidity")
#Posthoc/Planned contrasts 
Comorbidity_raw_posthoc <- lsmeans(
  Comorbidity_LM, pairwise ~ Comorbidity, adjust="tukey") 

Comorbidity_posthoc<-summary(Comorbidity_raw_posthoc) 

Comorbidity_p_value<-data.frame(cbind(
  Comorbidity_posthoc$contrasts[,-4]))


#View the table in a pretty way
tab_df(Comorbidity_p_value,digits = 4,
  file = "Posthoc_Comorbidity_table_3.html")  

```

```{r ET_brain_depth_post_hoc, include=FALSE, eval=FALSE}

ET_brain_depth_LM = ref_grid(lm_transformed_trimmed, 
  non.nuisance = "ET_brain_depth")
#Posthoc/Planned contrasts 
ET_brain_depth_raw_posthoc <- lsmeans(
  ET_brain_depth_LM, pairwise ~ ET_brain_depth, adjust="tukey") 

ET_brain_depth_posthoc<-summary(ET_brain_depth_raw_posthoc) 

ET_brain_depth_p_value<-data.frame(cbind(
  ET_brain_depth_posthoc$contrasts[,-4]))


#View the table in a pretty way
tab_df(ET_brain_depth_p_value,digits = 4,
  file = "Posthoc_ET_brain_depth_table_3.html")  

```

```{r MCA_occluded_post_hoc, include=FALSE, eval=FALSE}

MCA_occluded_LM = ref_grid(lm_transformed_trimmed, 
  non.nuisance = "MCA_occluded")
#Posthoc/Planned contrasts 
MCA_occluded_raw_posthoc <- lsmeans(
  MCA_occluded_LM, pairwise ~ MCA_occluded, adjust="tukey") 

MCA_occluded_posthoc<-summary(MCA_occluded_raw_posthoc) 

MCA_occluded_p_value<-data.frame(cbind(
  MCA_occluded_posthoc$contrasts[,-4]))


#View the table in a pretty way
tab_df(MCA_occluded_p_value,digits = 4,
  file = "Posthoc_MCA_occluded_table_3.html")  

```

```{r ET_administration_sites_cat_post_hoc, include=FALSE, eval=FALSE}

ET_administration_sites_cat_LM = ref_grid(lm_transformed_trimmed, 
  non.nuisance = "ET_administration_sites_cat")
#Posthoc/Planned contrasts 
ET_administration_sites_cat_raw_posthoc <- lsmeans(
  ET_administration_sites_cat_LM, pairwise ~ ET_administration_sites_cat, adjust="tukey") 

ET_administration_sites_cat_posthoc<-summary(ET_administration_sites_cat_raw_posthoc) 

ET_administration_sites_cat_p_value<-data.frame(cbind(
  ET_administration_sites_cat_posthoc$contrasts[,-4]))


#View the table in a pretty way
tab_df(ET_administration_sites_cat_p_value,digits = 4,
  file = "Posthoc_ET_administration_sites_cat_table_3.html")  

```

```{r Infarct_measurement_post_hoc, include=FALSE, eval=FALSE}

Infarct_measurement_LM = ref_grid(lm_transformed_trimmed, 
  non.nuisance = "Infarct_measurement")
#Posthoc/Planned contrasts 
Infarct_measurement_raw_posthoc <- lsmeans(
  Infarct_measurement_LM, pairwise ~ Infarct_measurement, adjust="tukey") 

Infarct_measurement_posthoc<-summary(Infarct_measurement_raw_posthoc) 

Infarct_measurement_p_value<-data.frame(cbind(
  Infarct_measurement_posthoc$contrasts[,-4]))


#View the table in a pretty way
tab_df(Infarct_measurement_p_value,digits = 4,
  file = "Posthoc_Infarct_measurement_table_3.html")  

```

```{r Anaesthetic_post_hoc, include=FALSE, eval=FALSE}
#list of all dummy variable column names
anaesthetics<-c(#"Induction_No_anaesthetic",
                "Induction_Isoflurane", 
                "Induction_Ketamine", 
                "Induction_Xylazine", 
                "Induction_Nitrous_oxide", 
                "Induction_Halothane", 
                "Induction_Sodium_Pentobarbital", 
                "Induction_other_anaesthetics", 
                "Induction_A_Not_reported", 
                #"Induction_Tribromoethanol", 
                "Induction_Sevoflurane")
#loop time
#reset in case of other loops
i=1
j=1

Anaesthetics_ptable<-data.frame() #empty data frame

for (i in 1:(length(anaesthetics)-1)){ #-1 to stop one before the end as comparing to other list

  for (j in (i+1):length(anaesthetics)) { #start 1 from top with j to compare to anaesthetics i
   # make ref grid of pairwise comparisons - only the ones we want
    Anaesthetics_LM <-
      ref_grid(lm_transformed_trimmed, 
        non.nuisance = anaesthetics[c(i,j)]) #non nuisance variables are i-th + j-th anaesthetics
    #Posthoc/Planned contrasts 
    
    frmla <- as.formula(paste("pairwise", #generating the formula for the posthoc
      paste(anaesthetics[c(i,j)], 
        sep = "", collapse = " + "), sep = " ~ "))
    #regular code time
    Anaesthetics_raw_posthoc <-
      lsmeans(Anaesthetics_LM, #linear model with our reference grid
        frmla, adjust="none") #no adjustments yet

    Anaesthetics_posthoc<-summary(
      Anaesthetics_raw_posthoc) 
    
    Anaesthetics_p_value<-data.frame(cbind( #trim down some useless columns
      Anaesthetics_posthoc$contrasts["contrast"],
      Anaesthetics_posthoc$contrasts["p.value"]))
    
    #Select the comparison you are interested in
    Anaesthetics_comparisons<-c(4)
    if(nrow(Anaesthetics_ptable)==0){ #if nrows in anaesthetic table=0 
          Anaesthetics_ptable<- Anaesthetics_p_value[ #make the anaesthetic table equal results from posthoc
        Anaesthetics_comparisons,] #after initial table creation on first runthrough, tack new results on to end of table - this is because we didn't know how many comparisons there would be at the start
    } else{
        Anaesthetics_ptable<-rbind(
          Anaesthetics_ptable ,
          Anaesthetics_p_value[
            Anaesthetics_comparisons,])
      }
  }

}


#Create a column of adjusted p values using the Holm-Sidak method - not tukey as not all comparisons done
Anaesthetics_ptable$padj<-p.adjust(Anaesthetics_ptable$p.value, method="holm") 

rownames(Anaesthetics_ptable)<-1:nrow(Anaesthetics_ptable)

#View the table in a pretty way
tab_df(Anaesthetics_ptable,digits = 4,file = "Anaesthetics_posthoc_table_3.html", show.rownames = T)  

#Anaesthetics


# Case match analysis
```



# Case-matched analysis

```{r Creating_reduced_case_matched_dataset, include=FALSE}

dfc4_Case_match <- dfc4_Unique

#remove mice
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(Animal) | #need this line of code or it filters out all rows with NAs
           Animal != "Mouse")
dfc4_Case_match$Animal <- droplevels(dfc4_Case_match$Animal) #drop empty levels created above

#make mm^3 variable
dfc4_Case_match$Rat_infarct_volume_mm3 <- dfc4_Case_match$Infarct_percent_control*19.71

#cut any not reported conscious levels
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(Conscious) | #need this line of code or it filters out all rows with NAs
           Conscious != "NR")
dfc4_Case_match$Conscious <- droplevels(dfc4_Case_match$Conscious) #drop empty levels created above


#ET_brain_depth
table(dfc4_Case_match$ET_brain_depth, dfc4_Case_match$Conscious)
#cut "both cortical and subcortical"
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(ET_brain_depth) | #need this line of code or it filters out all rows with NAs
           ET_brain_depth != "Both cortical and subcortical")
dfc4_Case_match$ET_brain_depth <- droplevels(dfc4_Case_match$ET_brain_depth) #drop empty levels created above

#MCA_occluded
table(dfc4_Case_match$MCA_occluded, dfc4_Case_match$Conscious)
#33 NR's in unconscious, 0 in conscious, come back to this - too aggressive to cut right now

#Infarct measurement method
table(dfc4_Case_match$Infarct_measurement, dfc4_Case_match$Conscious)
#lose just MRI + NR this time (both 0 in conscious) and drop completely empty PET level, TTC only 4 conscious, don't drop yet
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(Infarct_measurement) | #need this line of code or it filters out all rows with NAs
           Infarct_measurement != "MRI (in vivo)" &
           Infarct_measurement != "NR")
dfc4_Case_match$Infarct_measurement <- droplevels(dfc4_Case_match$Infarct_measurement) #drop empty levels created above

#infarct measurement time
table(as.factor(dfc4_Case_match$Infarct_measure_hrs), dfc4_Case_match$Conscious)
stripchart(dfc4_Case_match$Infarct_measure_hrs~dfc4_Case_match$Conscious, pch=16,method="jitter")
#largest conscious are 672 hours, so cut all above this time
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(Infarct_measure_hrs) | #need this line of code or it filters out all rows with NAs
           Infarct_measure_hrs < 673)

#recheck previous significant ones
#All still good, 33 NR's for MCA occlusion are down to 17 now

#Brain_depth
table(dfc4_Case_match$Comorbidity, dfc4_Case_match$Conscious)
# get rid of pit.dwarfism and remove empty hypothyroidism level
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(Comorbidity) | #need this line of code or it filters out all rows with NAs
           Comorbidity != "Pituitary dwarfism")
dfc4_Case_match$Comorbidity <- droplevels(dfc4_Case_match$Comorbidity) #drop empty levels created above

#ET_dose_pmol
table(as.factor(dfc4_Case_match$ET_dose_pmol), dfc4_Case_match$Conscious)
stripchart(dfc4_Case_match$ET_dose_pmol~dfc4_Case_match$Conscious, pch=16,method="jitter")
#highest conscious is 375, drop all above this
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(ET_dose_pmol) | #need this line of code or it filters out all rows with NAs
           ET_dose_pmol < 376)

#ET administration mins
stripchart(dfc4_Case_match$ET_administration_mins~dfc4_Case_match$Conscious, pch=16,method="jitter")
#remove one unconscious at 60 mins
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(ET_administration_mins) | #need this line of code or it filters out all rows with NAs
           ET_administration_mins < 59)

#ET administration sites
table(as.factor(dfc4_Case_match$ET_administration_sites), dfc4_Case_match$Conscious)
# lose one study at 4 and one study at 6, both unconscious
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(ET_administration_sites) | #need this line of code or it filters out all rows with NAs
           ET_administration_sites < 3)

#recheck previous variables
#all still looking good, some down to 1 level remove from model, some pool (comorbidity), no extra deletions yet

#check extra variables not included in first linear model

#sex
table(dfc4_Case_match$Sex, dfc4_Case_match$Conscious)
#leave as-is but still don't put in the model

#route of administration
table(dfc4_Case_match$ET_administration_route, dfc4_Case_match$Conscious)
#drop dropper mainly because it is theoretically so different to needle adminstration and we removed form other model
dfc4_Case_match$ET_administration_route <- droplevels(dfc4_Case_match$ET_administration_route) #drop empty levels
par(mar=c(9,12,2,2), bty="n") #run this line and next line together
stripchart(Infarct_percent_control ~ ET_administration_route * Conscious, data=dfc4_Case_match, col=dfc4_Reduced$Conscious, pch=16, las=2, method="jitter")
#remove dropper
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(ET_administration_route) | #need this line of code or it filters out all rows with NAs
           ET_administration_route != "Dropper")
dfc4_Case_match$ET_administration_route <- droplevels(dfc4_Case_match$ET_administration_route) #drop empty levels created above

#finish with removing not reported MCA occlusions
#MCA_occluded
table(dfc4_Case_match$MCA_occluded, dfc4_Case_match$Conscious)
dfc4_Case_match <- dfc4_Case_match %>%
  filter(is.na(MCA_occluded) | #need this line of code or it filters out all rows with NAs
           MCA_occluded != "NR")
dfc4_Case_match$MCA_occluded <- droplevels(dfc4_Case_match$MCA_occluded) #drop empty levels created above

summary(dfc4_Case_match$Conscious) #check how many experiments are left in both

#now have an issue with anaesthetics where isoflurane (2 experiments) and sevoflurane (1 experiment) now have too few studies to include in the model as variables, but if I leave the studies in and just don't add the dummy variables to the model, the model will see they have a "0" for all other anaesthetics and will classify them as "conscious" animals, only solutions are to either group these two experiments in "other" anaesthetics or exclude them entirely. 
#I'm reluctant to lose more studies since currently down to 31 unconscious studies (vs 38 conscious), so choosing to reclassify them as "other" anaesthetics for this case-matched analysis

summary(as.factor(dfc4_Case_match$Induction_Isoflurane))
summary(as.factor(dfc4_Case_match$Induction_Sevoflurane))
summary(as.factor(dfc4_Case_match$Induction_other_anaesthetics))
dfc4_Case_match$Induction_other_anaesthetics <- (dfc4_Case_match$Induction_Isoflurane==1 |
                                                   dfc4_Case_match$Induction_other_anaesthetics==1 |
                                                   dfc4_Case_match$Induction_Sevoflurane==1)*1 #if other anaesthetics, isoflurane, or sevoflurane=1, times other by 1


```

```{r Binning_variables, include=FALSE}
#lost too many studies to NA's for these variables so binning them into "not reported" categories and groups

#ET_dose_pmol
summary(dfc4_Case_match$ET_dose_pmol) #7 NA's 0.0803 min, 375 max
hist(dfc4_Case_match$ET_dose_pmol, breaks = 12) #break into 50's then 200+


dfc4_Case_match$ET_dose_pmol_cat <- cut(dfc4_Case_match$ET_dose_pmol,
              breaks=c(0, 50, 100, 150, 200, 380),
              labels=c('0.08-50pmol', '50-100pmol', '100-150pmol', "150-200pmol", '200+pmol'))

levels(dfc4_Case_match$ET_dose_pmol_cat) <-c(levels(dfc4_Case_match$ET_dose_pmol_cat),"Not reported") #add not reported as a level 
dfc4_Case_match$ET_dose_pmol_cat[is.na(dfc4_Case_match$ET_dose_pmol_cat)]<-"Not reported" #replace NA's with this level



#Administration minutes
summary(dfc4_Case_match$ET_administration_mins) #14 NA's 1.6 min, 30 max
hist(dfc4_Case_match$ET_administration_mins, breaks = 15) #break into 2.5's then 5+


dfc4_Case_match$ET_administration_mins_cat <- cut(dfc4_Case_match$ET_administration_mins,
              breaks=c(0, 2.5, 5, 31),
              labels=c('1.6-2.5mins', '2.5-5mins', "5+mins"))

levels(dfc4_Case_match$ET_administration_mins_cat) <-c(levels(dfc4_Case_match$ET_administration_mins_cat),"Not reported") #add not reported as a level 
dfc4_Case_match$ET_administration_mins_cat[is.na(dfc4_Case_match$ET_administration_mins_cat)]<-"Not reported" #replace NA's with this level
summary(dfc4_Case_match$ET_administration_mins_cat) 


#comorbidity
levels(dfc4_Case_match$Comorbidity)[levels(dfc4_Case_match$Comorbidity)=="Aged"] <- "Aged + Hypertension combined"
levels(dfc4_Case_match$Comorbidity)[levels(dfc4_Case_match$Comorbidity)=="Hypertension"] <- "Aged + Hypertension combined"
dfc4_Reduced$Comorbidity <- droplevels(dfc4_Reduced$Comorbidity) #drop empty levels created above



```

```{r Reorder_factor_levels_case-match, include=FALSE}

#MCA occluded
dfc4_Case_match$MCA_occluded <- factor(dfc4_Case_match$MCA_occluded, levels = c("Yes","No"))

#Comorbidity
dfc4_Case_match$Comorbidity <- factor(dfc4_Case_match$Comorbidity, levels = c("None","Aged + Hypertension combined"))

```


## Collinarity checks case-match
```{r variable_creation_collinearity, include=FALSE}
#new dataframe for collinearity plots
dfc4_coll_case_match <- dfc4_Case_match

# Dummy variable for Sex
for(i in levels(dfc4_coll_case_match$Sex)){
dfc4_coll_case_match$newcol<-0
dfc4_coll_case_match$newcol <-(dfc4_coll_case_match$Sex==i)*1 
dfc4_coll_case_match$newcol [is.na(dfc4_coll_case_match$newcol)]<-0 
colnames(dfc4_coll_case_match)[ncol(dfc4_coll_case_match)]<-i
}
colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="NR"]<-"Not_reported_sex"
colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="Mixed"]<-"Mixed_sex"

# Comorbidity dummy variables
for(i in levels(dfc4_coll_case_match$Comorbidity)){
dfc4_coll_case_match$newcol<-0
dfc4_coll_case_match$newcol <-(dfc4_coll_case_match$Comorbidity==i)*1 
dfc4_coll_case_match$newcol[is.na(dfc4_coll_case_match$newcol)]<-0 
colnames(dfc4_coll_case_match)[ncol(dfc4_coll_case_match)]<-i
}
colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="None"]<-"No_comorbidity"

summary(dfc4_Case_match$ET_administration_route)
# Dummy variable for ET_administration_route
for(i in levels(dfc4_coll_case_match$ET_administration_route)){
dfc4_coll_case_match$newcol<-0
dfc4_coll_case_match$newcol <-(dfc4_coll_case_match$ET_administration_route==i)*1 
dfc4_coll_case_match$newcol[is.na(dfc4_coll_case_match$newcol)]<-0 
colnames(dfc4_coll_case_match)[ncol(dfc4_coll_case_match)]<-i
}
colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="NR"]<-"Not_reported_admin_route"

# ET_brain_depth dummy variables
for(i in levels(dfc4_coll_case_match$ET_brain_depth)){
dfc4_coll_case_match$newcol<-0
dfc4_coll_case_match$newcol <-(dfc4_coll_case_match$ET_brain_depth==i)*1 
dfc4_coll_case_match$newcol[is.na(dfc4_coll_case_match$newcol)]<-0 
colnames(dfc4_coll_case_match)[ncol(dfc4_coll_case_match)]<-i
}

# MCA_occluded dummy variables
for(i in levels(dfc4_coll_case_match$MCA_occluded)){
dfc4_coll_case_match$newcol<-0
dfc4_coll_case_match$newcol <-(dfc4_coll_case_match$MCA_occluded==i)*1 
dfc4_coll_case_match$newcol[is.na(dfc4_coll_case_match$newcol)]<-0 
colnames(dfc4_coll_case_match)[ncol(dfc4_coll_case_match)]<-i
}
colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="Yes"]<-"Occluded_MCA"
colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="No"]<-"MCA_not_occluded"
# colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="Not reported"]<-"MCA_occlusion_not_reported"

# Conscious dummy variables
colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="Conscious"]<-"Consciousness"
for(i in levels(dfc4_coll_case_match$Consciousness)){
dfc4_coll_case_match$newcol<-0
dfc4_coll_case_match$newcol <-(dfc4_coll_case_match$Consciousness==i)*1 
dfc4_coll_case_match$newcol[is.na(dfc4_coll_case_match$newcol)]<-0 
colnames(dfc4_coll_case_match)[ncol(dfc4_coll_case_match)]<-i
}

# Infarct_measurement dummy variables
for(i in levels(dfc4_coll_case_match$Infarct_measurement)){
dfc4_coll_case_match$newcol<-0
dfc4_coll_case_match$newcol <-(dfc4_coll_case_match$Infarct_measurement==i)*1 
dfc4_coll_case_match$newcol[is.na(dfc4_coll_case_match$newcol)]<-0 
colnames(dfc4_coll_case_match)[ncol(dfc4_coll_case_match)]<-i
}

# ET_administration_mins_cat dummy variables
for(i in levels(dfc4_coll_case_match$ET_administration_mins_cat)){
dfc4_coll_case_match$newcol<-0
dfc4_coll_case_match$newcol <-(dfc4_coll_case_match$ET_administration_mins_cat==i)*1 
dfc4_coll_case_match$newcol[is.na(dfc4_coll_case_match$newcol)]<-0 
colnames(dfc4_coll_case_match)[ncol(dfc4_coll_case_match)]<-i
}
colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="Not reported"]<-"Not_reported_administration_mins"

# ET_dose_pmol_cat dummy variables
for(i in levels(dfc4_coll_case_match$ET_dose_pmol_cat)){
dfc4_coll_case_match$newcol<-0
dfc4_coll_case_match$newcol <-(dfc4_coll_case_match$ET_dose_pmol_cat==i)*1 
dfc4_coll_case_match$newcol[is.na(dfc4_coll_case_match$newcol)]<-0 
colnames(dfc4_coll_case_match)[ncol(dfc4_coll_case_match)]<-i
}
colnames(dfc4_coll_case_match)[colnames(dfc4_coll_case_match)=="Not reported"]<-"Not_reported_ET_dose"

```

```{r Collinearity_plot, include=FALSE, eval=FALSE}

#list all the variables of interest for collinearity checking
column_interest_case_match <- c("Rat_infarct_volume_mm3",
                     "Unconscious",
                     "Conscious",
                     "Male",
                     "Female",
                     # "Mixed_sex",
                     "Not_reported_sex",
                     "No_comorbidity",
                     "Aged + Hypertension combined",
                     "Needle",
                     "Guide cannula",
                     # "Dropper",
                     "Cortical",
                     "Subcortical",
                     # "Both cortical and subcortical",
                     "Occluded_MCA",
                     "MCA_not_occluded", 
                     # "MCA_occlusion_not_reported",
                     "Other histology (ex vivo)",
                     "TTC (ex vivo)",
                     # "MRI (in vivo)",
                     "Induction_Halothane",
                     # "Induction_Isoflurane",
                     # "Induction_Ketamine",
                     "Induction_Nitrous_oxide",
                     "Induction_No_anaesthetic",
                     "Induction_A_Not_reported",
                     # "Induction_Sevoflurane",
                     "Induction_Sodium_Pentobarbital",
                     # "Induction_Tribromoethanol",
                     # "Induction_Xylazine",
                     "Induction_other_anaesthetics",
                     # "Induction_time_hrs",
                     "0.08-50pmol",
                     "50-100pmol",
                     "100-150pmol",
                     "150-200pmol",
                     "200+pmol",
                     "Not_reported_ET_dose",
                     "1.6-2.5mins",
                     "2.5-5mins",
                     "5+mins",
                     "Not_reported_administration_mins",
                     # "ET_dose_pmol",
                     # "ET_administration_mins",
                     # "ET_administration_sites",
                     "Infarct_measure_hrs")

#colnames(dfc4_coll_case_match)

#select just these columns from the dataframe
matrix_coll<-subset(dfc4_coll_case_match, select = column_interest_case_match)
#how many NA's there are
for(i in 1:ncol(matrix_coll)){
  print(column_interest_case_match[i])
print(sum(is.na(matrix_coll[,i])))
}
#remove NA's, complete cases only
matrix_coll<-matrix_coll[complete.cases(matrix_coll),]
mat<-as.matrix(matrix_coll) #turn into a matrix

#make the corrplot
pdf("Collinearity_case_matched_3.pdf", heigh=20, width=20)
corr_matrix<-cor(mat) 
testRes = cor.mtest(mat, conf.level = 0.95)
corrplot(corr_matrix, p.mat = testRes$p, method = 'circle', type = 'lower', insig='blank',
         addCoef.col ='black', number.cex = 0.8, diag=FALSE,tl.col="black")

corrplot(corr_matrix, method = 'circle', type = 'lower', number.cex = 0.8, diag=FALSE, tl.col="black")
dev.off

```

## Linear model case-match
```{r Linear_model_case-matched_test_untransformed, include=FALSE}

#linear model with all cleaned variables for case-matched data
lm_case_test_untransformed <- lm(data = dfc4_Case_match,
   Rat_infarct_volume_mm3 ~
     Comorbidity + # binned
     ET_brain_depth +
     MCA_occluded +
     ET_dose_pmol_cat + 
     ET_administration_mins_cat +
     #ET_administration_sites +
     Infarct_measure_hrs +
     Infarct_measurement +
     Induction_Halothane  + 
     # Induction_Isoflurane +
     # Induction_Ketamine +
     Induction_Nitrous_oxide +
     # #Induction_No_anaesthetic + #a zero on all other anaesthetics is the same as a 1 on this
     # Induction_Sevoflurane +
     Induction_Sodium_Pentobarbital +
     # Induction_Tribromoethanol +
     # Induction_Xylazine +
     Induction_other_anaesthetics +
     Induction_A_Not_reported,
   #Conscious,
   weights = N_animals_control
   )

tab_model(lm_case_test_untransformed) #R2 adjusted = 0.706

tab_df(car::Anova(lm_case_test_untransformed), show.rownames = TRUE) 
 #Diagnostic plots 
autoplot(lm_case_test_untransformed,which = c(1,2,4)) #maybe boxcox this one


```

```{r Linear_model_case-matched_transformed, include=FALSE}
#run boxcox on old model to identify transformation
lm_case_boxcox<-boxcox(lm_case_test_untransformed,lambda = seq(-5, 5, 1/1000), plotit = TRUE)

Selected.lambda_case <-lm_case_boxcox$x[lm_case_boxcox$y==max(lm_case_boxcox$y)] 
Selected.lambda_case # = 0.189  - Generally if boxcox is <0.2, you would just log transform it


#linear model with all cleaned variables for case-matched data
lm_case_test_transformed <- lm(data = dfc4_Case_match,
   #Infarct_percent_control^Selected.lambda_case ~ #transformed dependent variable
     log(Rat_infarct_volume_mm3, base=10) ~ #transformed dependent variable
     Comorbidity + # binned
     ET_brain_depth +
     MCA_occluded +
     ET_dose_pmol_cat + 
     ET_administration_mins_cat +
     #ET_administration_sites +
     Infarct_measure_hrs +
     Infarct_measurement +
     Induction_Halothane  + 
     # Induction_Isoflurane +
     # Induction_Ketamine +
     Induction_Nitrous_oxide +
     # #Induction_No_anaesthetic + #a zero on all other anaesthetics is the same as a 1 on this
     # Induction_Sevoflurane +
     Induction_Sodium_Pentobarbital +
     # Induction_Tribromoethanol +
     # Induction_Xylazine +
     Induction_other_anaesthetics +
     Induction_A_Not_reported,
   #Conscious,
   weights = N_animals_control
   )

tab_model(lm_case_test_transformed) #R2 adjusted = 0.895

tab_df(car::Anova(lm_case_test_transformed), show.rownames = TRUE) 
 #Diagnostic plots 
autoplot(lm_case_test_transformed,which = c(1,2,4))


```

```{r Checking_outliers, include=FALSE, eval=FALSE}
 #Diagnostic plots 
autoplot(lm_case_test_transformed,which = c(1,2,4))

#Residuals vs fitted shows a spread, our dependent variable does not meet assumptions of normality, need a transformation to fix this.

#Cook's distance cut-off is usually 4/n, where n is total number of data points, in this case, 71 experiments were used in the model. 4/71=0.056338
#The transformed graph shows only no studies with larger cook's distance than this, so hopefully none being overly influential

which(cooks.distance(lm_case_test_transformed)>0.5) #Identify row numbers of studies that have a cook's distance of >a certain number
#show the lines
#none identified - no outliers removed

```

```{r Linear_model_case-matched_final}

#linear model with all cleaned variables for case-matched data
lm_case_match <- lm(data = dfc4_Case_match,
   #Infarct_percent_control^Selected.lambda ~ #transformed dependent variable
     log(Rat_infarct_volume_mm3, base=10) ~ #transformed dependent variable
     Comorbidity + # binned
     ET_brain_depth +
     MCA_occluded +
     ET_dose_pmol_cat + #may need to log this
     ET_administration_mins_cat +
     #ET_administration_sites +
     Infarct_measure_hrs +
     Infarct_measurement +
     Induction_Halothane  + 
     # Induction_Isoflurane +
     # Induction_Ketamine +
     Induction_Nitrous_oxide +
     # #Induction_No_anaesthetic + #a zero on all other anaesthetics is the same as a 1 on this
     # Induction_Sevoflurane +
     Induction_Sodium_Pentobarbital +
     # Induction_Tribromoethanol +
     # Induction_Xylazine +
     Induction_other_anaesthetics +
     Induction_A_Not_reported,
   #Conscious,
   weights = N_animals_control
   )

tab_model(lm_case_match, digits = 4, file = "Linear_case_match_3.html")

tab_df(car::Anova(lm_case_match), show.rownames = TRUE, digits = 4, file = "Linear_case_match_ANOVA_3.html") 


```

```{r Alternate_Linear_model_case-matched_conscious, include=FALSE}
summary(dfc4_Case_match$Conscious)
#linear model with all cleaned variables for case-matched data, using conscious instead of anaesthetics to plot on graph

lm_case_match_alternate_conscious <- lm(data = dfc4_Case_match,
   #Infarct_percent_control^Selected.lambda ~ #transformed dependent variable
     log(Rat_infarct_volume_mm3, base=10) ~ #transformed dependent variable
     Comorbidity + # binned
     ET_brain_depth +
     MCA_occluded +
     ET_dose_pmol_cat + #may need to log this
     ET_administration_mins_cat +
     #ET_administration_sites +
     Infarct_measure_hrs +
     Infarct_measurement +
     # Induction_Halothane  + 
     # # Induction_Isoflurane +
     # # Induction_Ketamine +
     # Induction_Nitrous_oxide +
     # # #Induction_No_anaesthetic + #a zero on all other anaesthetics is the same as a 1 on this
     # # Induction_Sevoflurane +
     # Induction_Sodium_Pentobarbital +
     # # Induction_Tribromoethanol +
     # # Induction_Xylazine +
     # Induction_other_anaesthetics +
     # Induction_A_Not_reported,
     Conscious,
   weights = N_animals_control
   )

tab_model(lm_case_match_alternate_conscious, digits = 4)

tab_df(car::Anova(lm_case_match_alternate_conscious), show.rownames = TRUE, digits = 4) 

#note conscious is not significant on its own, but individual anaesthetics are

```

## Prediction plots case-matched

```{r Mean_overall_brain_vol_case_match, include=FALSE}

Expected_brain_vol_percent_case <- 10^(mean(log(dfc4_Case_match$Infarct_percent_control, base=10))) #mean stroke volume in %: 2.72% in main model, 3.04 in this case-match. Similar enough to just take the main model

Expected_brain_vol_mm3_case <- 10^(mean(log(dfc4_Case_match$Rat_infarct_volume_mm3, base=10))) #mean stroke volume in mm^3: 53.63mm^3 in main model, 59.86mm^3 in case-match. A bit different, may be similar enough to just use main model measure (considering we hope to overlay the graphs)

```

```{r Checking_baselines_for_predicts, include=FALSE, eval=FALSE}

   #   Comorbidity = "None",
   #   ET_brain_depth = "Cortical",
   #   MCA_occluded = "Yes",
   #   ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
   #   ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
   #   Infarct_measure_hrs = 72, #72 is mode
   #   Infarct_measurement  = "Other histology (ex vivo)",
   # weights = 8 #average n of animals = ~8
#anaesthetics all 0 which = conscious
summary(dfc4_Case_match$ET_dose_pmol_cat)

table(      dfc4_Case_match$ET_administration_mins_cat, 
            dfc4_Case_match$ET_dose_pmol_cat, #150-200pmol or 200+pmol only have 2 and 1 full cases, 100-150pmol has 9 full cases, picking this
            dfc4_Case_match$Conscious, 
      dfc4_Case_match$MCA_occluded, 
      dfc4_Case_match$ET_brain_depth, 
      dfc4_Case_match$Comorbidity,

      dfc4_Case_match$Infarct_measurement) #9 experiments in "baseline" for all of these - best I can get


```

## Categorical predict plots case-match
```{r Comorbidity_dataframe_case, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#Comorbidity
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Comorbidity_case<-expand.grid(Comorbidity = levels(dfc4_Case_match$Comorbidity),
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Comorbidity_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_Comorbidity_case)
# generate lower confidence intervals by subtracting standard errors
Comorbidity_LCI_untransformed_case <- Comorbidity_predicted_untransformed_case-predict(lm_case_match, newdata=grid_Comorbidity_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Comorbidity_UCI_untransformed_case<-Comorbidity_predicted_untransformed_case+predict(lm_case_match, newdata=grid_Comorbidity_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Comorbidity_predicted_case <- data.frame(grid_Comorbidity_case$Comorbidity, 
                                       10^(Comorbidity_predicted_untransformed_case), 
                                       10^(Comorbidity_LCI_untransformed_case), 
                                       10^(Comorbidity_UCI_untransformed_case))

# Change the column names
colnames(df_Comorbidity_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Comorbidity.correct_case<- df_Comorbidity_predicted_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_Comorbidity_predicted_case$Infarct_volume<-df_Comorbidity_predicted_case$Infarct_volume-Comorbidity.correct_case
df_Comorbidity_predicted_case$LCI<-df_Comorbidity_predicted_case$LCI-Comorbidity.correct_case
df_Comorbidity_predicted_case$UCI<-df_Comorbidity_predicted_case$UCI-Comorbidity.correct_case

#change some names to avoid conflict with similar names later on
levels(df_Comorbidity_predicted_case$Variable)[levels(df_Comorbidity_predicted_case$Variable)=="None"] <- "No Comorbidities" 


```

```{r Comorbidity_predicted_plot_case, include=FALSE, eval=FALSE}

pdf("Predict_cat_Comorbidity_case_3.pdf", width = 6, height = 3)
ggplot(data=df_Comorbidity_predicted_case, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[4]) + #points with error ranges style graph
  coord_flip() + # flip coordinates (puts labels on y axis)
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[4]) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=20)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

```{r ET_brain_depth_dataframe_case, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#ET_brain_depth
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_ET_brain_depth_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = levels(dfc4_Case_match$ET_brain_depth),
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
ET_brain_depth_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_ET_brain_depth_case)
# generate lower confidence intervals by subtracting standard errors
ET_brain_depth_LCI_untransformed_case <- ET_brain_depth_predicted_untransformed_case-predict(lm_case_match, newdata=grid_ET_brain_depth_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
ET_brain_depth_UCI_untransformed_case<-ET_brain_depth_predicted_untransformed_case+predict(lm_case_match, newdata=grid_ET_brain_depth_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_ET_brain_depth_predicted_case <- data.frame(grid_ET_brain_depth_case$ET_brain_depth, 
                                       10^(ET_brain_depth_predicted_untransformed_case), 
                                       10^(ET_brain_depth_LCI_untransformed_case), 
                                       10^(ET_brain_depth_UCI_untransformed_case))

# Change the column names
colnames(df_ET_brain_depth_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
ET_brain_depth.correct_case<- df_ET_brain_depth_predicted_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_ET_brain_depth_predicted_case$Infarct_volume<-df_ET_brain_depth_predicted_case$Infarct_volume-ET_brain_depth.correct_case
df_ET_brain_depth_predicted_case$LCI<-df_ET_brain_depth_predicted_case$LCI-ET_brain_depth.correct_case
df_ET_brain_depth_predicted_case$UCI<-df_ET_brain_depth_predicted_case$UCI-ET_brain_depth.correct_case


```

```{r ET_brain_depth_predicted_plot_case, include=FALSE, eval=FALSE}

pdf("Predict_cat_brain_depth_case_3.pdf", width = 7, height = 3)
ggplot(data=df_ET_brain_depth_predicted_case, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[4]) + #points with error ranges style graph
  coord_flip() + # flip coordinates (puts labels on y axis)
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[4]) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=20)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

```{r MCA_occluded_dataframe_case, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#MCA_occluded
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_MCA_occluded_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = levels(dfc4_Case_match$MCA_occluded), 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
MCA_occluded_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_MCA_occluded_case)
# generate lower confidence intervals by subtracting standard errors
MCA_occluded_LCI_untransformed_case <- MCA_occluded_predicted_untransformed_case-predict(lm_case_match, newdata=grid_MCA_occluded_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
MCA_occluded_UCI_untransformed_case<-MCA_occluded_predicted_untransformed_case+predict(lm_case_match, newdata=grid_MCA_occluded_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_MCA_occluded_predicted_case <- data.frame(grid_MCA_occluded_case$MCA_occluded, 
                                       10^(MCA_occluded_predicted_untransformed_case), 
                                       10^(MCA_occluded_LCI_untransformed_case), 
                                       10^(MCA_occluded_UCI_untransformed_case))

# Change the column names
colnames(df_MCA_occluded_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
MCA_occluded.correct_case<- df_MCA_occluded_predicted_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_MCA_occluded_predicted_case$Infarct_volume<-df_MCA_occluded_predicted_case$Infarct_volume-MCA_occluded.correct_case
df_MCA_occluded_predicted_case$LCI<-df_MCA_occluded_predicted_case$LCI-MCA_occluded.correct_case
df_MCA_occluded_predicted_case$UCI<-df_MCA_occluded_predicted_case$UCI-MCA_occluded.correct_case

#change some names to avoid conflict with similar names later on
levels(df_MCA_occluded_predicted_case$Variable)[levels(df_MCA_occluded_predicted_case$Variable)=="Yes"] <- "MCA occluded" 
levels(df_MCA_occluded_predicted_case$Variable)[levels(df_MCA_occluded_predicted_case$Variable)=="No"] <- "MCA not occluded" 


```

```{r MCA_occlusion_predicted_plot_case, include=FALSE, eval=FALSE}

pdf("Predict_cat_MCA_occlusion_case_3.pdf", width = 7, height = 3)
ggplot(data=df_MCA_occluded_predicted_case, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[4]) + #points with error ranges style graph
  coord_flip() + # flip coordinates (puts labels on y axis)
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[4]) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=20)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()


```

```{r ET_dose_pmol_cat_dataframe_case, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#ET_dose_pmol_cat
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_ET_dose_pmol_cat_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = levels(dfc4_Case_match$ET_dose_pmol_cat), #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
ET_dose_pmol_cat_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_ET_dose_pmol_cat_case)
# generate lower confidence intervals by subtracting standard errors
ET_dose_pmol_cat_LCI_untransformed_case <- ET_dose_pmol_cat_predicted_untransformed_case-predict(lm_case_match, newdata=grid_ET_dose_pmol_cat_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
ET_dose_pmol_cat_UCI_untransformed_case<-ET_dose_pmol_cat_predicted_untransformed_case+predict(lm_case_match, newdata=grid_ET_dose_pmol_cat_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_ET_dose_pmol_cat_predicted_case <- data.frame(grid_ET_dose_pmol_cat_case$ET_dose_pmol_cat, 
                                       10^(ET_dose_pmol_cat_predicted_untransformed_case), 
                                       10^(ET_dose_pmol_cat_LCI_untransformed_case), 
                                       10^(ET_dose_pmol_cat_UCI_untransformed_case))

# Change the column names
colnames(df_ET_dose_pmol_cat_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
ET_dose_pmol_cat.correct_case<- df_ET_dose_pmol_cat_predicted_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_ET_dose_pmol_cat_predicted_case$Infarct_volume<-df_ET_dose_pmol_cat_predicted_case$Infarct_volume-ET_dose_pmol_cat.correct_case
df_ET_dose_pmol_cat_predicted_case$LCI<-df_ET_dose_pmol_cat_predicted_case$LCI-ET_dose_pmol_cat.correct_case
df_ET_dose_pmol_cat_predicted_case$UCI<-df_ET_dose_pmol_cat_predicted_case$UCI-ET_dose_pmol_cat.correct_case

```

```{r ET_dose_pmol_cat_predicted_plot_case, include=FALSE, eval=FALSE}

pdf("Predict_cat_ET_dose_pmol_case_3.pdf", width = 6, height = 3)
ggplot(data=df_ET_dose_pmol_cat_predicted_case, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[4]) + #points with error ranges style graph
  coord_flip() + # flip coordinates (puts labels on y axis)
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[4]) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=20)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

```{r ET_administration_mins_cat_dataframe_case, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#ET_administration_mins_cat
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_ET_administration_mins_cat_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = levels(dfc4_Case_match$ET_administration_mins_cat), #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
ET_administration_mins_cat_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_ET_administration_mins_cat_case)
# generate lower confidence intervals by subtracting standard errors
ET_administration_mins_cat_LCI_untransformed_case <- ET_administration_mins_cat_predicted_untransformed_case-predict(lm_case_match, newdata=grid_ET_administration_mins_cat_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
ET_administration_mins_cat_UCI_untransformed_case<-ET_administration_mins_cat_predicted_untransformed_case+predict(lm_case_match, newdata=grid_ET_administration_mins_cat_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_ET_administration_mins_cat_predicted_case <- data.frame(grid_ET_administration_mins_cat_case$ET_administration_mins_cat, 
                                       10^(ET_administration_mins_cat_predicted_untransformed_case), 
                                       10^(ET_administration_mins_cat_LCI_untransformed_case), 
                                       10^(ET_administration_mins_cat_UCI_untransformed_case))

# Change the column names
colnames(df_ET_administration_mins_cat_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
ET_administration_mins_cat.correct_case<- df_ET_administration_mins_cat_predicted_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_ET_administration_mins_cat_predicted_case$Infarct_volume<-df_ET_administration_mins_cat_predicted_case$Infarct_volume-ET_administration_mins_cat.correct_case
df_ET_administration_mins_cat_predicted_case$LCI<-df_ET_administration_mins_cat_predicted_case$LCI-ET_administration_mins_cat.correct_case
df_ET_administration_mins_cat_predicted_case$UCI<-df_ET_administration_mins_cat_predicted_case$UCI-ET_administration_mins_cat.correct_case


```

```{r ET_administration_mins_cat_predicted_plot_case, include=FALSE, eval=FALSE}

pdf("Predict_cat_ET_administration_mins_case_3.pdf", width = 6, height = 3)
ggplot(data=df_ET_administration_mins_cat_predicted_case, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[4]) + #points with error ranges style graph
  coord_flip() + # flip coordinates (puts labels on y axis)
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[4]) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=20)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

```{r Infarct_measurement_dataframe_case, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#Infarct_measurement
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Infarct_measurement_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = levels(dfc4_Case_match$Infarct_measurement),
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Infarct_measurement_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_Infarct_measurement_case)
# generate lower confidence intervals by subtracting standard errors
Infarct_measurement_LCI_untransformed_case <- Infarct_measurement_predicted_untransformed_case-predict(lm_case_match, newdata=grid_Infarct_measurement_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Infarct_measurement_UCI_untransformed_case<-Infarct_measurement_predicted_untransformed_case+predict(lm_case_match, newdata=grid_Infarct_measurement_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Infarct_measurement_predicted_case <- data.frame(grid_Infarct_measurement_case$Infarct_measurement, 
                                       10^(Infarct_measurement_predicted_untransformed_case), 
                                       10^(Infarct_measurement_LCI_untransformed_case), 
                                       10^(Infarct_measurement_UCI_untransformed_case))

# Change the column names
colnames(df_Infarct_measurement_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Infarct_measurement.correct_case<- df_Infarct_measurement_predicted_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_Infarct_measurement_predicted_case$Infarct_volume<-df_Infarct_measurement_predicted_case$Infarct_volume-Infarct_measurement.correct_case
df_Infarct_measurement_predicted_case$LCI<-df_Infarct_measurement_predicted_case$LCI-Infarct_measurement.correct_case
df_Infarct_measurement_predicted_case$UCI<-df_Infarct_measurement_predicted_case$UCI-Infarct_measurement.correct_case

#change some names to avoid conflict with similar names later on
levels(df_Infarct_measurement_predicted_case$Variable)[levels(df_Infarct_measurement_predicted_case$Variable)=="Other histology (ex vivo)"] <- "Other histology" 
levels(df_Infarct_measurement_predicted_case$Variable)[levels(df_Infarct_measurement_predicted_case$Variable)=="TTC (ex vivo)"] <- "TTC" 


```

```{r Infarct_measurement_predicted_plot_case, include=FALSE, eval=FALSE}

pdf("Predict_cat_measurement_method_case_3.pdf", width = 6, height = 5)
ggplot(data=df_Infarct_measurement_predicted_case, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[4]) + #points with error ranges style graph
  coord_flip() + # flip coordinates (puts labels on y axis)
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[4]) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,800,by=50)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

```{r Conscious_dataframe_case, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3
#using alternate linear model with consciousness instead of anaesthetic

#lm_transformed_alternate_conscious
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Conscious_case <- expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         # Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # # Induction_Isoflurane = 0, #dummy
                         # # Induction_Ketamine = 0, #dummy
                         # Induction_Nitrous_oxide = 0, #dummy
                         # # Induction_Sevoflurane = 0, #dummy
                         # Induction_Sodium_Pentobarbital = 0, #dummy
                         # # Induction_Tribromoethanol = 0, #dummy
                         # # Induction_Xylazine = 0, #dummy
                         # Induction_other_anaesthetics = 0, #dummy
                         # Induction_A_Not_reported = 0, #dummy
                         Conscious = levels(dfc4_Case_match$Conscious),
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Conscious_predicted_untransformed_case <- predict(lm_case_match_alternate_conscious, newdata=grid_Conscious_case)
# generate lower confidence intervals by subtracting standard errors
Conscious_LCI_untransformed_case <- Conscious_predicted_untransformed_case-predict(lm_case_match_alternate_conscious, newdata=grid_Conscious_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Conscious_UCI_untransformed_case<-Conscious_predicted_untransformed_case+predict(lm_case_match_alternate_conscious, newdata=grid_Conscious_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Conscious_predicted_case <- data.frame(grid_Conscious_case$Conscious, 
                                       10^(Conscious_predicted_untransformed_case), 
                                       10^(Conscious_LCI_untransformed_case), 
                                       10^(Conscious_UCI_untransformed_case))

# Change the column names
colnames(df_Conscious_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Conscious.correct_case<- df_Conscious_predicted_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_Conscious_predicted_case$Infarct_volume<-df_Conscious_predicted_case$Infarct_volume-Conscious.correct_case
df_Conscious_predicted_case$LCI<-df_Conscious_predicted_case$LCI-Conscious.correct_case
df_Conscious_predicted_case$UCI<-df_Conscious_predicted_case$UCI-Conscious.correct_case


```

```{r Conscious_predicted_plot_case, include=FALSE, eval=FALSE}

pdf("Predict_cat_Conscious_case_3.pdf", width = 6, height = 3)
ggplot(data=df_Conscious_predicted_case, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[4]) + #points with error ranges style graph
  coord_flip() + # flip coordinates (puts labels on y axis)
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[4]) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,500,by=20)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

## Anaesthetic predict plot case-match
```{r Induction_anaesthetics_dataframe_case, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#Induction_Halothane
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Halothane_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 1, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Halothane_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_Induction_Halothane_case)
# generate lower confidence intervals by subtracting standard errors
Induction_Halothane_LCI_untransformed_case <- Induction_Halothane_predicted_untransformed_case-predict(lm_case_match, newdata=grid_Induction_Halothane_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Halothane_UCI_untransformed_case<-Induction_Halothane_predicted_untransformed_case+predict(lm_case_match, newdata=grid_Induction_Halothane_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Halothane_predicted_case <- data.frame(grid_Induction_Halothane_case$Induction_Halothane, 
                                       10^(Induction_Halothane_predicted_untransformed_case), 
                                       10^(Induction_Halothane_LCI_untransformed_case), 
                                       10^(Induction_Halothane_UCI_untransformed_case))

# Change the column names
colnames(df_Induction_Halothane_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Halothane_predicted_case[1,1] <- "Halothane" #row one column one



#Induction_Nitrous_oxide
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Nitrous_oxide_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 1, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Nitrous_oxide_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_Induction_Nitrous_oxide_case)
# generate lower confidence intervals by subtracting standard errors
Induction_Nitrous_oxide_LCI_untransformed_case <- Induction_Nitrous_oxide_predicted_untransformed_case-predict(lm_case_match, newdata=grid_Induction_Nitrous_oxide_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Nitrous_oxide_UCI_untransformed_case<-Induction_Nitrous_oxide_predicted_untransformed_case+predict(lm_case_match, newdata=grid_Induction_Nitrous_oxide_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Nitrous_oxide_predicted_case <- data.frame(grid_Induction_Nitrous_oxide_case$Induction_Nitrous_oxide, 
                                       10^(Induction_Nitrous_oxide_predicted_untransformed_case), 
                                       10^(Induction_Nitrous_oxide_LCI_untransformed_case), 
                                       10^(Induction_Nitrous_oxide_UCI_untransformed_case))

# Change the column names
colnames(df_Induction_Nitrous_oxide_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Nitrous_oxide_predicted_case[1,1] <- "Nitrous oxide" #row one column one



#Induction_Sodium_Pentobarbital
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_Sodium_Pentobarbital_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 1, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_Sodium_Pentobarbital_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_Induction_Sodium_Pentobarbital_case)
# generate lower confidence intervals by subtracting standard errors
Induction_Sodium_Pentobarbital_LCI_untransformed_case <- Induction_Sodium_Pentobarbital_predicted_untransformed_case-predict(lm_case_match, newdata=grid_Induction_Sodium_Pentobarbital_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_Sodium_Pentobarbital_UCI_untransformed_case<-Induction_Sodium_Pentobarbital_predicted_untransformed_case+predict(lm_case_match, newdata=grid_Induction_Sodium_Pentobarbital_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_Sodium_Pentobarbital_predicted_case <- data.frame(grid_Induction_Sodium_Pentobarbital_case$Induction_Sodium_Pentobarbital, 
                                       10^(Induction_Sodium_Pentobarbital_predicted_untransformed_case), 
                                       10^(Induction_Sodium_Pentobarbital_LCI_untransformed_case), 
                                       10^(Induction_Sodium_Pentobarbital_UCI_untransformed_case))

# Change the column names
colnames(df_Induction_Sodium_Pentobarbital_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_Sodium_Pentobarbital_predicted_case[1,1] <- "Sodium pentobarbital" #row one column one


#Induction_other_anaesthetics
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_other_anaesthetics_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 1, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_other_anaesthetics_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_Induction_other_anaesthetics_case)
# generate lower confidence intervals by subtracting standard errors
Induction_other_anaesthetics_LCI_untransformed_case <- Induction_other_anaesthetics_predicted_untransformed_case-predict(lm_case_match, newdata=grid_Induction_other_anaesthetics_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_other_anaesthetics_UCI_untransformed_case<-Induction_other_anaesthetics_predicted_untransformed_case+predict(lm_case_match, newdata=grid_Induction_other_anaesthetics_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_other_anaesthetics_predicted_case <- data.frame(grid_Induction_other_anaesthetics_case$Induction_other_anaesthetics, 
                                       10^(Induction_other_anaesthetics_predicted_untransformed_case), 
                                       10^(Induction_other_anaesthetics_LCI_untransformed_case), 
                                       10^(Induction_other_anaesthetics_UCI_untransformed_case))

# Change the column names
colnames(df_Induction_other_anaesthetics_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_other_anaesthetics_predicted_case[1,1] <- "Other anaesthetics" #row one column one


#Induction_A_Not_reported
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_A_Not_reported_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 1, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_A_Not_reported_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_Induction_A_Not_reported_case)
# generate lower confidence intervals by subtracting standard errors
Induction_A_Not_reported_LCI_untransformed_case <- Induction_A_Not_reported_predicted_untransformed_case-predict(lm_case_match, newdata=grid_Induction_A_Not_reported_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_A_Not_reported_UCI_untransformed_case<-Induction_A_Not_reported_predicted_untransformed_case+predict(lm_case_match, newdata=grid_Induction_A_Not_reported_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_A_Not_reported_predicted_case <- data.frame(grid_Induction_A_Not_reported_case$Induction_A_Not_reported, 
                                       10^(Induction_A_Not_reported_predicted_untransformed_case), 
                                       10^(Induction_A_Not_reported_LCI_untransformed_case), 
                                       10^(Induction_A_Not_reported_UCI_untransformed_case))

# Change the column names
colnames(df_Induction_A_Not_reported_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_A_Not_reported_predicted_case[1,1] <- "Anaesthetic not reported" #row one column one

#No anaesthetics prediction
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Induction_No_anaesthetic_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = 72, #72 is mode
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 0, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Induction_No_anaesthetic_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_Induction_No_anaesthetic_case)
# generate lower confidence intervals by subtracting standard errors
Induction_No_anaesthetic_LCI_untransformed_case <- Induction_No_anaesthetic_predicted_untransformed_case-predict(lm_case_match, newdata=grid_Induction_No_anaesthetic_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Induction_No_anaesthetic_UCI_untransformed_case<-Induction_No_anaesthetic_predicted_untransformed_case+predict(lm_case_match, newdata=grid_Induction_No_anaesthetic_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Induction_No_anaesthetic_predicted_case <- data.frame(grid_Induction_No_anaesthetic_case$Induction_Halothane,#just need this to be a zero, there is no actual variable in the model or grid for no anaesthetics, but any other anaesthetic is a 0
                                       10^(Induction_No_anaesthetic_predicted_untransformed_case), 
                                       10^(Induction_No_anaesthetic_LCI_untransformed_case), 
                                       10^(Induction_No_anaesthetic_UCI_untransformed_case))

# Change the column names
colnames(df_Induction_No_anaesthetic_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#Change dummy variable name to anaesthetic name
df_Induction_No_anaesthetic_predicted_case[1,1] <- "No anaesthetic (conscious)" #row one column one

```

```{r Combine_anaesthetic_df_case-match, include=FALSE}
#combine all anaesthetics into one dataframe
df_Anaesthetics_predicted_case <- rbind(df_Induction_No_anaesthetic_predicted_case,
                                        df_Induction_Halothane_predicted_case,
                                   # df_Induction_Isoflurane_predicted_case,
                                   # df_Induction_Ketamine_predicted_case,
                                   df_Induction_Nitrous_oxide_predicted_case,
                                   # df_Induction_Sevoflurane_predicted_case,
                                   df_Induction_Sodium_Pentobarbital_predicted_case,
                                   # df_Induction_Tribromoethanol_predicted_case,
                                   # df_Induction_Xylazine_predicted_case,
                                   df_Induction_other_anaesthetics_predicted_case,
                                   df_Induction_A_Not_reported_predicted_case)

rownames(df_Anaesthetics_predicted_case) <- 1:nrow(df_Anaesthetics_predicted_case) #fix rownames to 1-10
#select the baseline variable infarct volume
Anaesthetics_predicted_case.correct_case<- df_Anaesthetics_predicted_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#normalising to "no anaesthetic"
df_Anaesthetics_predicted_case$Infarct_volume<-df_Anaesthetics_predicted_case$Infarct_volume-Anaesthetics_predicted_case.correct_case
df_Anaesthetics_predicted_case$LCI<-df_Anaesthetics_predicted_case$LCI-Anaesthetics_predicted_case.correct_case
df_Anaesthetics_predicted_case$UCI<-df_Anaesthetics_predicted_case$UCI-Anaesthetics_predicted_case.correct_case


```

```{r Induction_anaesthetics_predicted_plot, include=FALSE, eval=FALSE}
# Order levels for graph:
df_Anaesthetics_predicted_case$Variable <- factor(df_Anaesthetics_predicted_case$Variable, levels =
                                                                       c("No anaesthetic (conscious)",
                                                                         "Halothane",
                                                                         #"Isoflurane",
                                                                         #"Ketamine",
                                                                         "Nitrous oxide",
                                                                         #"Sevoflurane",
                                                                         "Sodium pentobarbital",
                                                                         #"Tribromoethanol",
                                                                         #"Xylazine",
                                                                         "Other anaesthetics",
                                                                         "Anaesthetic not reported"))
pdf("Predict_cat_anaesthetics_case_3.pdf", width = 7, height = 7)
ggplot(data=df_Anaesthetics_predicted_case, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at x=0 after flip
  geom_pointrange(colour = mako(5)[4]) + #points with error ranges style graph
  coord_flip() + # flip coordinates (puts labels on y axis)
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.2, cex=1, colour = mako(5)[4]) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-500,800,by=50)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none")
dev.off()

```

## Numeric prediction plots case-match
```{r Infarct_measure_hrs_x_method_predictions_case-match, include=FALSE}
#create predicted values for each variable and un-transform them so they are in mm^3

#Infarct_measure_hrs - histology
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Infarct_measure_hrs_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = seq(24, 672), #672 is max for histology
                         Infarct_measurement = "Other histology (ex vivo)",
                         Induction_Halothane = 1, #dummy #picking "no anaesthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Infarct_measure_hrs_predicted_untransformed_case <- predict(lm_case_match, newdata=grid_Infarct_measure_hrs_case)
# generate lower confidence intervals by subtracting standard errors
Infarct_measure_hrs_LCI_untransformed_case <- Infarct_measure_hrs_predicted_untransformed_case-predict(lm_case_match, newdata=grid_Infarct_measure_hrs_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Infarct_measure_hrs_UCI_untransformed_case<-Infarct_measure_hrs_predicted_untransformed_case+predict(lm_case_match, newdata=grid_Infarct_measure_hrs_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Infarct_measure_hrs_predicted_case <- data.frame(grid_Infarct_measure_hrs_case$Infarct_measure_hrs, 
                                       10^(Infarct_measure_hrs_predicted_untransformed_case), 
                                       10^(Infarct_measure_hrs_LCI_untransformed_case), 
                                       10^(Infarct_measure_hrs_UCI_untransformed_case))

# Change the column names
colnames(df_Infarct_measure_hrs_predicted_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
Infarct_measure_hrs.correct_case<- df_Infarct_measure_hrs_predicted_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 and all others as % change from this
df_Infarct_measure_hrs_predicted_case$Infarct_volume<-df_Infarct_measure_hrs_predicted_case$Infarct_volume-Infarct_measure_hrs.correct_case
df_Infarct_measure_hrs_predicted_case$LCI<-df_Infarct_measure_hrs_predicted_case$LCI-Infarct_measure_hrs.correct_case
df_Infarct_measure_hrs_predicted_case$UCI<-df_Infarct_measure_hrs_predicted_case$UCI-Infarct_measure_hrs.correct_case



#Infarct_measure_hrs x TTC predictions - max out at 168 hours
#make grid of baselines + variable options, selecting the "baseline" for all except variable of interest
grid_Infarct_measure_hrs_ttc_case<-expand.grid(Comorbidity = "None",
                         ET_brain_depth = "Cortical",
                         MCA_occluded = "Yes", 
                         ET_dose_pmol_cat = "100-150pmol", #main model uses 200, this level had most complete cases though
                         ET_administration_mins_cat = "5+mins", #full model uses 6, pick 5+ to match
                         # ET_administration_sites_cat = "Single site", #1 is both median and mode
                         Infarct_measure_hrs = seq(24, 168), #168 is max for ttc
                         Infarct_measurement = "TTC (ex vivo)",
                         Induction_Halothane = 1, #dummy #picking "no aneasthetic" as baseline, so all dummys to 0
                         # Induction_Isoflurane = 0, #dummy
                         # Induction_Ketamine = 0, #dummy
                         Induction_Nitrous_oxide = 0, #dummy
                         # Induction_Sevoflurane = 0, #dummy
                         Induction_Sodium_Pentobarbital = 0, #dummy
                         # Induction_Tribromoethanol = 0, #dummy
                         # Induction_Xylazine = 0, #dummy
                         Induction_other_anaesthetics = 0, #dummy
                         Induction_A_Not_reported = 0, #dummy
                         weights = 8) #average n of animals = ~8
                         
# generate predicted values from our model
Infarct_measure_hrs_predicted_untransformed_ttc_case <- predict(lm_case_match, newdata=grid_Infarct_measure_hrs_ttc_case)
# generate lower confidence intervals by subtracting standard errors
Infarct_measure_hrs_LCI_untransformed_ttc_case <- Infarct_measure_hrs_predicted_untransformed_ttc_case-predict(lm_case_match, newdata=grid_Infarct_measure_hrs_ttc_case, se=T)$se.fit
# generate upper confidence intervals by adding standard errors
Infarct_measure_hrs_UCI_untransformed_ttc_case<-Infarct_measure_hrs_predicted_untransformed_ttc_case+predict(lm_case_match, newdata=grid_Infarct_measure_hrs_ttc_case, se=T)$se.fit
# generate new dataframe for these untransformed predicted values, and transform them
df_Infarct_measure_hrs_predicted_ttc_case <- data.frame(grid_Infarct_measure_hrs_ttc_case$Infarct_measure_hrs, 
                                       10^(Infarct_measure_hrs_predicted_untransformed_ttc_case), 
                                       10^(Infarct_measure_hrs_LCI_untransformed_ttc_case), 
                                       10^(Infarct_measure_hrs_UCI_untransformed_ttc_case))

# Change the column names
colnames(df_Infarct_measure_hrs_predicted_ttc_case)<-c("Variable", "Infarct_volume", "LCI", "UCI")
#select the baseline variable infarct volume
# Infarct_measure_hrs.correct_ttc_case<- df_Infarct_measure_hrs_predicted_ttc_case[1,2] # Select row 1, column 2, which should be the infarct vol of baseline
#minus it from all others to normalise baseline variable to 0 (of other histology, not ttc)
df_Infarct_measure_hrs_predicted_ttc_case$Infarct_volume<-df_Infarct_measure_hrs_predicted_ttc_case$Infarct_volume-Infarct_measure_hrs.correct_case
df_Infarct_measure_hrs_predicted_ttc_case$LCI<-df_Infarct_measure_hrs_predicted_ttc_case$LCI-Infarct_measure_hrs.correct_case
df_Infarct_measure_hrs_predicted_ttc_case$UCI<-df_Infarct_measure_hrs_predicted_ttc_case$UCI-Infarct_measure_hrs.correct_case


```

```{r Dataframe_Infarct_measure_hrs_x_method_case-match, include=FALSE}

#make new dataframes for edits
df_Infarct_measure_hrs_predicted_case_2 <- df_Infarct_measure_hrs_predicted_case
df_Infarct_measure_hrs_predicted_ttc_case_2 <- df_Infarct_measure_hrs_predicted_ttc_case

#add a category column to separate them
df_Infarct_measure_hrs_predicted_case_2$Category<-rep("Other histology", nrow(df_Infarct_measure_hrs_predicted_case_2)) 
df_Infarct_measure_hrs_predicted_ttc_case_2$Category<-rep("TTC", nrow(df_Infarct_measure_hrs_predicted_ttc_case_2)) 

#combine into one data frame
df_Infarct_measure_hrs_x_method_predicted_case <- rbind(df_Infarct_measure_hrs_predicted_case_2,
                                                   df_Infarct_measure_hrs_predicted_ttc_case_2)

```

```{r Infarct_measure_hrs_x_method_predicted_plot_case-match, include=FALSE, eval=FALSE}

mako_colours_case <- c(viridis(6, option = "mako")[4:5])

pdf("Predict_cont_Infarct_measure_time_x_method_case_4.pdf", width = 10, height = 5)
ggplot(df_Infarct_measure_hrs_x_method_predicted_case, aes(x=(Variable/24), y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                                                           fill = Category)) + #divide by 24 to turn hrs into days
  geom_ribbon(aes(ymax=UCI*Expected_brain_vol_mm3_percentage_conversion, 
                  ymin=LCI*Expected_brain_vol_mm3_percentage_conversion), 
              alpha=0.8) +
  scale_fill_manual(values = mako_colours_case , name = "Measurement method") + #colours the ribbons
  #scale_colour_manual(values = mako_colours_case , name = "Measurement method") + #makes coloured lines on the outside of ribbons (plus colour = category in ggplot)
  geom_line(color="#292829", size=1) +
  geom_hline(yintercept=0, lty=2, size =1) +
  scale_y_continuous(breaks=seq(-300,1000,by=100)) +
  scale_x_continuous(limits = c(0,91), #keep in mind this can "clip" the data!
    breaks=seq(0,96,by=7)) + #set x axis tick marks
  theme_classic() +
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Label Axis   
  labs(x = "Time infarct was measured (days post-stroke)",
       legend = "Measurement method",
       y = "% of average infarct volume")+
  #Make axis lines thicker   
  theme(axis.line = element_line(size=1)) +
  #Adjust axis font sizes and font colour   
  theme(axis.title = element_text(size = 13), 
        axis.text.x = element_text(size=13, color="black"), 
        axis.text.y = element_text(size=13, color="black")) +  
  #Make ticks black   
  theme(axis.ticks=element_line(color="black", lineend = "square")) 
dev.off()

```


## Combined prediction plots with both full model and case-match
```{r Combined_anaesthetic_prediction_dataframes, include=FALSE}
#make new dataframes for edits
df_Anaesthetics_predicted_2 <- df_Anaesthetics_predicted
df_Anaesthetics_predicted_case_2 <- df_Anaesthetics_predicted_case

#add empty rows in for missing anaesthetics in case-match
#create new rows of these factor levels and populate them
df_Anaesthetics_predicted_case_2 <- rbind(df_Anaesthetics_predicted_case, data.frame(Variable = c("Isoflurane", 
                                                                                                  "Ketamine", 
                                                                                                  "Sevoflurane", 
                                                                                                  #"Tribromoethanol", 
                                                                                                  "Xylazine"), 
                                                                                   Infarct_volume = NA,
                                                                                   LCI = NA,
                                                                                   UCI = NA))
#categorise the two sets of predictions
df_Anaesthetics_predicted_case_2$Category<-rep("Case-match", nrow(df_Anaesthetics_predicted_case_2)) #make a column called "Category" for each dataframe
df_Anaesthetics_predicted_2$Category<-rep("Full model", nrow(df_Anaesthetics_predicted_2)) #make a column called "Category" for each dataframe

#combine the dataframes
df_Anaesthetics_predicted_combined <- rbind(df_Anaesthetics_predicted_2,
                                            df_Anaesthetics_predicted_case_2)

#re-order factor levels
df_Anaesthetics_predicted_combined$Variable <- factor(df_Anaesthetics_predicted_combined$Variable, levels =
                                                                       c("No anaesthetic (conscious)",
                                                                         "Halothane",
                                                                         "Isoflurane",
                                                                         "Ketamine",
                                                                         "Nitrous oxide",
                                                                         "Sevoflurane",
                                                                         "Sodium pentobarbital",
                                                                         #"Tribromoethanol",
                                                                         "Xylazine",
                                                                         "Other anaesthetics",
                                                                         "Anaesthetic not reported"))

df_Anaesthetics_predicted_combined$Category <- factor(df_Anaesthetics_predicted_combined$Category, levels = 
                                                        c("Full model", "Case-match"))
```

```{r Combined_anaesthetics_predicted_plot, include=FALSE, eval=FALSE}

#pick some colours
my_colors <- c(mako(5)[2], mako(5)[4])

pdf("Combined_Predict_anaesthetics_4.pdf", width = 7, height = 8)
ggplot(data=df_Anaesthetics_predicted_combined, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, colour = Category,
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  geom_pointrange(position=position_dodge(width=0.7)) + #points with error ranges style graph
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at y=0
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom - only reverses within faceted groups
  coord_flip() + # flip coordinates (puts labels on y axis)
  scale_colour_manual(values = my_colors) +
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.5, cex=1, position=position_dodge(width=0.7)) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(limits = c(-150, 625), #note this can clip data!! Using to match scale to conscious graph
                     breaks=seq(-150,700,by=50)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom"
        )
dev.off()

```

```{r Combined_ET_depth_dataframes, include=FALSE}
#new dataframes for edits
df_ET_brain_depth_predicted_2 <- df_ET_brain_depth_predicted
df_ET_brain_depth_predicted_case_2 <- df_ET_brain_depth_predicted_case
#add missing factor levels into case-match
df_ET_brain_depth_predicted_case_2 <- rbind(df_ET_brain_depth_predicted_case_2, data.frame(Variable = "Both cortical and subcortical", 
                                                                                   Infarct_volume = NA,
                                                                                   LCI = NA,
                                                                                   UCI = NA))
#categorise the two sets of predictions
df_ET_brain_depth_predicted_2$Category<-rep("Full model", nrow(df_ET_brain_depth_predicted_2)) #make a column called "Category" for each dataframe
df_ET_brain_depth_predicted_case_2$Category<-rep("Case-match", nrow(df_ET_brain_depth_predicted_case_2)) #make a column called "Category" for each dataframe

#combine the dataframes
df_ET_brain_depth_predicted_combined <- rbind(df_ET_brain_depth_predicted_2,
                                            df_ET_brain_depth_predicted_case_2)

#re-order factor levels
df_ET_brain_depth_predicted_combined$Variable <- factor(df_ET_brain_depth_predicted_combined$Variable, levels =
                                                                       c("Cortical",
                                                                         "Subcortical",
                                                                         "Both cortical and subcortical"))
df_ET_brain_depth_predicted_combined$Category <- factor(df_ET_brain_depth_predicted_combined$Category, levels = 
                                                        c("Full model", "Case-match"))

```

```{r Combined_ET_depth_predicted_plot, include=FALSE, eval=FALSE}

#pick some colours
my_colors <- c(mako(5)[2], mako(5)[4])

pdf("Combined_Predict_ET_depth_3.pdf", width = 7, height = 3)
ggplot(data=df_ET_brain_depth_predicted_combined, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, colour = Category,
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  geom_pointrange(position=position_dodge(width=0.7)) + #points with error ranges style graph
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at y=0
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom - only reverses within faceted groups
  coord_flip() + # flip coordinates (puts labels on y axis)
  scale_colour_manual(values = my_colors) +
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.5, cex=1, position=position_dodge(width=0.7)) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-150,700,by=25)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom"
        )
dev.off()

```

```{r Combined_MCA_occluded_dataframes, include=FALSE}
#new dataframes for edits
df_MCA_occluded_predicted_2 <- df_MCA_occluded_predicted
df_MCA_occluded_predicted_case_2 <- df_MCA_occluded_predicted_case
#add missing factor levels into case-match
df_MCA_occluded_predicted_case_2 <- rbind(df_MCA_occluded_predicted_case_2, data.frame(Variable = "Occlusion location not reported", 
                                                                                   Infarct_volume = NA,
                                                                                   LCI = NA,
                                                                                   UCI = NA))
#categorise the two sets of predictions
df_MCA_occluded_predicted_2$Category<-rep("Full model", nrow(df_MCA_occluded_predicted_2)) #make a column called "Category" for each dataframe
df_MCA_occluded_predicted_case_2$Category<-rep("Case-match", nrow(df_MCA_occluded_predicted_case_2)) #make a column called "Category" for each dataframe

#combine the dataframes
df_MCA_occluded_predicted_combined <- rbind(df_MCA_occluded_predicted_2,
                                            df_MCA_occluded_predicted_case_2)

#re-order factor levels
df_MCA_occluded_predicted_combined$Variable <- factor(df_MCA_occluded_predicted_combined$Variable, levels =
                                                                       c("MCA occluded",
                                                                         "MCA not occluded",
                                                                         "Occlusion location not reported"))
df_MCA_occluded_predicted_combined$Category <- factor(df_MCA_occluded_predicted_combined$Category, levels = 
                                                        c("Full model", "Case-match"))

```

```{r Combined_MCA_occluded_predicted_plot, include=FALSE, eval=FALSE}

#pick some colours
my_colors <- c(mako(5)[2], mako(5)[4])

pdf("Combined_Predict_MCA_occluded_3.pdf", width = 7, height = 3)
ggplot(data=df_MCA_occluded_predicted_combined, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, colour = Category,
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  geom_pointrange(position=position_dodge(width=0.7)) + #points with error ranges style graph
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at y=0
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom - only reverses within faceted groups
  coord_flip() + # flip coordinates (puts labels on y axis)
  scale_colour_manual(values = my_colors) +
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.5, cex=1, position=position_dodge(width=0.7)) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-150,700,by=20)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom"
        )
dev.off()

```

```{r Combined_Infarct_measurement_dataframes, include=FALSE}
#new dataframes for edits
df_Infarct_measurement_predicted_2 <- df_Infarct_measurement_predicted
df_Infarct_measurement_predicted_case_2 <- df_Infarct_measurement_predicted_case
#add missing factor levels into case-match
df_Infarct_measurement_predicted_case_2 <- rbind(df_Infarct_measurement_predicted_case_2, data.frame(Variable = "MRI", 
                                                                                   Infarct_volume = NA,
                                                                                   LCI = NA,
                                                                                   UCI = NA))
#categorise the two sets of predictions
df_Infarct_measurement_predicted_2$Category<-rep("Full model", nrow(df_Infarct_measurement_predicted_2)) #make a column called "Category" for each dataframe
df_Infarct_measurement_predicted_case_2$Category<-rep("Case-match", nrow(df_Infarct_measurement_predicted_case_2)) #make a column called "Category" for each dataframe

#combine the dataframes
df_Infarct_measurement_predicted_combined <- rbind(df_Infarct_measurement_predicted_2,
                                            df_Infarct_measurement_predicted_case_2)

#re-order factor levels
df_Infarct_measurement_predicted_combined$Variable <- factor(df_Infarct_measurement_predicted_combined$Variable, levels =
                                                                       c("Other histology",
                                                                         "TTC",
                                                                         "MRI"))
df_Infarct_measurement_predicted_combined$Category <- factor(df_Infarct_measurement_predicted_combined$Category, levels = 
                                                        c("Full model", "Case-match"))

```

```{r Combined_Infarct_measurement_predicted_plot, include=FALSE, eval=FALSE}

#pick some colours
my_colors <- c(mako(5)[2], mako(5)[4])

pdf("Combined_Predict_Infarct_measurement_3.pdf", width = 6, height = 3)
ggplot(data=df_Infarct_measurement_predicted_combined, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, colour = Category,
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  geom_pointrange(position=position_dodge(width=0.7)) + #points with error ranges style graph
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at y=0
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom - only reverses within faceted groups
  coord_flip() + # flip coordinates (puts labels on y axis)
  scale_colour_manual(values = my_colors) +
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.5, cex=1, position=position_dodge(width=0.7)) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-200,1000,by=50)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom"
        )
dev.off()

```

```{r Combined_Comorbidity_dataframes, include=FALSE}
#new dataframes for edits
df_Comorbidity_predicted_2 <- df_Comorbidity_predicted
df_Comorbidity_predicted_case_2 <- df_Comorbidity_predicted_case
#add missing factor levels into dataframes
df_Comorbidity_predicted_2 <- rbind(df_Comorbidity_predicted_2, data.frame(Variable = "Aged + Hypertension combined", 
                                                                                   Infarct_volume = NA,
                                                                                   LCI = NA,
                                                                                   UCI = NA))
df_Comorbidity_predicted_case_2 <- rbind(df_Comorbidity_predicted_case_2, data.frame(Variable = c("Aged","Hypertension"), 
                                                                                   Infarct_volume = NA,
                                                                                   LCI = NA,
                                                                                   UCI = NA))
#categorise the two sets of predictions
df_Comorbidity_predicted_2$Category<-rep("Full model", nrow(df_Comorbidity_predicted_2)) #make a column called "Category" for each dataframe
df_Comorbidity_predicted_case_2$Category<-rep("Case-match", nrow(df_Comorbidity_predicted_case_2)) #make a column called "Category" for each dataframe

#combine the dataframes
df_Comorbidity_predicted_combined <- rbind(df_Comorbidity_predicted_2,
                                            df_Comorbidity_predicted_case_2)

#re-order factor levels
df_Comorbidity_predicted_combined$Variable <- factor(df_Comorbidity_predicted_combined$Variable, levels =
                                                                       c("No Comorbidities",
                                                                         "Aged",
                                                                         "Hypertension",
                                                                         "Aged + Hypertension combined"))
df_Comorbidity_predicted_combined$Category <- factor(df_Comorbidity_predicted_combined$Category, levels = 
                                                        c("Full model", "Case-match"))

```

```{r Combined_Comorbidity_predicted_plot, include=FALSE, eval=FALSE}

#pick some colours
my_colors <- c(mako(5)[2], mako(5)[4])

pdf("Combined_Predict_Comorbidity_3.pdf", width = 7, height = 3)
ggplot(data=df_Comorbidity_predicted_combined, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, colour = Category,
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  geom_pointrange(position=position_dodge(width=0.7)) + #points with error ranges style graph
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at y=0
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom - only reverses within faceted groups
  coord_flip() + # flip coordinates (puts labels on y axis)
  scale_colour_manual(values = my_colors) +
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.5, cex=1, position=position_dodge(width=0.7)) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(breaks=seq(-200,200,by=20)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom"
        )
dev.off()

```

```{r Combined_Conscious_dataframes, include=FALSE}
#new dataframes for edits
df_Conscious_predicted_2 <- df_Conscious_predicted
df_Conscious_predicted_case_2 <- df_Conscious_predicted_case

#categorise the two sets of predictions
df_Conscious_predicted_2$Category<-rep("Full model", nrow(df_Conscious_predicted_2)) #make a column called "Category" for each dataframe
df_Conscious_predicted_case_2$Category<-rep("Case-match", nrow(df_Conscious_predicted_case_2)) #make a column called "Category" for each dataframe

#combine the dataframes
df_Conscious_predicted_combined <- rbind(df_Conscious_predicted_2,
                                            df_Conscious_predicted_case_2)

#re-order factor levels
df_Conscious_predicted_combined$Category <- factor(df_Conscious_predicted_combined$Category, levels = 
                                                        c("Full model", "Case-match"))

```

```{r Combined_Conscious_predicted_plot, include=FALSE, eval=FALSE}

#pick some colours
my_colors <- c(mako(5)[2], mako(5)[4])

pdf("Combined_Predict_Conscious_2.pdf", width = 7, height = 2.5)
ggplot(data=df_Conscious_predicted_combined, aes(x=Variable, y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, colour = Category,
                             ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                             ymax=UCI*Expected_brain_vol_mm3_percentage_conversion)) + #add colour = Category to aes() for colouring the groups
  geom_pointrange(position=position_dodge(width=0.7)) + #points with error ranges style graph
  geom_hline(yintercept=0, lty=2, size =1) +  # add a dotted line at y=0
  scale_x_discrete(limits=rev) + #flip the x axis (about to become y axis) so it reads top to bottom - only reverses within faceted groups
  coord_flip() + # flip coordinates (puts labels on y axis)
  scale_colour_manual(values = my_colors) +
  geom_errorbar(aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                    ymax=UCI*Expected_brain_vol_mm3_percentage_conversion), 
                width=0.5, cex=1, position=position_dodge(width=0.7)) + # Makes whiskers on the range (more aesthetically pleasing)
  xlab("") + #remove main x label
  ylab("% of average infarct volume") +
  scale_y_continuous(limits = c(-150, 625), #note this can clip data!! Using to match scale to anaesthetics graph
                     breaks=seq(-200,800,by=50)) + # make two axes with brain volume as percentage
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom"
        )
dev.off()

```

## Combined numeric + categorical
```{r Combined_ET_administration_mins_dataframes, include=FALSE}

#new dataframes for edits
df_ET_administration_mins_predicted_2 <- df_ET_administration_mins_predicted
df_ET_administration_mins_cat_predicted_case_2 <- df_ET_administration_mins_cat_predicted_case

#make numeric variable for plotting on graph - use midpoint of each range, and "35" for "not reported" so it sits outside the rest of the graph
df_ET_administration_mins_cat_predicted_case_2$Variable_numeric <- rep(c(2.05, 3.75, 17.5, 35), 
                                                                       length = nrow(df_ET_administration_mins_cat_predicted_case_2))
#create x minimum value for left edge of rectangles (start of each range)
df_ET_administration_mins_cat_predicted_case_2$xmin <- rep(c(1.6, 2.5, 5, 35), 
                                                                       length = nrow(df_ET_administration_mins_cat_predicted_case_2))
#create x maximum value for right edge of rectangles (end of each range)
df_ET_administration_mins_cat_predicted_case_2$xmax <- rep(c(2.5, 5, 30, 35), 
                                                                       length = nrow(df_ET_administration_mins_cat_predicted_case_2))

#categorise the two sets of predictions
df_ET_administration_mins_predicted_2$Category<-rep("Full model", nrow(df_ET_administration_mins_predicted_2)) #make a column called "Category" for each dataframe
df_ET_administration_mins_cat_predicted_case_2$Category<-rep("Case-match", nrow(df_ET_administration_mins_cat_predicted_case_2)) #make a column called "Category" for each dataframe

```

```{r Combined_ET_administration_mins_predicted_plot, include=FALSE, eval=FALSE}

pdf("Combined_predict_ETduration_4.pdf", width = 7, height = 5)

ggplot() +
  geom_ribbon(data = df_ET_administration_mins_predicted_2,
              aes(x = Variable, y = Infarct_volume*Expected_brain_vol_mm3_percentage_conversion,
                  ymax = UCI*Expected_brain_vol_mm3_percentage_conversion, 
                  ymin = LCI*Expected_brain_vol_mm3_percentage_conversion), 
              alpha = 0.9,
              fill = mako(5)[2]) + # make the coloured ribbon for full model prediction (numeric)
  geom_line(data = df_ET_administration_mins_predicted_2,
              aes(x = Variable, y = Infarct_volume*Expected_brain_vol_mm3_percentage_conversion,
                  ymax = UCI*Expected_brain_vol_mm3_percentage_conversion, 
                  ymin = LCI*Expected_brain_vol_mm3_percentage_conversion),
            color="#292829", size=1) + # add a line for the full model prediction (numeric)
  geom_pointrange(aes(x = df_ET_administration_mins_cat_predicted_case_2[4,5], # add points for the case-match "not reported" only
                      y = (df_ET_administration_mins_cat_predicted_case_2[4,2])*Expected_brain_vol_mm3_percentage_conversion, # infarct volume
                      ymin = (df_ET_administration_mins_cat_predicted_case_2[4,3])*Expected_brain_vol_mm3_percentage_conversion, # LCI for "not reported"
                      ymax = (df_ET_administration_mins_cat_predicted_case_2[4,4])*Expected_brain_vol_mm3_percentage_conversion), #UCI for "not reported"
                  colour=mako(5)[4]) + 
  geom_errorbar(aes(x = df_ET_administration_mins_cat_predicted_case_2[4,5], # add error whiskers for the case-match "not reported"
                      y = (df_ET_administration_mins_cat_predicted_case_2[4,2])*Expected_brain_vol_mm3_percentage_conversion, # infarct volume
                      ymin = (df_ET_administration_mins_cat_predicted_case_2[4,3])*Expected_brain_vol_mm3_percentage_conversion, # LCI for "not reported"
                      ymax = (df_ET_administration_mins_cat_predicted_case_2[4,4])*Expected_brain_vol_mm3_percentage_conversion), #UCI for "not reported"
                colour=mako(5)[4], 
                # width=60,
                cex=1) + # add error whiskers for the case-match categorical predictions, change width based on scale
  geom_rect(data = df_ET_administration_mins_cat_predicted_case_2, #plot rectangles for the case-match ranges
            aes(ymin=LCI*Expected_brain_vol_mm3_percentage_conversion, 
                ymax=UCI*Expected_brain_vol_mm3_percentage_conversion, 
                xmin=xmin, 
                xmax=xmax),
            fill = mako(5)[4], alpha = 0.3) +
  geom_segment(data = df_ET_administration_mins_cat_predicted_case_2, #plot line for estimate of categorical infarct volumes
               aes(y=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                   yend=Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                   x=xmin, 
                   xend=xmax),
               size=1) +
  geom_hline(yintercept=0, lty=2, size =1) + #add line at 0
  scale_y_continuous(breaks=seq(-200,2000,by=20)) + 
  scale_x_continuous(limits = c(-0,36), #move the graph to make space for "not reported" label, careful, this will "clip" data!!
                     breaks = seq(0, 30, by=5)) + #place breaks on the x axis instead of automatic ones to cover time
  annotate("text", x = 34, y = 35, label = "Not reported", angle = 90) + #add a label to the NR categorical + rotate 90 degrees
  theme_classic() +
  #Label Axes   
  labs(x = "Duration of Endothelin-1 application (minutes)",
       y = "% of average infarct volume")

dev.off()

```

```{r Combined_ET_dose_dataframes, include=FALSE}

#new dataframes for edits
df_ET_dose_pmol_predicted_2 <- df_ET_dose_pmol_predicted
df_ET_dose_pmol_cat_predicted_case_2 <- df_ET_dose_pmol_cat_predicted_case
#third dataframe with information for plotting rectangles


#make numeric variable for plotting on graph - use midpoint of each range, and "6000" for "not reported" so it sits outside the rest of the graph
df_ET_dose_pmol_cat_predicted_case_2$Variable_numeric <- rep(c(25, 75, 125, 175, 2500, 6000), 
                                                                       length = nrow(df_ET_dose_pmol_cat_predicted_case_2))
#create x minimum value for left edge of rectangles (start of each range)
df_ET_dose_pmol_cat_predicted_case_2$xmin <- rep(c(0.08, 50, 100, 150, 200, 6000), 
                                                                       length = nrow(df_ET_dose_pmol_cat_predicted_case_2))
#create x maximum value for right edge of rectangles (end of each range)
df_ET_dose_pmol_cat_predicted_case_2$xmax <- rep(c(50, 100, 150, 200, 4790, 6000), 
                                                                       length = nrow(df_ET_dose_pmol_cat_predicted_case_2))


#categorise the two sets of predictions
df_ET_dose_pmol_predicted_2$Category<-rep("Full model", nrow(df_ET_dose_pmol_predicted_2)) #make a column called "Category" for each dataframe
df_ET_dose_pmol_cat_predicted_case_2$Category<-rep("Case-match", nrow(df_ET_dose_pmol_cat_predicted_case_2)) #make a column called "Category" for each dataframe

```

```{r Combined_ET_dose_predicted_plot, include=FALSE, eval=FALSE}

pdf("Combined_predict_ET_dose_pmol_4.pdf", width = 7, height = 5)

ggplot() +
  geom_ribbon(data = df_ET_dose_pmol_predicted_2,
              aes(x = Variable, 
                  y = Infarct_volume*Expected_brain_vol_mm3_percentage_conversion,
                  ymax = UCI*Expected_brain_vol_mm3_percentage_conversion, 
                  ymin = LCI*Expected_brain_vol_mm3_percentage_conversion), 
              alpha=0.9,
              fill=mako(5)[2]) + # make the coloured ribbon for full model prediction (numeric)
  geom_line(data = df_ET_dose_pmol_predicted_2,
              aes(x = Variable, 
                  y = Infarct_volume*Expected_brain_vol_mm3_percentage_conversion,
                  ymax = UCI*Expected_brain_vol_mm3_percentage_conversion, 
                  ymin = LCI*Expected_brain_vol_mm3_percentage_conversion),
            color = "#292829", size = 1) + # add a line for the full model prediction (numeric)
  geom_pointrange(aes(x = df_ET_dose_pmol_cat_predicted_case_2[6,5], # add points for the case-match "not reported" only
                      y = (df_ET_dose_pmol_cat_predicted_case_2[6,2])*Expected_brain_vol_mm3_percentage_conversion, # infarct volume
                      ymin = (df_ET_dose_pmol_cat_predicted_case_2[6,3])*Expected_brain_vol_mm3_percentage_conversion, # LCI for "not reported"
                      ymax = (df_ET_dose_pmol_cat_predicted_case_2[6,4])*Expected_brain_vol_mm3_percentage_conversion), #UCI for "not reported"
                  colour=mako(5)[4]) + 
  geom_errorbar(aes(x = df_ET_dose_pmol_cat_predicted_case_2[6,5], # add error whiskers for the case-match "not reported" only
                      y = (df_ET_dose_pmol_cat_predicted_case_2[6,2])*Expected_brain_vol_mm3_percentage_conversion, # infarct volume
                       ymin = (df_ET_dose_pmol_cat_predicted_case_2[6,3])*Expected_brain_vol_mm3_percentage_conversion, # LCI for "not reported"
                      ymax = (df_ET_dose_pmol_cat_predicted_case_2[6,4])*Expected_brain_vol_mm3_percentage_conversion),  #UCI for "not reported"
                # width=60,
                colour=mako(5)[4],
                cex=1) + # add error whiskers for the case-match categorical predictions, change width based on scale
  geom_rect(data = df_ET_dose_pmol_cat_predicted_case_2, #plot rectangles for the case-match ranges
            aes(ymin = LCI*Expected_brain_vol_mm3_percentage_conversion, 
                ymax = UCI*Expected_brain_vol_mm3_percentage_conversion, 
                xmin = xmin, 
                xmax = xmax),
            fill = mako(5)[4], alpha = 0.3) +
  geom_segment(data = df_ET_dose_pmol_cat_predicted_case_2, #plot line for estimate of categorical infarct volumes
               aes(y = Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                   yend = Infarct_volume*Expected_brain_vol_mm3_percentage_conversion, 
                   x = xmin, 
                   xend = xmax),
               size = 1) +
  geom_hline(yintercept = 0, lty = 2, size = 1) + #add line at 0
  scale_y_continuous(breaks=seq(-100,200,by=25)) + 
  scale_x_continuous(limits = c(-500,6100), #move the graph to make space for "not reported" label, keep in mind these limits will "clip" the data!
                     breaks = c(c(0, 50, 200), seq(500,5000, by=500)), #place breaks on the x axis instead of automatic ones which don't do well with the sqrt transform
                     trans = "sqrt") + # do a square root transform to better see the very small categories

  annotate("text", x = 5580, y = 45, label = "Not reported", angle = 90) + #add a label to the NR categorical + rotate 90 degrees
  theme_classic() +
  #Label Axes   
  labs(x = "Dose of Endothelin-1 (pmol)",
       y = "% of average infarct volume")

dev.off()

```


# Post hocs for case-matched analysis
```{r Comorbidity_post_hoc_case, include=FALSE, eval=FALSE}

Comorbidity_LM_case = ref_grid(lm_case_match, 
  non.nuisance = "Comorbidity")
#Posthoc/Planned contrasts 
Comorbidity_raw_posthoc_case <- lsmeans(
  Comorbidity_LM_case, pairwise ~ Comorbidity, adjust="tukey") 

Comorbidity_posthoc_case<-summary(Comorbidity_raw_posthoc_case) 

Comorbidity_p_value_case<-data.frame(cbind(
  Comorbidity_posthoc_case$contrasts[,-4]))


#View the table in a pretty way
tab_df(Comorbidity_p_value_case, digits = 4,
  file = "Posthoc_Comorbidity_table_case_3.html")  

```

```{r ET_brain_depth_post_hoc_case, include=FALSE, eval=FALSE}

ET_brain_depth_LM_case = ref_grid(lm_case_match, 
  non.nuisance = "ET_brain_depth")
#Posthoc/Planned contrasts 
ET_brain_depth_raw_posthoc_case <- lsmeans(
  ET_brain_depth_LM_case, pairwise ~ ET_brain_depth, adjust="tukey") 

ET_brain_depth_posthoc_case<-summary(ET_brain_depth_raw_posthoc_case) 

ET_brain_depth_p_value_case<-data.frame(cbind(
  ET_brain_depth_posthoc_case$contrasts[,-4]))


#View the table in a pretty way
tab_df(ET_brain_depth_p_value_case, digits = 4,
  file = "Posthoc_ET_brain_depth_table_case_3.html")  

```

```{r MCA_occluded_post_hoc_case, include=FALSE, eval=FALSE}

MCA_occluded_LM_case = ref_grid(lm_case_match, 
  non.nuisance = "MCA_occluded")
#Posthoc/Planned contrasts 
MCA_occluded_raw_posthoc_case <- lsmeans(
  MCA_occluded_LM_case, pairwise ~ MCA_occluded, adjust="tukey") 

MCA_occluded_posthoc_case<-summary(MCA_occluded_raw_posthoc_case) 

MCA_occluded_p_value_case<-data.frame(cbind(
  MCA_occluded_posthoc_case$contrasts[,-4]))


#View the table in a pretty way
tab_df(MCA_occluded_p_value_case, digits = 4,
  file = "Posthoc_MCA_occluded_table_case_3.html")  

```

```{r Infarct_measurement_post_hoc_case, include=FALSE, eval=FALSE}

Infarct_measurement_LM_case = ref_grid(lm_case_match, 
  non.nuisance = "Infarct_measurement")
#Posthoc/Planned contrasts 
Infarct_measurement_raw_posthoc_case <- lsmeans(
  Infarct_measurement_LM_case, pairwise ~ Infarct_measurement, adjust="tukey") 

Infarct_measurement_posthoc_case<-summary(Infarct_measurement_raw_posthoc_case) 

Infarct_measurement_p_value_case<-data.frame(cbind(
  Infarct_measurement_posthoc_case$contrasts[,-4]))


#View the table in a pretty way
tab_df(Infarct_measurement_p_value_case, digits = 4,
  file = "Posthoc_Infarct_measurement_table_case_3.html")  

```

```{r ET_dose_pmol_cat_post_hoc_cas, include=FALSE, eval=FALSE}
#comparing to baseline, not all to each other
ET_dose_pmol_LM_case = ref_grid(lm_case_match, 
  non.nuisance = "ET_dose_pmol_cat")
#Posthoc/Planned contrasts 
ET_dose_pmol_raw_posthoc_case <- lsmeans(
  ET_dose_pmol_LM_case, pairwise ~ ET_dose_pmol_cat, adjust="none") #take all comparisons and don't yet adjust

ET_dose_pmol_posthoc_case<-summary(ET_dose_pmol_raw_posthoc_case) 

ET_dose_pmol_p_value_case<-data.frame(cbind(
  ET_dose_pmol_posthoc_case$contrasts[,-4]))

#Select just the comparisons we want (comparing only to baseline)
ET_dose_pmol_comparisons<-c(1:5) #only take first 5 comparisons as only want compared to baseline
ET_dose_pmol_ptable<-ET_dose_pmol_p_value_case[ET_dose_pmol_comparisons,]

#Create a column of adjusted p values using the Holm-Sidak method - not tukey as comparing to just base
ET_dose_pmol_ptable$padj<-p.adjust(ET_dose_pmol_ptable$p.value, method="holm") 

#View the table in a pretty way
tab_df(ET_dose_pmol_ptable, digits = 4,
  file = "Posthoc_ET_dose_pmol_table_case_3.html")  

```

```{r ET_administration_mins_cat_cat_post_hoc_case, include=FALSE, eval=FALSE}
#comparing to baseline, not all to each other
ET_administration_mins_cat_LM_case = ref_grid(lm_case_match, 
  non.nuisance = "ET_administration_mins_cat")
#Posthoc/Planned contrasts 
ET_administration_mins_cat_raw_posthoc_case <- lsmeans(
  ET_administration_mins_cat_LM_case, pairwise ~ ET_administration_mins_cat, adjust="none") #take all comparisons and don't yet adjust

ET_administration_mins_cat_posthoc_case<-summary(ET_administration_mins_cat_raw_posthoc_case) 

ET_administration_mins_cat_p_value_case<-data.frame(cbind(
  ET_administration_mins_cat_posthoc_case$contrasts[,-4]))

#Select just the comparisons we want (comparing only to baseline)
ET_administration_mins_cat_comparisons<-c(1:3) #only take first 3 comparisons as only want compared to baseline
ET_administration_mins_cat_ptable<-ET_administration_mins_cat_p_value_case[ET_administration_mins_cat_comparisons,]

#Create a column of adjusted p values using the Holm-Sidak method - not tukey as comparing to just base
ET_administration_mins_cat_ptable$padj<-p.adjust(ET_administration_mins_cat_ptable$p.value, method="holm") 

#View the table in a pretty way
tab_df(ET_administration_mins_cat_ptable, digits = 4,
  file = "Posthoc_ET_administration_mins_cat_table_case_3.html")  

```


# Summary data for thesis tables
```{r Counting_publications, include=FALSE, eval=FALSE}

n_distinct(dfc4$Publication_code) #count publications in full dataset
n_distinct(dfc4_Unique$Publication_code)#count publications in reduced dataset
n_distinct(dfc4_Model_trimmed$Publication_code)#count publications in full model dataset
n_distinct(dfc4_Case_match$Publication_code)#count publications in case-match model dataset


which(dfc4_Model_trimmed$Infarct_measure_hrs>1700)

ggplot(dfc4_Model_trimmed, aes(x=Infarct_measure_hrs, y=Rat_infarct_volume_mm3, group=Infarct_measurement, col=Infarct_measurement)) +
  geom_point() +
  geom_smooth(method=lm)

dfc4_Model_trimmed[35,]
dfc4_Model_trimmed[120,]


dfc4_Model_trimmed[which(cooks.distance(lm_transformed_trimmed)>0.05),]
dfc4_Model_trimmed[which(hatvalues(lm_transformed_trimmed)>0.4),]

summary(as.factor(dfc4_Case_match$ET_administration_mins))
dev.new()
par(mar = c(9, 5, 2, 2),bty = 'n')

table(dfc4_Model_trimmed$Year,by=dfc4_Model_trimmed$Induction_Halothane)
table(dfc4_Model_trimmed$Year,by=dfc4_Model_trimmed$Induction_A_Not_reported)
table(dfc4_Model_trimmed$Year,by=dfc4_Model_trimmed$Induction_Isoflurane)

dfc4_Model_trimmed[which(dfc4_Model_trimmed$Induction_other_anaesthetics==1),]
dfc4_Case_match[which(dfc4_Case_match$Induction_other_anaesthetics==1),]

```

```{r summary_data_for_tables, include=FALSE, eval=FALSE}

table(dfc4_Model_trimmed$Induction_other_anaesthetics, dfc4_Model_trimmed$Conscious)

table(dfc4_Case_match$Induction_other_anaesthetics, dfc4_Case_match$Conscious)

median(dfc4_Model_trimmed$Induction_time_hrs)

#table((median(dfc4_Model_trimmed$ET_dose_pmol, na.rm=TRUE)), dfc4_Model_trimmed$Conscious)
median(dfc4_Model_trimmed$ET_dose_pmol, na.rm=TRUE)

#calculate medians and ranges for continuous variables
#dose
medians_model_dose <- dfc4_Model_trimmed %>%
    group_by(Conscious) %>%
    summarize(med = median(ET_dose_pmol, na.rm = TRUE),
              min = min(ET_dose_pmol, na.rm = TRUE),
              max = max(ET_dose_pmol, na.rm = TRUE))
medians_case_dose <- dfc4_Case_match %>%
    group_by(Conscious) %>%
    summarize(med = median(ET_dose_pmol, na.rm = TRUE),
              min = min(ET_dose_pmol, na.rm = TRUE),
              max = max(ET_dose_pmol, na.rm = TRUE))
#time before admin
medians_model_admintime <- dfc4_Model_trimmed %>%
    group_by(Conscious) %>%
    summarize(med = median(Induction_time_hrs, na.rm = TRUE),
              min = min(Induction_time_hrs, na.rm = TRUE),
              max = max(Induction_time_hrs, na.rm = TRUE))
medians_case_admintime <- dfc4_Case_match %>%
    group_by(Conscious) %>%
    summarize(med = median(Induction_time_hrs, na.rm = TRUE),
              min = min(Induction_time_hrs, na.rm = TRUE),
              max = max(Induction_time_hrs, na.rm = TRUE))
#admin sites
medians_model_adminsites <- dfc4_Model_trimmed %>%
    group_by(Conscious) %>%
    summarize(med = median(ET_administration_sites, na.rm = TRUE),
              min = min(ET_administration_sites, na.rm = TRUE),
              max = max(ET_administration_sites, na.rm = TRUE))
medians_case_adminsites <- dfc4_Case_match %>%
    group_by(Conscious) %>%
    summarize(med = median(ET_administration_sites, na.rm = TRUE),
              min = min(ET_administration_sites, na.rm = TRUE),
              max = max(ET_administration_sites, na.rm = TRUE))
#ET admin duration
medians_model_ETduration <- dfc4_Model_trimmed %>%
    group_by(Conscious) %>%
    summarize(med = median(ET_administration_mins, na.rm = TRUE),
              min = min(ET_administration_mins, na.rm = TRUE),
              max = max(ET_administration_mins, na.rm = TRUE))
medians_case_ETduration <- dfc4_Case_match %>%
    group_by(Conscious) %>%
    summarize(med = median(ET_administration_mins, na.rm = TRUE),
              min = min(ET_administration_mins, na.rm = TRUE),
              max = max(ET_administration_mins, na.rm = TRUE))
#infarct measure time
medians_model_Infmeasure <- dfc4_Model_trimmed %>%
    group_by(Conscious) %>%
    summarize(med = median(Infarct_measure_hrs, na.rm = TRUE),
              min = min(Infarct_measure_hrs, na.rm = TRUE),
              max = max(Infarct_measure_hrs, na.rm = TRUE))
medians_case_Infmeasure <- dfc4_Case_match %>%
    group_by(Conscious) %>%
    summarize(med = median(Infarct_measure_hrs, na.rm = TRUE),
              min = min(Infarct_measure_hrs, na.rm = TRUE),
              max = max(Infarct_measure_hrs, na.rm = TRUE))
#n of control
medians_model_Ncontrol <- dfc4_Model_trimmed %>%
    group_by(Conscious) %>%
    summarize(med = median(N_animals_control, na.rm = TRUE),
              min = min(N_animals_control, na.rm = TRUE),
              max = max(N_animals_control, na.rm = TRUE))
medians_case_Ncontrol <- dfc4_Case_match %>%
    group_by(Conscious) %>%
    summarize(med = median(N_animals_control, na.rm = TRUE),
              min = min(N_animals_control, na.rm = TRUE),
              max = max(N_animals_control, na.rm = TRUE))

view(medians_model_Ncontrol)
view(medians_case_Ncontrol)
```



